define("bitbucket/internal/bbui/mirroring-admin/mirroring-admin","module exports aui jquery lodash bitbucket/internal/impl/request bitbucket/internal/impl/urls ../list-and-detail-view/list-and-detail-view ../widget/widget ./mirror-view/mirror-view ./nav-builder ./request-view/request-view".split(" "),function(w,m,n,x,y,z,A,B,C,p,q,h){function t(c){return g.default.isEmpty(c)||!g.default.any(c,function(c){return!g.default.isEmpty(c)})}function D(c){(c=g.default.get(c,"responseJSON.errors"))?(c=c.map(function(c){return c.message}).join(""),
console.warn("Failed to refresh list. Error: "+c)):console.warn("Failed to refresh list. Unknown error.")}Object.defineProperty(m,"__esModule",{value:!0});var r=babelHelpers.interopRequireDefault(n),c=babelHelpers.interopRequireDefault(x),g=babelHelpers.interopRequireDefault(y),u=babelHelpers.interopRequireDefault(z);babelHelpers.interopRequireDefault(A);var E=babelHelpers.interopRequireDefault(B);n=babelHelpers.interopRequireDefault(C);p=babelHelpers.interopRequireDefault(p);var v=babelHelpers.interopRequireDefault(q);
q=babelHelpers.interopRequireDefault(h);h=function(h){function k(a,d){babelHelpers.classCallCheck(this,k);var b=babelHelpers.possibleConstructorReturn(this,Object.getPrototypeOf(k).call(this,d));b.$el=(0,c.default)(a);b.options.unavailable?b.$el.html(bitbucket.internal.component.mirroringAdmin.main({isEmpty:!0,unavailableText:r.default.escapeHtml(b.options.unavailableMessage)})):(b.navListItems={mirror:{},request:{}},b.options.requests.forEach(function(a){return b.addToNavListItems(a,"request")}),
b.options.mirrors.forEach(function(a){return b.addToNavListItems(a,"mirror")}),b.$el.html(bitbucket.internal.component.mirroringAdmin.main({isEmpty:t(b.navListItems)})),b.listAndDetailView=new E.default(b.$el.find(".mirroring-admin"),{selectHandler:b.itemSelectedHandler,selectFirstOnInit:!0,selectedClass:"selected-item",listContent:bitbucket.internal.component.mirroringAdmin.navbar({mirrors:b.options.mirrors,requests:b.options.requests})}),b.setPolling(),(0,c.default)(document).on("visibilitychange",
function(){b.setPolling(document.hidden?10:1)}));return b}babelHelpers.inherits(k,h);babelHelpers.createClass(k,[{key:"destroy",value:function(){clearTimeout(this.timeout);clearInterval(this.statusInterval);babelHelpers.get(Object.getPrototypeOf(k.prototype),"destroy",this).call(this);this.$el.empty();this.$el=null}},{key:"addToNavListItems",value:function(a,d){this.navListItems[d][a.id]=a}},{key:"setPolling",value:function(){var a=0>=arguments.length||void 0===arguments[0]?1:arguments[0];0>=a?console.warn("Poll multiplier must be greater than 0."):
(this.multiplier=a,clearTimeout(this.timeout),clearInterval(this.statusInterval),this.options.refreshInterval&&(this.timeout=setTimeout(this.refreshList,this.options.refreshInterval*a)),this.checkMirrorStatus(a))}},{key:"checkMirrorStatus",value:function(){var a=this,d=6E4*(0>=arguments.length||void 0===arguments[0]?1:arguments[0]),b=function(){if(a.navListItems.mirror){var b=g.default.map(a.navListItems.mirror,function(b){return c.default.ajax(b.baseUrl+"/status",{method:"HEAD",timeout:d}).then(function(){a.setMirrorStatus(b,
"online");return"online"},function(){a.setMirrorStatus(b,"offline");return"offline"})});a._healthCheck=c.default.when.apply(c.default,babelHelpers.toConsumableArray(b))}};b();this.statusInterval=setInterval(b,d)}},{key:"itemSelectedHandler",value:function(a,d,b){d=a.attr("data-type");a=a.attr("data-id");a={item:this.navListItems[d][a]};if(a.item){this.currentView&&this.currentView.destroy();var c=this.options.views[d];if(c)if(this.currentView=new c(b,a),"request"===d)this.currentView.on("request-resolved",
this.transitionItem);else{if("mirror"===d)this.currentView.on("mirror-removed",this.removeItem)}else throw Error("Invalid view type '"+d+"'");}}},{key:"findBeforeElement",value:function(){var a=this.listAndDetailView.$listView.find(".mirror");return a.length?a[0]:(0,c.default)("#learn-more-mirroring")}},{key:"removeItem",value:function(a){delete this.navListItems[a.type][a.id];a=this.listAndDetailView.$listView.find('[data-id\x3d"'+a.id+'"][data-type\x3d"'+a.type+'"]');this.listAndDetailView.removeItem(a,
".mirror");this.updateEmptyState()}},{key:"removeStaleItems",value:function(a){var c=this;Object.keys(this.navListItems).forEach(function(b){var e=Object.keys(c.navListItems[b]||{}),f=Object.keys(a[b]||{});g.default.difference(e,f).forEach(function(a){c.removeItem({type:b,id:a})})})}},{key:"refreshList",value:function(){var a=this;if(this.refreshPromise)return null;var d=u.default.rest({type:"GET",url:v.default.rest().mirroring().path("requests").params({state:"pending"}).build(),statusCode:{"*":!1}}),
b=u.default.rest({type:"GET",url:v.default.rest().mirroring().path("mirrorServers").build(),statusCode:{"*":!1}}),e={},f=function(b,d,f){e[d]||(e[d]={});e[d][b.id]=b;if(!a.navListItems[d]||!a.navListItems[d][b.id]){var l=!g.default.some(a.navListItems,g.default.size);a.addToNavListItems(b,d);a.listAndDetailView.addItem((0,c.default)(f(babelHelpers.defineProperty({},d,b))),a.findBeforeElement(),l)}};r.default.$(".list-refresh-spinner").spin();var l=c.default.Deferred();this.refreshPromise=c.default.when(d,
b);this.refreshPromise.always(function(){r.default.$(".list-refresh-spinner").spinStop();a.refreshPromise=null;a.options.refreshInterval&&(a.timeout=setTimeout(a.refreshList,a.options.refreshInterval*a.multiplier))}).done(function(b,c){b[0].values.forEach(function(a){f(a,"request",bitbucket.internal.component.mirroringAdmin.mirrorRequestNavItem)});c[0].values.forEach(function(a){f(a,"mirror",bitbucket.internal.component.mirroringAdmin.mirrorNavItem)});a.removeStaleItems(e);a.updateEmptyState();l.resolve()}).fail(function(a){D(a);
l.reject()});return l.promise()}},{key:"setMirrorStatus",value:function(a,c){var b=this.listAndDetailView.$listView.find('[data-id\x3d"'+a.id+'"][data-type\x3d"mirror"]'),e=bitbucket.internal.component.mirroringAdmin.mirrorStatus({status:c}),f=b.find(".status-container");e!==f.html()&&function(){f.append(e);var a=b.find(".status");a.one("transitionend",function(){a.last().removeClass("transitioning");a.first().remove()}).addClass("transitioning")}()}},{key:"updateEmptyState",value:function(){var a=
t(this.navListItems);(0,c.default)(".mirroring-admin").toggleClass("hidden",a);(0,c.default)(".empty-state").toggleClass("hidden",!a)}},{key:"transitionItem",value:function(a){switch(a.resolution){case "accept":this.transformToMirror(a).click();break;case "reject":this.removeItem(a)}this.updateEmptyState()}},{key:"transformToMirror",value:function(a){delete this.navListItems[a.type][a.id];var c=a.responseJSON;this.addToNavListItems(c,"mirror");a=this.listAndDetailView.$listView.find('[data-id\x3d"'+
a.id+'"][data-type\x3d"'+a.type+'"]');a.removeClass("mirror-request");a.attr("data-id",c.id);a.attr("data-type","mirror");this.setMirrorStatus(c,c.enabled?"enabled":"disabled");return a}}]);return k}(n.default);m.default=h;h.defaults={mirrors:[],requests:[],refreshInterval:0,unavailable:!1,unavailableMessage:"",views:{mirror:p.default,request:q.default}};w.exports=m["default"]});