define("bitbucket/internal/v2/feature/pull-request/pull-request-activity","aui jquery lodash bitbucket/util/navbuilder bitbucket/internal/bbui/models/models bitbucket/internal/feature/comments bitbucket/internal/feature/file-content bitbucket/internal/model/commit-range bitbucket/internal/model/file-change bitbucket/internal/model/file-content-modes bitbucket/internal/model/page-state bitbucket/internal/model/path bitbucket/internal/model/path-and-line bitbucket/internal/util/ajax bitbucket/internal/util/client-storage bitbucket/internal/util/codemirror bitbucket/internal/util/events bitbucket/internal/util/scroll bitbucket/internal/util/syntax-highlight bitbucket/internal/widget/paged-scrollable".split(" "),
function(p,h,k,q,v,r,A,w,x,I,n,B,y,C,z,J,f,D,K,t){function E(a){(this.execute?this:p.whenIType(a)).execute(function(){var a=h(".general-comment-form");D.scrollTo(a);a.find("textarea").focus()})}function F(a){a.closest(".diff-comment-activity, .file-comment-activity").remove()}function G(a){var b=a.getPath();return(a=a.getDiff().hunks[0])?0!==a.sourceLine?new y(b,a.sourceLine,"FROM"):new y(b,a.destinationLine,"TO"):new y(b)}function H(a,b){var c=q.currentPullRequest();if(a.commentAnchor&&a.commentAnchor&&
"COMMIT"===a.commentAnchor.diffType)c=c.commit(a.commentAnchor.toHash),b&&(c=c.change(G(b).toString()));else if(a.commentAnchor)var d=b?G(b).toString():new B(a.commentAnchor.path),c=c.diff().change(d);return c.build()}function e(a,b,c,d,g){this._$container=h(a);this.pullRequest=b;this.pullRequestPathComponents={projectKey:n.getProject().getKey(),repoSlug:n.getRepository().getSlug(),pullRequestId:this.pullRequest.getId()};this.fromType=c;this.fromId=d;this.dataLoadedEvent="bitbucket.internal.feature.pullRequestActivity.dataLoaded";
this._$spinner=h('\x3cdiv class\x3d"spinner"/\x3e').insertAfter(this._$container);t.call(this,g.scrollableElement||a,{pageSize:25,dataLoadedEvent:this.dataLoadedEvent,autoLoad:"next",paginationContext:"pull-request-activity"})}h.extend(e.prototype,t.prototype);e.prototype.init=function(a){this.renderedDiffFileContents=[];t.prototype.init.call(this,a);this._inited=!0;this.loadedRange.isEmpty()||(this.renderedDiffFileContents=this.renderedDiffFileContents.concat(e.renderDiffs(this._$container.children(".diff-comment-activity"),
a.diffCommentData,new w({pullRequest:this.pullRequest}))));r.bindContext(this._$container,new r.PullRequestAnchor(this.pullRequestPathComponents));var b=this;this._reviewerSelfHandler=function(c){var a="ADD_SELF"===c.action;b.addNewActivity({currentUser:n.getCurrentUser().toJSON(),pullRequest:c.pullRequest,isNew:!0,activity:{action:"UPDATED",createdDate:new Date,user:c.user,addedReviewers:a?[c.user]:[],removedReviewers:a?[]:[c.user]}})};this._reviewerStatusHandler=function(a){a.oldState===v.ApprovalState.NEEDS_WORK&&
a.newState===v.ApprovalState.UNAPPROVED||b.addNewActivity({currentUser:n.getCurrentUser().toJSON(),pullRequest:a.pullRequest,activity:{action:a.newState===v.ApprovalState.NEEDS_WORK?"REVIEWED":a.newState,createdDate:new Date,user:a.user}})};this._declineHandler=function(a){b.addNewActivity({currentUser:n.getCurrentUser().toJSON(),pullRequest:a.pullRequest,activity:{action:"DECLINED",createdDate:a.pullRequest.updatedDate,user:a.user}})};this._mergeHandler=function(a){b.addNewActivity({currentUser:n.getCurrentUser().toJSON(),
pullRequest:a.pullRequest,activity:{action:"MERGED",createdDate:a.pullRequest.updatedDate,user:a.user,simpleMerge:!0,commit:a.pullRequest.properties.mergeCommit}})};this._reopenedHandler=function(a){b.addNewActivity({currentUser:n.getCurrentUser().toJSON(),pullRequest:a.pullRequest,activity:{action:"REOPENED",createdDate:a.pullRequest.updatedDate,user:a.user}})};h(document).on("click",".diff-comment-activity .breadcrumbs a,.rescope a.commitid,.actions button.delete,.comment-likes-button",function(a){var b,
g=a.target.classList;g.contains("stub")?b="overview.comment.open":g.contains("commitid")?b="overview.commit.open":g.contains("delete")?b="overview.comment.delete.clicked":g.contains("comment-likes-button")&&(b="overview.comment.like.clicked");h(a.target).closest("#pull-request-activity")&&f.trigger("bitbucket.internal.feature.pullRequest."+b)});f.on("bitbucket.internal.feature.pullRequest.reopened",this._reopenedHandler);f.on("bitbucket.internal.feature.pullRequest.declined",this._declineHandler);
f.on("bitbucket.internal.feature.pullRequest.merged",this._mergeHandler);f.on("bitbucket.internal.feature.pullRequest.reviewerStatus.changed",this._reviewerStatusHandler);f.on("bitbucket.internal.feature.comments.lastCommentDeleted",F);f.on("bitbucket.internal.keyboard.shortcuts.pullrequest.addCommentHandler",E);f.on("bitbucket.internal.feature.pullRequest.self.added",this._reviewerSelfHandler);f.on("bitbucket.internal.feature.pullRequest.self.removed",this._reviewerSelfHandler)};e.prototype.reset=
function(){f.off("bitbucket.internal.feature.pullRequest.reopened",this._reopenedHandler);f.off("bitbucket.internal.feature.pullRequest.declined",this._declineHandler);f.off("bitbucket.internal.feature.pullRequest.merged",this._mergeHandler);f.off("bitbucket.internal.feature.pullRequest.reviewerStatus.changed",this._reviewerStatusHandler);f.off("bitbucket.internal.feature.comments.lastCommentDeleted",F);f.off("bitbucket.internal.keyboard.shortcuts.pullrequest.addCommentHandler",E);f.off("bitbucket.internal.feature.pullRequest.self.added",
this._reviewerSelfHandler);f.off("bitbucket.internal.feature.pullRequest.self.removed",this._reviewerSelfHandler);k.chain(this.renderedDiffFileContents).pluck("inlineInfo").pluck("fileContent").invoke("destroy").value();delete this.renderedDiffFileContents;k.invoke(this.fileCommentContexts,"destroy");delete this.fileCommentContexts;r.unbindContext(this._$container);t.prototype.reset.call(this);this.currentTime=void 0;this._inited=!1};e.prototype.checkCommentIsNew=function(a){a.isUnread=a.updatedDate>
this.lastViewed&&(!n.getCurrentUser()||a.author.name!==n.getCurrentUser().getName());a.comments.length&&k.each(a.comments,k.bind(this.checkCommentIsNew,this))};e.prototype.checkCommentActivitiesAreNew=function(a){var b=this;k.each(a,function(a){"COMMENTED"===a.action&&b.checkCommentIsNew(a.comment)})};e.prototype.requestData=function(a,b){var c=this,d=0!==a||k.isUndefined(this.fromType)||k.isUndefined(this.fromId)?{}:{fromType:this.fromType,fromId:this.fromId};this._$spinner.spin("large");return C.rest({url:q.rest().project(this.pullRequestPathComponents.projectKey).repo(this.pullRequestPathComponents.repoSlug).pullRequest(this.pullRequestPathComponents.pullRequestId).activities().withParams(h.extend(d,
{start:a,limit:b,avatarSize:bitbucket.internal.widget.avatarSizeInPx({size:"medium"}),markup:!0})).build(),statusCode:{404:function(a,b,d,m,u){a=void 0;(m=k.get(m,["errors","0"],null))&&"com.atlassian.bitbucket.commit.NoSuchCommitException"===m.exceptionName?a={canClose:!0,fallbackTitle:p.I18n.getText("bitbucket.web.ajax.back.to.projects"),fallbackUrl:q.allProjects().build(),message:m.message,shouldReload:!1,title:p.I18n.getText("bitbucket.web.couldnt.find.title")}:(a={canClose:!1,fallbackTitle:p.I18n.getText("bitbucket.web.pullrequest.activity.notfound.fallback.title"),
fallbackUrl:q.project(c.pullRequestPathComponents.projectKey).repo(c.pullRequestPathComponents.repoSlug).pullRequest(c.pullRequestPathComponents.pullRequestId).overview().build(),shouldReload:!1},"activity"===c.fromType?(a.message=p.I18n.getText("bitbucket.web.pullrequest.activity.notfound.message"),a.title=p.I18n.getText("bitbucket.web.pullrequest.activity.notfound.title")):(a.message=p.I18n.getText("bitbucket.web.pullrequest.comment.notfound.message"),a.title=p.I18n.getText("bitbucket.web.pullrequest.comment.notfound.title")));
return babelHelpers.extends({},u,a)}}}).done(function(a,b,d){c.currentTime||(b=(new Date(d.getResponseHeader("Date"))).getTime(),d=z.buildKey("last-viewed","pull-request"),c.currentTime=isNaN(b)?(new Date).getTime():b,c.lastViewed=z.getItem(d)||c.currentTime,z.setItem(d,c.currentTime));c.checkCommentActivitiesAreNew(a.values)}).fail(function(){c._$spinner.spinStop()})};e.prototype.attachContent=function(a,b){this._$container["html"===a?"append":a](b)};e.prototype.decorateForFocus=function(a){var b;
if("activity"===this.fromType){var c=parseInt(this.fromId,10);k.some(a.values,function(a,g){return a.id===c?(a.isFocused=!0,b=c,!0):!1})}else{var d=parseInt(this.fromId,10),g=function L(a){return a.id===d?a.isFocused=!0:a.comments?k.some(a.comments,function(a){return L(a)}):!1};k.some(a.values,function(a,c){return a.comment&&g(a.comment)?(b=a.id,!0):!1})}return b};e.prototype.onAttachFirstPermalinkPage=function(a,b){function c(){l.hide();e.spin("large");var a=d.loadedRange.pageBefore(d.options.pageSize);
C.rest({url:q.rest().project(d.pullRequestPathComponents.projectKey).repo(d.pullRequestPathComponents.repoSlug).pullRequest(d.pullRequestPathComponents.pullRequestId).activities().withParams(h.extend(a,{avatarSize:bitbucket.internal.widget.avatarSizeInPx({size:"medium"}),markup:!0})).build()}).done(function(a,b,c){d.loadedRange.add(a.start,a.size,a.isLastPage,a.nextPageStart);var h;k.any(a.values,function(a,b){if(a.id===u)return h=b,!0});b=a.values.slice(0,h);d.checkCommentActivitiesAreNew(b);d.attachActivities(b,
function(a){g.after(a)});a.isFirstPage||d.loadedRange.reachedStart()?(l.unbind("click"),g.remove(),e.remove()):(u=m,m=a.previousPageStartId);f.trigger(d.dataLoadedEvent,d,a.start,a.limit,a)}).always(function(){e.spinStop();l.show()})}var d=this,g=h(bitbucket.internal.v2.feature.pullRequest.loadPreviousActivities());this.attachContent(b,g);var l=g.find("a"),e=g.append(h('\x3cdiv class\x3d"spinner"/\x3e')),m=a.previousPageStartId,u=a.values[0].id;l.click(function(a){a.preventDefault();c()})};e.prototype.attachActivities=
function(a,b){var c=this,d=0,g=new w({pullRequest:this.pullRequest}),l=h(k.map(a,function(a){var b;"COMMENTED"===a.action&&(b=g.getPullRequest().getToRef().getRepository(),b=a.diff?x.fromDiff(a.diff,g,b):null,b=H(a,b));a=bitbucket.internal.v2.feature.pullRequest.activityListItem({activity:a,pullRequest:c.pullRequest.toJSON(),commitRange:g.toJSON(),isNew:!1,commitId:a.commentAnchor&&a.commentAnchor.toHash,commentLink:b});d++;return a}).join(""));K.container(l);var f=k.reduce(a,function(a,b){a[b.id]=
b;return a},{});b(l);this.fileCommentContexts=e.addBreadcrumbsAndBindFileComments(l.filter(".file-comment-activity"),f,g);l=e.renderDiffs(l.filter(".diff-comment-activity"),f,g);this.renderedDiffFileContents=this.renderedDiffFileContents.concat(l);this._$container.find(".pull-request-diff-outdated-lozenge").tooltip({gravity:"ne"});this._$container.find(".reviewers-updated-activity .aui-avatar img").tooltip({gravity:"n"});return l};e.prototype.attachNewContent=function(a,b){function c(a){if(d._inited)if(a=
e?h(".comment.focused",a):h(".activity-item.focused",a),a.length)D.scrollTo(a,{waitForImages:!0,cancelIfScrolled:!0,duration:400}),f.trigger("bitbucket.internal.feature.pullRequestActivity.focused",null,a);else if(e)f.once("bitbucket.internal.feature.comments.commentContainerAdded",c)}var d=this,g=h("#pull-request-activity \x3e li.comment-form-container"),l=!k.isUndefined(this.fromId)&&!k.isUndefined(this.fromType),e="comment"===this.fromType,g=0===g.siblings().length,m;l&&g&&(m=this.decorateForFocus(a));
if(l&&!a.isFirstPage&&g)this.onAttachFirstPermalinkPage(a,b);l=this.attachActivities(a.values,function(a){d.attachContent(b,a)});this._$spinner.spinStop();a.isLastPage&&this._$spinner.remove();null!=m&&((m=k.findWhere(l,{activityId:m}))?m.inlineInfo.initPromise.done(c.bind(null,null)):c())};e.renderDiffForComment=function(a,b,c){a=new A(a);var d=c.getPullRequest().getToRef().getRepository();c=x.fromDiff(b.diff,c,d);b=a.init(c,{commentMode:A.commentMode.REPLY_ONLY,lineComments:[b.comment],asyncDiffModifications:!1,
attachScroll:!1,autoResizing:!0,scrollStyle:"inline",isExcerpt:!0,contentMode:I.DIFF,changeTypeLozenge:!1,changeModeLozenge:!1,fileIcon:!0,breadcrumbs:!0,scrollPaneSelector:"self",pullRequestDiffLink:!0,pullRequestDiffCurrent:!b.commentAnchor.orphaned,diffType:b.commentAnchor.diffType,pullRequestDiffLinkUrl:H(b,c),toolbarWebFragmentLocationPrimary:"bitbucket.pull-request.activity.diff.toolbar.primary",toolbarWebFragmentLocationSecondary:"bitbucket.pull-request.activity.diff.toolbar.secondary"});return{fileContent:a,
initPromise:b}};e.renderDiffs=function(a,b,c){var d=[];k.each(a,function(a){var c=Number(a.getAttribute("data-activityid"));d.push({activityId:c,el:a,data:b[c]})});return J.doInOperation(function(){return k.map(d,function(a){return{activityId:a.activityId,inlineInfo:e.renderDiffForComment(h(a.el).find(".detail"),a.data,c)}})})};e.addBreadcrumbsAndBindFileComments=function(a,b,c){var d=[];a.each(function(){var a=h(this),e=a.attr("data-activityid"),f=b[e],e=new B(f.commentAnchor.path),f=!(f.commentAnchor&&
f.commentAnchor.orphaned),m=k.map(e.getComponents(),function(a){return{text:a}});a.find(".breadcrumbs").append(bitbucket.internal.widget.breadcrumbs.crumbs({pathComponents:m,primaryLink:f?q.currentPullRequest().diff().change(e).build():void 0}));e=new x({repository:n.getRepository(),commitRange:c,path:e});a=r.bindContext(a,new r.DiffAnchor(e),{$toolbar:a.find(".file-toolbar"),commentMode:r.commentMode.REPLY_ONLY});d.push(a)});return d};e.prototype.addNewActivity=function(a){var b=h("#pull-request-activity .comment-form-container").first(),
c=h(bitbucket.internal.v2.feature.pullRequest.activityListItem({currentUser:a.currentUser.name?a.currentUser:a.currentUser.toJSON(),activity:a.activity,pullRequest:a.pullRequest.id?a.pullRequest:a.pullRequest.toJSON(),commitRange:new w({pullRequest:a.pullRequest}),isNew:!0})).hide().insertAfter(b).fadeIn("slow");setTimeout(function(){c.removeClass("new")},3E3)};e.prototype.handleErrors=h.noop;return e});