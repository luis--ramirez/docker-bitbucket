define("bitbucket/internal/layout/page-scrolling-manager","aui bacon jquery bitbucket/internal/util/bacon bitbucket/internal/util/events bitbucket/internal/util/function bitbucket/internal/util/region-scroll-forwarder bitbucket/internal/util/scroll exports".split(" "),function(z,d,b,m,C,D,E,F,f){function A(b){var c=b.offset().top,g=0;b.prevAll(".aui-message").each(function(b,c){g+=c.offsetHeight});return c-g}function w(){function c(a){var p=null,b=a;h.takeUntil(e).onValue(function(a){b=a});a=new E(m.getWindowScrollProperty(),
[{id:"pre",groupId:"outside",setScrollTop:function(a){null===p&&(p=f.offset().top);x(null,a);t.$wrapper.css("top",Math.max(0,a-p));t.$wrapper.hasClass("aui-is-docked")&&0!==a||t.reflow()},getHeight:function(){var a=b.offset().top,p=A(n,r);return a-p}},{id:"in",groupId:"inside",setScrollTop:function(a){b.scroll(null,a)},getHeight:function(){return Infinity}}]);y.takeUntil(e).onValue(a,"heightsChanged");return a}var l=b(window),g=document.body,r=b(g),n=b("#page"),k=n[0],f=b(".aui-sidebar"),t=z.sidebar(f),
v=g.style.height;r.addClass("scrolling-forwarded");var e=new d.Bus,u=new d.Bus,q=new d.Bus,h=new d.Bus,y=h.sampledBy(d.mergeAll(h,u,d.interval(1E3).takeUntil(e),m.getWindowSizeProperty().changes())).filter(function(a){return!!a}).takeUntil(e).map(".offset").map(function(a){var b=A(n);return{top:Math.round(a.top-b)}}).skipDuplicates(function(a,b){return a.top===b.top}).toProperty(),B=h.sampledBy(d.mergeAll(h,u)).filter(function(a){return!!a}).takeUntil(e).map(".scrollSizing").skipDuplicates(function(a,
b){return a.height===b.height&&a.clientHeight===b.clientHeight}).toProperty();d.combineWith(function(a,b,c){return a.top+Math.max(b.height,b.clientHeight)+(c.height-b.clientHeight)},y,B,m.getWindowSizeProperty()).takeUntil(e).onValue(function(a){r.height(a);C.trigger("bitbucket.internal.layout.body.resize")});var x=F.fakeScroll(k);m.getWindowScrollProperty().takeUntil(e).onValue(function(a){x(a.left,null)});d.combineAsArray(q,y.sampledBy(q),B.sampledBy(q)).map(D.spread(function(a,b,c){return{scrollTop:null!=
a.scrollTop?b.top+Math.max(0,Math.min(a.scrollTop,c.height-c.clientHeight)):null}})).onValue(function(a){null!=a.scrollTop&&l.scrollTop(a.scrollTop)});var w=h.onValue(function(a){e.onValue(c(a),"destroy");w()});return{setTarget:function(a){h.push(a)},scroll:function(a,b){q.push({scrollTop:b})},refresh:function(){u.push(!0)},destroy:function(){r.removeClass("scrolling-forwarded");x(0,0);t.$wrapper.css("top","");g.style.height=v||null;q.end();e.push(!0);e.end();u.end();h.end()}}}var v=b(window),k=!1,
l,c;f.acceptScrollForwardingRequests=function(){if(k)throw Error("acceptScrollForwardingRequests has already been called. It must be unregistered before it can be called again.");k=!0;l=null;return function(){c&&(z.log("Scroll control is not yet destroyed. Ongoing scroll requests will be ignored."),c.scrollTo=b.noop,c.destroy());k=!1}};f._requestScrollControl=function(){function d(){v.scrollTop(Math.min(l,f.offset().top-b("#page").offset().top))}var f;if(!k)return b.Deferred().reject({reason:"NOT_ACCEPTING"});
if(c)return b.Deferred().reject({reason:"CONTROL_TAKEN"});b("#footer").hide();c=w();c.setTarget=function(b){return function(k){var n=b.apply(this,arguments);f=k;var m=!c;null==l||m||(d(),l=null);return n}}(c.setTarget);c.destroy=function(g){return function(){f&&(l=v.scrollTop(),d());b("#footer").show();c=null;return g.apply(this,arguments)}}(c.destroy);return b.Deferred().resolve(c)}});