define("bitbucket/internal/layout/pull-request","aui aui/flag jquery lodash bitbucket/util/events bitbucket/util/navbuilder bitbucket/internal/feature/pull-request-edit bitbucket/internal/feature/pull-request/can-merge bitbucket/internal/feature/pull-request/merge-help bitbucket/internal/model/page-state bitbucket/internal/model/participant bitbucket/internal/model/pull-request bitbucket/internal/model/stash-user bitbucket/internal/util/ajax bitbucket/internal/util/dom-event bitbucket/internal/util/events bitbucket/internal/util/feature-loader bitbucket/internal/util/history bitbucket/internal/util/horizontal-keyboard-scrolling bitbucket/internal/util/shortcuts bitbucket/internal/widget/approve bitbucket/internal/widget/avatar-list bitbucket/internal/widget/confirm-dialog bitbucket/internal/widget/submit-spinner exports".split(" "),
function(g,H,e,t,I,u,J,K,L,k,M,N,O,v,P,d,y,Q,D,B,R,S,T,U,E){function z(b,c){var a=u.rest().currentPullRequest()[b]();c&&(a=a.withParams({version:k.getPullRequest().getVersion()}));return a.build()}function V(b,c){if(b.length){var a={dialog:{person:k.getCurrentUser()&&k.getCurrentUser().toJSON(),pullRequest:f.toJSON()},ajax:{statusCode:{400:function(){return!1},401:function(a,b,c,d,f){return e.extend({},f,{title:g.I18n.getText("bitbucket.web.pullrequest.merge.error.401.title"),message:g.I18n.getText("bitbucket.web.pullrequest.merge.error.401.message"),
fallbackUrl:!1,shouldReload:!0})},409:function(a,b,c,e,g){if((a=e.errors&&e.errors.length&&e.errors[0])&&(a.conflicted||a.vetoes&&a.vetoes.length))return d.trigger("bitbucket.internal.pull-request.cant.merge",null,f,a.conflicted,a.vetoes),d.trigger("bitbucket.internal.pull-request.show.cant.merge.help"),!1}},timeout:1E3*(c||300)}};W(b,a);e(document).ready(function(){X(b)})}}function Y(b){b.length&&(b="\x3cp class\x3d'decline-message'\x3e"+g.I18n.getText("bitbucket.web.pullrequest.decline.dialog.message")+
"\x3c/p\x3e",b={buttonSelector:".decline-pull-request",confirmDialog:{titleText:g.I18n.getText("bitbucket.web.pullrequest.decline.dialog.title"),panelContent:b,submitText:g.I18n.getText("bitbucket.web.button.decline")},confirmEvent:"bitbucket.internal.feature.pullRequest.declined",ajax:{statusCode:{401:function(b,a,h,d,l){return e.extend({},l,{title:g.I18n.getText("bitbucket.web.pullrequest.decline.error.401.title"),message:g.I18n.getText("bitbucket.web.pullrequest.decline.error.401.message"),fallbackUrl:!1,
shouldReload:!0})}}}},Z("decline",b))}function aa(b){b.preventDefault();w.hasClass("disabled")||(w.addClass("disabled"),C.show().spin("small"),v.rest({url:z(b.data.action,!0),type:"POST"}).done(function(){window.location.reload()}).fail(function(){w.removeClass("disabled");C.spinStop().hide()}))}function Z(b,c){var a=new T(e.extend({id:"pull-request-"+b+"-dialog",submitToHref:!1,resizeOnShow:!0,width:650,height:200},c.confirmDialog)),h,p;a.addConfirmListener(function(l,m,g,f,k){a.setButtonsDisabled(!0);
k.show();l=h=v.rest(e.extend({url:z(b,!0),type:"POST"},c.ajax));p&&(m=p(h,m,g,f,k))&&(l=m);l.done(function(){c.confirmEvent&&d.trigger(c.confirmEvent);window.location=u.currentPullRequest().build()}).fail(function(){g()}).always(function(){h=null})});a.addCancelListener(function(a){h&&h.abort()});a.setPromiseDecorator=function(a){p=a};a.attachTo(c.buttonSelector,c.onShow);return a}function W(b,c){var a=g.dialog2(bitbucket.internal.feature.pullRequest.merge.dialog(c.dialog));e("body").append(a.$el);
b.on("click",function(){a.show();q(a);a.$el.find(".confirm-button").focus()});var h,p;a.$el.find(".confirm-button").on("click",function(){var b=new U(this,"before");F(a,!0);b.show();var m=h=v.rest(e.extend({url:z("merge",!0),type:"POST",data:{message:a.$el.find("#commit-message").val()}},c.ajax));h.fail(function(c,h,e,d){400===c.status?(c=a.$el.find(".aui-dialog2-content"),d.errors&&(c.children(".aui-message").remove(),c.prepend(bitbucket.internal.feature.pullRequest.merge.errors({errors:d.errors}))),
b.hide(),F(a,!1)):a.hide()}).always(function(){h=null});if(!p)try{p=require("pullRequest/branchDeletion").getMergePromiseDecorator}catch(g){}if(p){var f=p(m,function(){a.hide()});f&&(m=f)}m.done(function(){d.trigger("bitbucket.internal.feature.pullRequest.merged");window.location=u.currentPullRequest().build()})});a.$el.find(".cancel-button").on("click",function(){h&&(h.abort(),h=null);q(a);a.hide()});a.$el.find(".commit-message").on("focus",ba);a.$el.find(".cancel-commit-message-link").click(function(b){b.preventDefault();
q(a)});a.on("hide",function(){q(a)});return a}function ca(){d.on("bitbucket.internal.widget.keyboard-shortcuts.register-contexts",function(b){b.enableContext("pull-request");G.resolve(b)});d.on("bitbucket.internal.keyboard.shortcuts.requestGotoPullRequestsListHandler",function(b){(this.execute?this:g.whenIType(b)).execute(function(){window.location.href=u.currentRepo().allPullRequests().build()})});d.on("bitbucket.internal.keyboard.shortcuts.requestChangePullRequestSectionHandler",function(b){(this.execute?
this:g.whenIType(b)).execute(function(b){b=parseInt(String.fromCharCode(b.which),10);x.children().eq(b-1).children("a").click()})})}function F(b,c){b.$el.find(".aui-dialog2-footer-actions .aui-button").each(function(){var a=e(this);a.prop("disabled",c).toggleClass("disabled",c);c?a.attr("aria-disabled","true"):a.removeAttr("aria-disabled")})}function X(b){var c;d.on("bitbucket.internal.pull-request.cant.merge",function(a,h,f){c||(b.attr("aria-disabled","true").attr("disabled","disabled").attr("title",
g.I18n.getText("bitbucket.web.pullrequest.merge.issue.tooltip")),c=e(bitbucket.internal.feature.pullRequest.mergeDisabledIcon({conflicted:h,vetoes:f})).insertBefore(b).tooltip({delayOut:200,gravity:"n",html:!0,hoverable:!0,offset:7}).on("click",function(a){a.preventDefault();e(".tipsy").hide();d.trigger("bitbucket.internal.pull-request.show.cant.merge.help")}))});d.on("bitbucket.internal.pull-request.can.merge",function(){c&&(b.attr("aria-disabled","false").removeAttr("disabled").removeAttr("title"),
c.remove(),c=null)});K(f)}function ba(){e(this).closest(".commit-message-form").removeClass("collapsed")}function q(b){b.$el.find(".commit-message").val("");b.$el.find(".commit-message-form").addClass("collapsed")}function da(){function b(b){b.addClass("active-tab").siblings().removeClass("active-tab")}G.done(function(b){t.each(x.children(),function(a,h){var d=e(a),l=String(h+1),f=g.I18n.getText("bitbucket.web.keyboardshortcut.pull-request.switch.tabs",d.text());b.addCustomShortcut("pull-request",
[[l]],f);d.attr("title",(d.attr("title")||f)+g.I18n.getText("bitbucket.web.keyboardshortcut.type",l))})});x.on("click","a",function(c){if(P.openInSameTab(c)){var a=e(this),h=a.parent();h.is(".active-tab")||(b(h),d.trigger("bitbucket.internal.layout.pull-request.urlRequested",null,a.prop("href")));c.preventDefault()}});d.on("bitbucket.internal.page.pull-request.view.contextLoaded",function(c){b(x.find('[data-module-key\x3d"'+c.name+'"]'));c.name===r.diff?D.resume():D.pause()})}function ea(b){return new S(b,
f.getReviewers(),{pullRequestId:f.getId()})}function fa(){function b(a){var b=new O(a.user.__json||a.user),c=f.getReviewers().findByUser(b);if(c)c.setApproved(a.approved),f.getReviewers().sort();else if(b=f.getParticipants().findByUser(b))b.setApproved(a.approved),f.getParticipants().sort()}function c(a){var b=a.approved?g.I18n.getText("bitbucket.web.pullrequest.toolbar.approved.updateflag"):g.I18n.getText("bitbucket.web.pullrequest.toolbar.unapproved.updateflag");h(b,a)}function a(a){var b=a.watched?
g.I18n.getText("bitbucket.web.watchable.watched.tooltip"):g.I18n.getText("bitbucket.web.watchable.unwatched.tooltip");h(b,a)}function h(a,b){t.isMatch(b,A)&&(e&&e.close(),e=H({type:"success",title:a,close:"auto"}))}var e;d.on("bitbucket.internal.widget.approve-button.adding",b);d.on("bitbucket.internal.widget.approve-button.removing",b);d.on("bitbucket.internal.widget.approve-button.add.failed",b);d.on("bitbucket.internal.widget.approve-button.remove.failed",b);d.on("bitbucket.internal.widget.approve-button.added",
c);d.on("bitbucket.internal.widget.approve-button.removed",c);d.on("bitbucket.internal.web.watch-button.added",a);d.on("bitbucket.internal.web.watch-button.removed",a)}function ga(){function b(a){a=new M(a);return f.getReviewers().findByUser(a.getUser())||f.getParticipants().findByUser(a.getUser())?!1:(f.addParticipant(a),!0)}function c(a){a.name!==f.getAuthor().getUser().getName()&&b({approved:!1,user:a,role:"PARTICIPANT"})}d.on("bitbucket.internal.widget.approve-button.adding",function(a){b({approved:a.approved,
user:a.user.__json||a.user,role:"PARTICIPANT"})});d.on("bitbucket.internal.feature.comments.commentAdded",function(a){c(a.author)});d.on("bitbucket.internal.feature.pull-request-tasks.saved",function(a){c(k.getCurrentUser().toJSON())});f.getParticipants().on("add",function(a){var b=k.getCurrentUser();b&&b.getName()===a.getUser().getName()&&k.setIsWatching(!0)})}function ha(b,c){function a(a,b){var c=t.findKey(r,t.matches(b));c&&I.trigger("bitbucket.internal.browser-metrics.pull-request."+c+"."+a)}
n.registerHandler(r.diff,/^[^\?\#]*pull-requests\/\d+\/diff/,"bitbucket/internal/page/pull-request/view/pull-request-view-diff");n.registerHandler(r.overview,/^[^\?\#]*pull-requests\/\d+\/overview/,"bitbucket/internal/page/pull-request/view/pull-request-view-overview");n.registerHandler(r.commits,/^[^\?\#]*pull-requests\/\d+\/commits/,"bitbucket/internal/page/pull-request/view/pull-request-view-commits");d.on("bitbucket.internal.page.pull-request.view.contextRequested",a.bind(null,"start"));d.on("bitbucket.internal.page.pull-request.view.contextLoaded",
function(b){a("end",b.name)});d.on("bitbucket.internal.widget.keyboard-shortcuts.register-contexts",function(a){n.setKeyboardShortcuts(a);a.enableContext("pull-request")});d.on("bitbucket.internal.layout.pull-request.urlRequested",function(a){a!==window.location.href&&Q.pushState(null,"",a)});d.on("bitbucket.internal.util.feature-loader.errorOccurred",function(a){a.code===y.NO_HANDLER?console.log("You did not register a handler for this page. Please call\nrequire('bitbucket/internal/layout/pull-request').registerHandler(\n   'tab-web-item-module-key',\n   /^[^\\?\\#]*url-regex/,\n   {\n       load : function (contentElement) {},\n       unload : function (contentElement) {}\n   }\n)"):
console.log(a.message)});c.done(function(a){n.init(e(b).get(0))})}var r={diff:"bitbucket.pull-request.nav.diff",overview:"bitbucket.pull-request.nav.overview",commits:"bitbucket.pull-request.nav.commits"},f,w,C,x,G=e.Deferred(),A={triggeredBy:"keyboardShortcut"},n=new y({loadedEvent:"bitbucket.internal.page.pull-request.view.contextLoaded",unloadedEvent:"bitbucket.internal.page.pull-request.page.pull-request.view.contextUnloaded",requestedEvent:"bitbucket.internal.page.pull-request.view.contextRequested"});
E.registerHandler=e.proxy(n.registerHandler,n);E.onReady=function(b,c,a,d,g,l,m,n){k.setPullRequest(new N(b));k.extend("pullRequestViewInternal",function(){return{diffTreeHeaderWebItems:d,commitsTableWebSections:g,maxChanges:l,relevantContextLines:n}});k.extend("isWatching");var r=e.Deferred();_PageDataPlugin.ready("com.atlassian.bitbucket.server.bitbucket-web:iswatching-provider","bitbucket.internal.pull-request.view",function(a){k.setIsWatching(a.isWatching);r.resolve()});L.init();f=k.getPullRequest();
b=e(".merge-pull-request");c=e(".decline-pull-request");var u=e(".reopen-pull-request"),q=e(".approve"),v=e(".edit-pull-request"),y=new J(f);w=e(".pull-request-toolbar .aui-toolbar2-secondary");C=e("\x3cdiv class\x3d'spinner'/\x3e").prependTo(w.children(":first-child"));x=e(".content-body .aui-page-panel-content \x3e .aui-tabs \x3e .tabs-menu");B.bind("pullRequestApprove",t.ary(q.trigger.bind(q,"click",A),0));B.bind("pullRequestEdit",t.ary(v.trigger.bind(v,"click",A),0));B.bind("pullRequestWatch",
function(){e(".plugin-item.watch a").trigger("click",A)});V(b,m);Y(c);u.click({action:"reopen"},aa);y.bind(".edit-pull-request, .add-description");new R(q,z("approve"));ea(e(".reviewers"));ga();fa();ca();da();ha(a,r)}});