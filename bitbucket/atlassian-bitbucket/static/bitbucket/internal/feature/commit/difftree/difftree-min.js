define("bitbucket/internal/feature/commit/difftree","aui jquery lodash bitbucket/util/navbuilder bitbucket/util/state bitbucket/internal/feature/commit/difftree/difftree-search bitbucket/internal/model/content-tree-node-types bitbucket/internal/model/path-and-line bitbucket/internal/util/ajax bitbucket/internal/util/events bitbucket/internal/util/property exports".split(" "),function(g,m,k,E,K,F,G,x,y,h,H,l){function p(a,b){function c(a){if(a.metadata.isDirectory){a.state="open";a.data.icon="aui-icon aui-icon-small aui-iconfont-devtools-folder-open";
var f,g=a.children.length,e;for(f=0;f<g&&d<b;f++)e=a.children[f],c(e)}else a.metadata.isFile&&(a.children&&0<a.children.length&&(a.state="open"),d+=a.children?a.children.length:1)}b=0<=b?b:200;var d=0;c(a);return a}function z(a,b){return a.children?b.children?a.data.title.toLowerCase()<b.data.title.toLowerCase()?-1:1:-1:b.children?1:a.data.title.toLowerCase()<b.data.title.toLowerCase()?-1:1}function u(a){a.childrenByTypeAndComponent=void 0;var b,c=a.children.length,d,q;for(b=0;b<c;b++)if(d=a.children[b],
d.metadata.isDirectory){for(q=[d.data.title];1===d.children.length&&d.children[0].metadata.isDirectory;)d=d.children[0],q.push(d.data.title);d.data.title=g.escapeHtml(q.join("/"));a.children[b]=d;u(d)}a.children.sort(z)}function A(a,b){var c={data:{icon:"aui-icon aui-icon-small aui-iconfont-devtools-folder-closed"},state:"closed",metadata:{isDirectory:!0},children:[],childrenByTypeAndComponent:{}},d,q=a.length,f,e;for(d=0;d<q;d++){f=a[d];e=c;var h,k=f.path.components.length,n,r;for(h=0;h<k;h++)if(n=
f.path.components[h],r=(h+1===k?"F":"D")+n,Object.prototype.hasOwnProperty.call(e.childrenByTypeAndComponent,r))e=e.childrenByTypeAndComponent[r];else{if(h+1===k){var B=!(!f.properties||!f.properties.activeComments);n={data:{title:g.escapeHtml(n),icon:"aui-icon aui-icon-small "+(f.nodeType===G.SUBMODULE?"aui-iconfont-devtools-submodule":B?"aui-iconfont-devtools-file-commented":"aui-iconfont-devtools-file"),attr:{id:"change"+d,"class":"difftree-file change-type-"+f.type+(f.conflict?" conflict":""),
href:"#"+encodeURI(f.path.toString),title:f.conflict?g.I18n.getText("bitbucket.web.pullrequest.tree.conflicted.file"):B?g.I18n.getText("bitbucket.web.pullrequest.tree.commented.file"):void 0}},metadata:{isFile:!0,changeType:f.type,nodeType:f.nodeType,path:f.path,srcPath:f.srcPath,conflict:f.conflict,contentId:f.contentId,fromContentId:f.fromContentId,executable:f.executable,srcExecutable:f.srcExecutable}}}else n={data:{title:g.escapeHtml(n),icon:"aui-icon aui-icon-small aui-iconfont-devtools-folder-closed"},
state:"closed",metadata:{isDirectory:!0},children:[],childrenByTypeAndComponent:{}};e.children.push(n);e=e.childrenByTypeAndComponent[r]=n}}u(c);p(c,b);return c}function I(a,b,c){return E.rest().currentRepo().changes(c).withParams({start:a,limit:b})}function e(a,b,c,d){d=d||{};this._fileLimit=d.maxChanges||1E3;H.getFromProvider("page.max.diff.lines").done(function(a){this._maxDiffLines=a}.bind(this));this._$wrapper=m(a);this._$toolbar=m(b);this._commitRange=c;this._hasOtherParents=!!d.hasOtherParents;
this._urlBuilder=d.urlBuilder||I;this._searchUrlBuilder=d.searchUrlBuilder}function t(a,b){var c;if(!(c=J(a,b))){for(c=a;c&&c.children;)c=c.children[0];c=c&&c.metadata&&c.metadata.isFile?c:null}return c}function J(a,b){if(!b)return null;for(b=b.slice(0);a&&a.children;){for(var c=b.shift(),d=!b.length,e=a.children.length;e--;){var f=a.children[e],g=f.data.title;if(c===g&&d===Boolean(f.metadata.isFile)){a=f;break}if(!d&&k.startsWith(g,c+"/")){for(;1<b.length&&k.startsWith(g,c+"/"+b[0]);)c+="/",c+=b.shift();
if(g!==c)return null;a=f;break}}if(0>e)return null}return a&&a.metadata&&a.metadata.isFile?a:null}function v(a,b){if(a===b)return[b];for(var c=a.children?a.children.length:0;c--;){var d=v(a.children[c],b);if(d)return d.unshift(a),d}return null}function w(a,b,c){c&&c.length&&!c.hasClass("jstree-leaf")&&(a.open_node(c),c=w(a,b,b.call(a,c)));return c}function C(a,b){b&&!b.hasClass("jstree-leaf")&&(b.hasClass("jstree-closed")?(a.open_node(b),b=w(a,D,D.call(a,b))):b.length&&(b=C(a,a._get_prev(b))));return b}
function D(a){return this._get_children(a).filter(".jstree-last")}k.extend(e.prototype,h.createEventMixin("diffTree",{localOnly:!0}));e.prototype.init=function(a){this._destroyables=[];this._selectedPathComponents=a;this._firstCommentAddedHandler=k.bind(this._firstCommentAddedHandler,this);this._lastCommentDeletedHandler=k.bind(this._lastCommentDeletedHandler,this);this._destroyables.push(h.chain().on("bitbucket.internal.feature.comments.firstCommentAdded",this._firstCommentAddedHandler).on("bitbucket.internal.feature.comments.lastCommentDeleted",
this._lastCommentDeletedHandler));this._searchUrlBuilder&&this._destroyables.push(this._addSearch());return this.data?this.dataReceived(this.data):this.requestData()};e.prototype._addSearch=function(){var a=this,b=[],c=new F.DiffTreeSearch,d=this._$wrapper.siblings(".file-tree-header"),e=m(bitbucket.internal.feature.difftree.searchWrapper({includeCollapseButton:!d.length}));e.prepend(c.input.$el);d.length?(d.after(e),b.push({destroy:function(){return e.remove()}})):function(){var c=a._$toolbar.find("h4");
c.replaceWith(e);b.push({destroy:function(){return e.replaceWith(c)}})}();b.push(c);b.push(h.chainWith(e.find(".search-button-when-collapsed")).on("click",function(){c.focusSearch()}));b.push(h.chainWith(c).on("search-focus",k.bind(this.trigger,this,"search-focus")));b.push({destroy:c.register(function(b){e.addClass("searching");return y.rest({url:a._searchUrlBuilder({path:"",commitRange:a._commitRange.toJSON()}).withParams({withComments:!1}).withParams(!b||!a._commitRange.getPullRequest()&&50>a._getFileCount(a.data,
50)?{}:{filter:b}).build()}).done(function(){return e.removeClass("searching")})},function(){return a.data}).onValue(function(b){e.toggleClass("searching",Boolean(b.search));a.data_copy=a.data;a._searchEmpty=0===b.data.children.length;h.trigger("bitbucket.internal.feature.diffView.highlightSearch",null,b.search);a.dataReceived(p(b.data)).done(function(){a.data=a.data_copy;a._searchEmpty=null})})});return{destroy:function(){k.invoke(b,"destroy")}}};e.prototype._getFileCount=function(a,b){function c(a){return k.reduce(a.children,
function(a,d){return a<b?a+(d.metadata.isFile?1:c(d)):a},0)}return c(a)};e.prototype._firstCommentAddedHandler=function(){this.getSelectedFile().find("a \x3e ins").hide().removeClass("aui-iconfont-devtools-file").addClass("aui-iconfont-devtools-file-commented").fadeIn("slow")};e.prototype._lastCommentDeletedHandler=function(){this.getSelectedFile().find("a \x3e ins").hide().removeClass("aui-iconfont-devtools-file-commented").addClass("aui-iconfont-devtools-file").fadeIn("slow")};e.prototype.reset=
function(){this._request&&(this._request.abort(),this._request=null,this._interrupted=!0);this._rendering&&(this._rendering=!1,this._interrupted=!0);k.invoke(this._destroyables,"destroy")};e.prototype.requestData=function(){var a=this;this._request&&(this._request.abort(),this._request=null);this._request=y.rest({url:a._urlBuilder(0,a._fileLimit,a._commitRange).build()});return this._request.always(function(){a._request=null}).then(function(b){if(b)return a._rendering=!0,a._interrupted=!1,a.isTruncated=
!b.isLastPage,a.dataReceived(A(b.values)).done(function(){a._rendering=!1});b=g.escapeHtml(g.I18n.getText("bitbucket.web.pullrequest.tree.nodata"));a.prependMessage(b,"error");return m.Deferred().reject()})};e.prototype.prependMessage=function(a,b){this._$wrapper.find(".aui-message").remove();b=b||"warning";this._$wrapper.find(".file-tree").before(aui.message[b]({extraClasses:"diff-tree-scm-message",content:a}))};e.prototype.dataReceived=function(a){function b(){c._interrupted?d.reject(c):d.resolve(c)}
var c=this;this.data=a;var d=m.Deferred();a=t(this.data,this._selectedPathComponents);var e;if(a)for(e=[a.data.attr.id],a=v(this.data,a)||[],a.pop();a.length;)a.pop().state="open";else e=[];var f=!0,k;this._$wrapper.find(".aui-message").remove();if(this.isTruncated){a="";if(this._commitRange.getPullRequest())a=g.escapeHtml(g.I18n.getText("bitbucket.web.pullrequest.tree.truncated",this._fileLimit));else{a=this._commitRange.getUntilRevision();var l=this._commitRange.getSinceRevision();a=l?"git diff-tree -C -r "+
l.getId()+" "+a.getId():"git diff-tree -r --root "+a.getId();a=g.escapeHtml(g.I18n.getText("bitbucket.web.commit.tree.truncated",this._fileLimit))+'\x3cp class\x3d"scm-command"\x3e'+g.escapeHtml(a)+"\x3c/p\x3e"}this.prependMessage(a,"warning")}if(this.data.children.length)this.data.searchTruncated&&c.prependMessage(g.escapeHtml(g.I18n.getText("bitbucket.web.commit.tree.truncated.search",this._maxDiffLines)),"info"),this.$tree=this._$wrapper.children(".file-tree"),this.$tree.fadeOut("fast",function(){c.$tree.empty().off(".jstree").jstree("destroy").on("loaded.jstree",
function(){setTimeout(function(){f=!1;b()},0)}).jstree({json_data:{data:c.data.children,progressive_render:!0},core:{html_titles:!0,animation:200},ui:{select_limit:1,selected_parent_close:!1,initially_select:e},plugins:["json_data","ui"]}).on("before.jstree",function(a,b){if("select_node"===b.func){var d=m(b.args[0]).parent();if(d.hasClass("jstree-leaf")&&(!k||k[0]!==d[0]))k=d,h.trigger("bitbucket.internal.feature.commit.difftree.selectedNodeChanged",c,d,f),c._selectedPathComponents=(new x(d.data("path"))).path.getComponents();
else if(0<d.length)return c.$tree.jstree("toggle_node",d),!1}}).on("open_node.jstree",function(a,b){var d=b.args[0];if(d.data().isDirectory){var e=d.children("a").children("ins");e.removeClass("aui-iconfont-devtools-folder-closed");e.addClass("aui-iconfont-devtools-folder-open")}h.trigger("bitbucket.internal.feature.commit.difftree.nodeOpening",c,d)}).on("after_open.jstree",function(a,b){h.trigger("bitbucket.internal.feature.commit.difftree.nodeOpened",c,b.args[0])}).on("close_node.jstree",function(a,
b){var d=b.args[0];if(d.data().isDirectory){var e=d.children("a").children("ins");e.removeClass("aui-iconfont-devtools-folder-open");e.addClass("aui-iconfont-devtools-folder-closed")}h.trigger("bitbucket.internal.feature.commit.difftree.nodeClosing",c,d)}).on("after_close.jstree",function(a,b){h.trigger("bitbucket.internal.feature.commit.difftree.nodeClosed",c,b.args[0])}).on("loaded.jstree",function(a,b){h.trigger("bitbucket.internal.feature.commit.difftree.treeInitialised",c,c)}).fadeIn("fast")});
else{this.$tree=void 0;var p=this._$wrapper.children(".file-tree");p.fadeOut("fast",function(){p.empty().off(".jstree").jstree("destroy");var a=g.escapeHtml(c._searchEmpty&&c.data.searchTruncated?g.I18n.getText("bitbucket.web.commit.tree.truncated.search",c._maxDiffLines)+" "+g.I18n.getText("bitbucket.web.commit.tree.emptysearch"):c._searchEmpty?g.I18n.getText("bitbucket.web.commit.tree.emptysearch"):c._hasOtherParents?g.I18n.getText("bitbucket.web.commit.merge.tree.empty"):g.I18n.getText("bitbucket.web.commit.tree.empty"));
c.prependMessage(a,"info");setTimeout(b,0)})}return d.promise().always(function(){c._$wrapper.attr("data-last-updated",(new Date).getTime())})};e.prototype.getSelectedFile=function(){return this.$tree?this.$tree.jstree("get_selected"):null};e.prototype._getSelectedFileOrTree=function(){var a=this.getSelectedFile();return a&&0<a.length?a:this.$tree};e.prototype.selectFile=function(a){if(this.$tree){a=t(this.data,a);var b=this.getSelectedFile(),b=(b=b&&b.data("path"))&&t(this.data,(new x(b)).path.getComponents());
a&&a!==b&&this.$tree.jstree("deselect_all").jstree("select_node","#"+a.data.attr.id)}};e.prototype.openNextFile=function(){if(this.$tree){var a=m.jstree._reference(this.$tree),b=this._getSelectedFileOrTree();(a=w(a,a._get_next,a._get_next(b)))&&a.length&&a.find("a").focus().click()}};e.prototype.openPrevFile=function(){if(this.$tree){var a=m.jstree._reference(this.$tree),b=this._getSelectedFileOrTree();(a=C(a,a._get_prev(b)))&&a.length&&a.find("a").focus().click()}};l.DiffTree=e;l.computeTree=A;l.flattenTree=
u;l._openTree=p;l.compareTreeNodes=z;l.getNodeToSelect=t;l.getPathFromRoot=v});