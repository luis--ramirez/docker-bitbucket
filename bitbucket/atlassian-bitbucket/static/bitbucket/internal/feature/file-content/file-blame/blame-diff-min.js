define("bitbucket/internal/feature/file-content/file-blame/blame-diff","jquery lodash bitbucket/util/navbuilder bitbucket/util/server bitbucket/internal/model/file-change-types bitbucket/internal/util/property".split(" "),function(c,f,k,l,d,g){function b(a){this._fileChange=a;this._optionsPromise=c.Deferred();this._blamePromise=null}b.prototype.get=function(){this._blamePromise||(this._blamePromise=c.when(this._optionsPromise,g.getFromProvider("display.max.source.lines")).then(this._requestBlame.bind(this)));
return this._blamePromise};b.prototype.initBlameOptions=function(a){this._optionsPromise.resolve(a)};b.prototype._calculateBlameWindowStart=function(a,c){var e=f.chain([a.firstAddedLine,a.firstRemovedLine]).compact().min().value()-1,d=Math.max(a.lastAddedLine,a.lastRemovedLine)-1;return Math.max(0,Math.floor((e+d)/2)-c/2)};b.prototype._requestBlame=function(a,b){var e=[],g=this._fileChange.type===d.MODIFY&&!a.firstAddedLine,h=this._fileChange.type===d.MODIFY&&!a.firstRemovedLine;this._fileChange.type===
d.DELETE||g?e.push(c.Deferred().resolve()):e.push(l.rest({url:k.currentRepo().browse().path(this._fileChange.path).at(a.until).build(),data:{blame:!0,noContent:!0,start:h?this._calculateBlameWindowStart(a,b):a.firstAddedLine-1,limit:h?b:a.lastAddedLine-a.firstAddedLine+1,avatarSize:bitbucket.internal.widget.avatarSizeInPx({size:"xsmall"})}}).then(f.identity));this._fileChange.type===d.ADD||h?e.push(c.Deferred().resolve()):e.push(l.rest({url:k.currentRepo().browse().path(this._fileChange.srcPath||
this._fileChange.path).at(a.since).build(),data:{blame:!0,noContent:!0,start:this._fileChange.type===d.DELETE?a.firstRemovedLine-1:this._calculateBlameWindowStart(a,b),limit:this._fileChange.type===d.DELETE?a.lastRemovedLine-a.firstRemovedLine+1:b,avatarSize:bitbucket.internal.widget.avatarSizeInPx({size:"xsmall"})}}).then(f.identity));return c.when.apply(c,e)};return b});