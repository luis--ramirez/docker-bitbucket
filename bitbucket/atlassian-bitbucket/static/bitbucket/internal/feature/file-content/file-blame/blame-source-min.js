define("bitbucket/internal/feature/file-content/file-blame/blame-source",["jquery","lodash","bitbucket/util/navbuilder","bitbucket/util/server","bitbucket/internal/util/property"],function(c,d,e,f,g){function b(a){this._fileChange=a;this._optionsPromise=c.Deferred();this._blamePromise=null}b.prototype.get=function(){this._blamePromise||(this._blamePromise=c.when(this._optionsPromise,g.getFromProvider("display.max.source.lines")).then(this._requestBlame.bind(this)));return this._blamePromise};b.prototype.initBlameOptions=
function(a){this._optionsPromise.resolve(a)};b.prototype._calculateBlameWindowStart=function(a,b){return Math.max(0,Math.floor((a.firstLine+a.lastLine)/2)-b/2)};b.prototype._requestBlame=function(a,b){return f.rest({url:e.currentRepo().browse().path(this._fileChange.path).at(this._fileChange.commitRange.untilRevision.id).build(),data:{blame:!0,noContent:!0,start:a.haveWholeFile?a.firstLine-1:this._calculateBlameWindowStart(a,b),limit:a.haveWholeFile?a.lastLine-a.firstLine+1:b,avatarSize:bitbucket.internal.widget.avatarSizeInPx({size:"xsmall"})}}).then(d.identity)};
return b});