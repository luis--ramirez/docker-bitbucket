define("bitbucket/internal/feature/file-content/stash-codemirror/search",["codemirror","jquery","bitbucket/internal/util/navigator"],function(e,l,q){function r(a,b){a="string"===typeof a?new RegExp("^"+a.replace(/[\-\[\]\/\{\}\(\)\*\+\?\.\\\^\$\|]/g,"\\$\x26"),b?"i":""):new RegExp("^(?:"+a.source+")",a.ignoreCase?"i":"");return{token:function(c){if(c.match(a))return"searching";for(;!c.eol()&&(c.next(),!c.match(a,!1)););}}}function t(){this.query=this.overlay=this.dialogEl=this.cursor=null}function f(a){return a.state.search||
(a.state.search=new t)}function m(a){var b=a.match(/^\/(.*)\/([a-z]*)$/);return b?new RegExp(b[1],-1===b[2].indexOf("i")?"":"i"):a}function k(a,b){a.operation(function(){a.removeOverlay(b.overlay);b.overlay=r(b.query,"string"===typeof b.query);a.addOverlay(b.overlay)})}function n(a,b){a.operation(function(){a.removeOverlay(b.overlay);b.overlay=null})}function g(a,b,c){(b=b&&b.trim())&&0!==b.length&&a.operation(function(){var d=f(a);b!==d.query?(d.query=m(b),d.cursor=null,k(a,d)):d.overlay||k(a,d);
h(a,c)})}function p(a,b){var c=f(a);if(c.dialogEl){var d=c.dialogEl.getElementsByClassName("search-query")[0];d.focus()}else{d=l(bitbucket.internal.feature.fileContent.codemirror.searchQuery());d.find(".search-button").on("click",function(c){h(a,l(c.target).closest(".aui-button").data("rev"))}).tooltip();var e=d.find("input")[0];e.onkeydown=function(b){c.query=void 0;var d=q.isMac(),f=String.fromCharCode(b.keyCode),d=d&&b.metaKey&&!b.ctrlKey||!d&&!b.metaKey&&b.ctrlKey;"F"!==f||!d||b.shiftKey||b.altKey?
"G"!==f||!d||b.shiftKey||b.altKey?"G"===f&&d&&b.shiftKey&&!b.altKey&&(b.preventDefault(),g(a,e.value,!0)):(b.preventDefault(),g(a,e.value)):b.preventDefault()};c.dialogEl=d[0];d={value:a.getSelection()||c.query,closeOnEnter:!1,closeOnBlur:!1,onClose:function(){n(a,c);c.dialogEl=c.cursor=null}};a.openDialog(c.dialogEl,function(b,c){c.preventDefault();g(a,b)},d)}g(a,d.value,b)}function h(a,b){a.operation(function(){var c=f(a);if(c.query&&c.dialogEl){if(!c.cursor){b&&a.execCommand("goCharLeft");var d;
d=c.query;var g=a.getCursor();d=a.getSearchCursor(d,g,"string"===typeof d);c.cursor=d}if(!c.cursor.find(b)&&(d=c.query,g=b?e.Pos(a.lastLine()):e.Pos(a.firstLine(),0),d=a.getSearchCursor(d,g,"string"===typeof d),c.cursor=d,!c.cursor.find(b)))return;a.setSelection(c.cursor.from(),c.cursor.to());c={from:c.cursor.from(),to:c.cursor.to()};(d=a.getOption("scrollLineIntoViewFunc"))?(d(c),c=a.charCoords(c.from,"local"),d=a.getScrollInfo(),(d.left>c.left||d.left+d.clientWidth<c.left)&&a.scrollTo(Math.max(0,
c.left-20),null)):a.scrollIntoView(c,100)}else p(a,b)})}e.defineOption("scrollLineIntoViewFunc",null);e.commands.find=p;e.commands.findNext=h;e.commands.findPrev=function(a){return h(a,!0)};e.commands.highlight=function(a,b){var c=f(a);0===b.length?n(a,c):(c.query=m(b),k(a,c))}});