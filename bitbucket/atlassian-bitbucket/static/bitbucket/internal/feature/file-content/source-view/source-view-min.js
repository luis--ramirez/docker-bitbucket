define("bitbucket/internal/feature/file-content/source-view","jquery lodash bitbucket/util/events bitbucket/util/navbuilder bitbucket/internal/feature/file-content/line-handle bitbucket/internal/feature/file-content/request-source bitbucket/internal/feature/file-content/source-line-info bitbucket/internal/feature/file-content/text-view bitbucket/internal/feature/file-content/text-view/attach-simple-scroll-behavior bitbucket/internal/util/deep-linking bitbucket/internal/util/function bitbucket/internal/util/object bitbucket/internal/util/property bitbucket/internal/util/shortcuts".split(" "),
function(g,f,m,q,r,t,n,k,u,h,v,p,w,l){function x(a){a=f.extend({},a);return p.freeze(a)}function y(a,b){var e=[],c=document.createElement("div");c.innerHTML=bitbucket.internal.feature.fileContent.sourceView.lineNumber();var d=c.childNodes[0];return b.eachLine(function(a){var b=d.cloneNode(!0);b.setAttribute("data-line-number",a.lineNumber);b.setAttribute("href","#"+a.lineNumber);b.appendChild(document.createTextNode(a.lineNumber));e.push([a.handles.SOURCE,"line-number",b])}).done(function(){a.operation(function(){e.forEach(function(b){a.setGutterMarker.apply(a,
b)})});var c=x(b);a.trigger("change",c);m.trigger("bitbucket.internal.feature.fileContent.sourceViewContentChanged",null,c);"INITIAL"===b.type&&(a.trigger("load",c),m.trigger("bitbucket.internal.feature.fileContent.sourceViewContentLoaded",null,c))})}function d(a,b){k.call(this,b.$container,b);var e=this;this._editor=this._createEditor();this._syntaxHighlighting(b.fileChange.path.name,a.lines[0].text,this._editor);this.registerGutter("line-number",{weight:1E3});this._$focusedLines=g([]);this.on("internal-change",
function(a){y(e,a).done(function(){b.anchor&&e._whenOpDone(function(){e.updateAnchor(b.anchor,!0)})})});this._scrollingReady=g.Deferred();this._scrollingReady.done(function(){e._modify("INITIAL",a,n.convertToLineInfos(a));e._editor.setOption("scrollLineIntoViewFunc",function(a){e.scrollHandleIntoFocus(e.getLineHandle({lineNumber:a.from.line}))})}).done(this._loadRest.bind(this,a))}p.inherits(d,k);d.defaults=k.defaults;d.prototype.init=function(){k.prototype.init.call(this);var a=this;this._options.attachScroll?
f.defer(function(){a._attachScrollBehavior().then(a._scrollingReady.resolve.bind(a._scrollingReady),a._scrollingReady.reject.bind(a._scrollingReady))}):this._scrollingReady.resolve();this._addDestroyable(l.bind("sourceViewFindPrev",function(){a._editor.execCommand("findPrev")}));this._addDestroyable(l.bind("sourceViewFindNext",function(){a._editor.execCommand("findNext")}));this._addDestroyable(l.bind("sourceViewFind",function(){a._editor.execCommand("find")}));var b=f.last(h.hashToLineNumbers(window.location.hash));
g(this._editor.getWrapperElement()).on("click contextmenu",".line-locator",function(a){var c=parseInt(g(a.target).attr("href").substring(1),10);if(a.shiftKey||a.ctrlKey||a.metaKey){a.preventDefault();var d=h.hashToLineNumbers(window.location.hash);a=h.updateSelectionRange(c,{existingLineNumbers:d,selectRange:!!a.shiftKey,lastSelected:b});location.hash=h.lineNumbersToHash(a);c=f.contains(a,c)?c:null}b=c})};d.prototype.setFocusedLines=function(a,b){this._$focusedLines=this._$focusedLines.removeClass("target").filter();
if(!f.isEmpty(a)){var e=a.map(function(a){return{lineNumber:a}}).map(this.getLineHandle).filter(f.identity);e.length&&(this._$focusedLines=g(e.map(v.dot("_handle.gutterMarkers.line-number"))).addClass("target"),b&&this.scrollHandleIntoFocus(f.first(e)))}};d.prototype.updateAnchor=function(a,b){this.setFocusedLines(h.hashToLineNumbers(a),b)};d.prototype._acceptModification=function(a,b,e,c){c=c||0;var d=this._editor;b=f.chain(b.lines).pluck("text").invoke("replace",/[\r\n]/g,"").join("\n").value();
switch(a){case "INITIAL":d.setValue(b);break;case "INSERT":d._insert(b,c);break;default:throw Error("Unrecognized change type: "+a);}e.forEach(function(a,b){var e=new r(void 0,void 0,a.lineNumber,d.getLineHandle(b+c));a._setHandle(e)})};d.prototype._attachScrollBehavior=function(){return u(this,this._editor,g(this._editor.getWrapperElement()))};d.prototype._getChangeAttributes=function(a,b){return{firstLine:b.start+1,isLastPage:b.isLastPage}};d.prototype._loadRest=function(a){function b(a,d){var e=
{start:a,limit:d-a};return t(c._options.fileChange,e).then(function(c){return c.size<e.limit&&!c.isLastPage?b(a+c.size,d).then(function(a){return{start:c.start,lines:c.lines.concat(a.lines),size:c.size+a.size,isLastPage:a.isLastPage}}):c})}function e(a,b){b&&c._modify("INSERT",b,n.convertToLineInfos(b),a)}var c=this,d=a.start,f=a.start+a.size;w.getFromProvider("display.max.source.lines").done(function(h){var k=0<d?b(0,d):g.Deferred().resolve(),l=!a.isLastPage&&f<h?b(f,h):g.Deferred().resolve();g.when(k,
l).done(function(b,d){c._editor&&(c._editor.operation(function(){e(0,b);e(c._editor.lastLine()+1,d);l.then(function(b){(b?!b.isLastPage:f>=h&&!a.isLastPage)&&c._renderCapacityReached()})}),c._$container.addClass("fully-loaded"),c.trigger("resize"))})})};d.prototype._renderCapacityReached=function(){var a=this._options.fileChange,a=g(bitbucket.internal.feature.fileContent.sourceView.capacityReachedLineWidget({rawUrl:q.currentRepo().raw().path(a.path).at(a.commitRange.untilRevision.id).build()}))[0];
this._$container.addClass("capacity-reached");this._editor.addLineWidget(this._editor.lastLine(),a,{coverGutter:!0,noHScroll:!0});this.trigger("resize")};d.prototype._editorForHandle=function(){return this._editor};return d});