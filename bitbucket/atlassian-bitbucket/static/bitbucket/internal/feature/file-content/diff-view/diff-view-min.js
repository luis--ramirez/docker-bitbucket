define("bitbucket/internal/feature/file-content/diff-view","jquery lodash bitbucket/internal/feature/comments/anchors bitbucket/internal/feature/file-content/diff-view-options bitbucket/internal/feature/file-content/diff-view-segment-types bitbucket/internal/feature/file-content/ediff/ediff-markers bitbucket/internal/feature/file-content/text-view bitbucket/internal/model/direction bitbucket/internal/util/array bitbucket/internal/util/events bitbucket/internal/util/function bitbucket/internal/util/navigator bitbucket/internal/util/object bitbucket/internal/util/shortcuts".split(" "),
function(g,f,K,B,n,L,u,r,M,m,t,C,D,E){function N(a,b){return a.concat(b).sort(function(a,b){var e=f.first(a.lines),F=f.first(b.lines),k=f.last(a.lines),d=f.last(b.lines);return e.destination-F.destination||e.source-F.source||k.destination-d.destination||k.source-d.source})}function O(a,b){var c=[];return b.eachLine(function(a){var b=a.line,d=a.handles.FROM,k=a.handles.TO,f=G.clone(),g=G.clone();f.addClass("line-number-from");g.addClass("line-number-to");f.html(a.lineType!==v?b.source:"\x26nbsp;");
g.html(a.lineType!==w?b.destination:"\x26nbsp;");c.push([d||k,"line-number-from",f[0]]);c.push([k||d,"line-number-to",g[0]]);a.handles.all.forEach(function(b){var e=P.clone();e.attr("data-file-type",b.fileType);e.attr("data-line-type",a.lineType);e.attr("data-line-number",a.lineNumber);e.html(b.lineType===v?"+":b.lineType===w?"-":"\x26nbsp;");c.push([b,"line-number-marker",e[0]])})}).done(function(){a.operation(function(){c.forEach(function(b){a.setGutterMarker.apply(a,b)})});a._$container.addClass("fully-loaded diff-api-ready");
var h=Q(b);R(a,h);"INITIAL"===b.type&&S(a,h)})}function H(a,b,c,h){var e=x[a];a!==z&&(e+=" modified");if(!0===h||!0===c)e+=" expanded";e+=b?" conflict conflict-"+b.toLowerCase():"";return e+(c?" new":"")}function T(a,b){var c="INSERT"===b.type,h=[];b.eachLine(function(b){var d=H(b.lineType,b.line.conflictMarker,c,b.attributes.expanded);b.handles.all.forEach(function(b){a.addLineClass(b,"wrap",d);c&&h.push(b)})}).done(function(){h.length&&U(a,h)})}function U(a,b){setTimeout(function(){a._editor&&a.operation(function(){f.each(b,
function(b,h){a.removeLineClass(b,"wrap","new")})})},1500)}function Q(a){a=g.extend({},a);delete a.fileChange;return D.freeze(a)}function R(a,b){a.trigger("change",b);m.trigger("bitbucket.internal.feature.fileContent.diffViewContentChanged",null,b)}function S(a,b){a.trigger("load",b);m.trigger("bitbucket.internal.feature.fileContent.diffViewContentLoaded",null,b)}function d(a,b){u.call(this,b.$container,b);this._data=a;this._scrollingReady=g.Deferred()}function I(a,b,c){var h;void 0!==c._line&&(b=
b[c._lineType][c._line].handles,h=b[c._fileType]||b.FROM||b.TO);return{anchor:c,handle:h,offset:h?a.heightAtLine(h._handle.lineNo(),"local"):0}}function J(a,b,c,h){var e=this;this._currAnimationPromise||(this._currAnimationPromise={});this._currAnimationPromise[a]&&f.invoke(this._currAnimationPromise[a],"abort");this._currAnimationPromise[a]=h.map(function(h){function d(a,b){var c=a?"addLineClass":"removeLineClass";q.operation(function(){y.forEach(function(a){q[c](a._handle,"wrap",b)})})}var y=h.handles,
q=h.editor;if(!y||!y.length)return g.Deferred().reject().promise({abort:g.noop});var n=!1,p=g.Deferred(),l=g.Deferred();p.done(l.resolve.bind(l));var A=f.once(function(){q.off("scroll",A);n||(e._$container&&e._$container.attr("data-last-updated",(new Date).getTime()),d(!0,b),p.always(d.bind(null,!1,b)),d(!0,a),l.always(d.bind(null,!1,a)),setTimeout(l.resolve.bind(l),c))});q.on("scroll",A);setTimeout(A,100);return p.promise({abort:function(){n=!0;p.resolve()}})})}var v=n.ADDED,w=n.REMOVED,z=n.CONTEXT,
G=g(bitbucket.internal.feature.fileContent.diffView.lineNumber()),P=g(bitbucket.internal.feature.fileContent.diffView.lineNumberMarker()),x={};x[v]="added";x[w]="removed";x[z]="context";D.inherits(d,u);d.defaults=u.defaults;d.contentChangeType={INITIAL:"INITIAL",INSERT:"INSERT"};d.prototype.init=function(){u.prototype.init.call(this);var a=this._options.diffViewOptions||B,b=!C.isIE()||11<=C.majorVersion();this.registerGutter("line-number-marker",{weight:1E3});this._$container.addClass("diff-type-"+
this._options.fileChange.type).toggleClass("hide-ediff",a.get("hideEdiff")).toggleClass("animated",b);g("html").toggleClass("no-cssanimations",!b);var c=this;m.trigger("bitbucket.internal.feature.fileContent.diffViewDataLoaded",null,this._data);this.on("internal-change",function(a){O(c,a).done(function(){c._selectLine(c._options.anchor);var a=c._options.fileChange.search;a&&c._highlight(a)})});this._addDestroyable(L.init({diffView:this}));this._addDestroyable(m.chainWith(g(window)).on("scroll",function(){c._expectFocusScroll||
c._invalidateFocus();c._expectFocusScroll=!1}));this._addDestroyable(m.chainWith(a).on("change",function(a){"hideEdiff"===a.key&&c._$container.toggleClass("hide-ediff",a.value)}));this.on("internal.acceptedModification",t.spread(function(a,b,c){T(this,{type:a,eachLine:function(a){return g.Deferred().resolve(f.map(c,a))}})}));this._options.attachScroll?f.defer(function(){c._attachScrollBehavior().then(c._scrollingReady.resolve.bind(c._scrollingReady),c._scrollingReady.reject.bind(c._scrollingReady))}):
this._scrollingReady.resolve();this._addDestroyable(m.chain().on("bitbucket.internal.feature.diffView.lineChange",this._selectLine.bind(this)).on("bitbucket.internal.feature.diffView.highlightSearch",this._highlight.bind(this)));this._addDestroyable(E.bind("requestSecondaryNext",this._scrollToChange.bind(this,r.DOWN)));this._addDestroyable(E.bind("requestSecondaryPrevious",this._scrollToChange.bind(this,r.UP)))};d.prototype._findNextChange=function(a,b,c){function d(a){return Boolean(a.lines[0].conflictMarker)||
e._options.combineLinkedSegments&&a&&a.type!==n.CONTEXT}var e=this,f=!1,k=-1;null==a&&(c=r.DOWN,f=!0);var g,q=b.length;for(g=0;g<q;g++){var m=c===r.DOWN?g:q-g-1,p=b[m];if(f){var l=b[m-1];if(!(!p||p.type===n.CONTEXT||Boolean(p.lines[0].conflictMarker)&&l&&Boolean(l.lines[0].conflictMarker)||e._options.combineLinkedSegments&&l&&l&&l.type!==n.CONTEXT)){k=m;break}}else p===a&&(f=!0)}if(-1<k){a=k;for(k+=1;k<b.length&&d(b[k]);)k++;return b.slice(a,k)}return null};d.prototype._selectLine=function(a){a&&
(a=this.getLineHandleFromNumber(a.no,a.type))&&(this.scrollHandleIntoFocus(a),this._markLinesFocused([{editor:this._editorForHandle(a),handles:[a]}]))};d.prototype._scrollToChange=function(a){var b=this._focusedSegments&&this._focusedSegments[0];b||(b=this._$fileToolbar.outerHeight(),b=this._$container[0].getBoundingClientRect().top-b,b=this._getFocusSegment(b));if(a=this._findNextChange(b,this._allSegments,a))this._setFocusSegment(a),this._expectFocusScroll=!0,this._focusedSegments=a};d.prototype._scrollToComment=
function(a){B.set("hideComments",!1);var b=f.chain(this._options.commentContext._containers).pluck("anchor").filter(function(a){return a instanceof K.LineAnchor}).uniq(t.invoke("getId")).value();if(a=this._findNextAnchor(a,b,this._focusedComment))this._expectFocusScroll=!0,this._focusedComment=a,a.handle?(this._highlightCommentForLine(a.handle),this.scrollHandleIntoFocus(a.handle)):this._scrollToSourcePosition(null,-this._editorInnerOffset())};d.prototype._invalidateFocus=function(){this._focusedComment=
this._focusedSegments=null};d.prototype._findNextAnchorInEditor=function(a,b,c,d){if(0===b.length)return null;b=f.sortBy(b,t.dot("_line"));if(d){var e=M.findIndex(t.propEqual(f.pick(d.anchor,"_line","_lineType","_fileType")))(b);if(-1!==e)return(c=b[e+(c===r.UP?-1:1)])&&I(a,this._internalLines,c)}var g;d?g=d.offset:(d=this._$fileToolbar.outerHeight(),d=this._$container[0].getBoundingClientRect().top-d,e=a.getScrollInfo(),g=e.top+this._options.focusPoint*e.clientHeight-d);a=b.map(I.bind(null,a,this._internalLines));
return c===r.UP?f.find(a.reverse(),function(a){return a.offset<g}):f.find(a,function(a){return a.offset>g})};d.prototype._highlightCommentForLine=function(a){this._markLineCommentsFocused([{editor:this._editorForHandle(a),handles:[a]}])};d.prototype.getLineHandleFromNumber=function(a,b){var c="TO"===b?this._internalLines[v][a]:this._internalLines[w][a];return(c=(c=c||f.find(this._internalLines[z],t.dotEq("TO"===b?"line.destination":"line.source",a)))&&c.handles)&&(c[b]||c.all[0])};d.prototype._acceptModification=
function(){throw Error("DiffView implementation must define this.");};d._combineTexts=function(a){return f.chain(a).pluck("line").pluck("line").value().join("\n")};d.prototype._getChangeAttributes=function(a,b){return{diff:b,fileChange:this._options.fileChange}};d.prototype._getLineClasses=H;d.prototype._modifyDiff=function(a,b,c){var d=[].slice.call(arguments,3);this._allSegments=N(this._allSegments||[],f.chain(b.hunks).pluck("segments").flatten(!0).value());this._modify.apply(this,[a,b,c].concat(d))};
d.prototype._markLinesFocused=f.partial(J,"line-focused","last-focus",1E3);d.prototype._markLineCommentsFocused=f.partial(J,"line-comment-focused","last-comment-focus",1E3);return d});