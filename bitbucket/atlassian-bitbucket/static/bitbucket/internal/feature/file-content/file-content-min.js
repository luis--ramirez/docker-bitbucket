define("bitbucket/internal/feature/file-content","aui jquery lodash require bitbucket/feature/files/file-handlers bitbucket/util/navbuilder bitbucket/internal/bbui/ediff/ediff bitbucket/internal/feature/comments bitbucket/internal/model/commit-range bitbucket/internal/model/content-tree-node-types bitbucket/internal/model/file-change bitbucket/internal/model/file-change-types bitbucket/internal/model/file-content-modes bitbucket/internal/model/revision bitbucket/internal/util/dom-event bitbucket/internal/util/events bitbucket/internal/util/promise".split(" "),
function(h,e,k,v,w,n,q,x,y,z,A,t,l,B,C,p,r){function D(a,b){var d=n.currentRepo().raw().path(a);b&&!b.isDefault()&&(d=d.at(b.getId()));return d.build()}function c(a,b){var d=this;this._id=b||void 0;this._containerSelector=a;p.on("bitbucket.internal.feature.commitselector.commitSelected",function(a,b,c,m){a=new B(a);this===d.untilRevisionPicker&&p.trigger("bitbucket.internal.feature.filecontent.untilRevisionChanged",d,a,c,m)});this._lastInitPromise=r.thenAbortable(e.Deferred().resolve())}function u(a,
b,d){for(var g="",f=0,c=0;c<b.length;c++)var m=b[c],g=g+(h.escapeHtml(a.substring(f,m.start))+'\x3cspan class\x3d"'+d+'"\x3e'+h.escapeHtml(a.substring(m.start,m.end))+"\x3c/span\x3e"),f=m.end;f<a.length&&(g+=h.escapeHtml(a.substring(f)));return g}c.commentMode=x.commentMode;c.diffPreset={contentMode:l.DIFF,untilRevisionPicker:!0,rawLink:!1,sourceLink:!1,modeToggle:!0,changeTypeLozenge:!1,changeModeLozenge:!1,breadcrumbs:!1,commentMode:c.commentMode.NONE};c.sourcePreset={contentMode:l.SOURCE,untilRevisionPicker:!0,
rawLink:!0,sourceLink:!1,modeToggle:!0,changeTypeLozenge:!1,changeModeLozenge:!1,breadcrumbs:!1,commentMode:c.commentMode.NONE};c.defaults={contentMode:l.SOURCE,untilRevisionPicker:!1,rawLink:!1,sourceLink:!1,modeToggle:!1,changeTypeLozenge:!1,changeModeLozenge:!1,fileIcon:!1,breadcrumbs:!1,scrollPaneSelector:void 0,commentMode:c.commentMode.REPLY_ONLY,pullRequestDiffLink:!1,toolbarWebFragmentLocationPrimary:null,toolbarWebFragmentLocationSecondary:null,asyncDiffModifications:!0,attachScroll:!0,scrollStyle:"fixed"};
c.prototype.initToolbarItems=function(a,b,d){var c=e(this._containerSelector),f=b.getCommitRange().getUntilRevision();a=e(bitbucket.internal.feature.fileContent.main(e.extend({id:this._id,preloaded:!!b.getDiff(),sourceUrl:this._options.sourceUrl||this._options.modeToggle?n.currentRepo().browse().path(b.getPath()).at(a.getDisplayId()).until(f&&f.getId()).build():"",diffUrl:this._options.modeToggle?n.currentRepo().diff(b,a,this._options.headPath,d).at(a.getDisplayId()).build():"",fileChange:b.toJSON()},
this._options)));this.$self&&this.$self.remove();this.$self=a.appendTo(c);c=this.$toolbar=a.children(".file-toolbar");this.$contentView=a.children(".content-view");this._initCommands();this.$breadcrumbs=this._options.breadcrumbs?c.find(".breadcrumbs"):null;this.$changeTypeLozenge=this._options.changeTypeLozenge?c.find(".change-type-placeholder"):null;this.$changeModeLozenge=this._options.changeModeLozenge?c.find(".change-mode-placeholder"):null;this.$viewSource=this._options.sourceLink?c.find(".source-view-link").tooltip({gravity:"ne"}):
null;this._options.pullRequestDiffLink&&c.find(".pull-request-diff-outdated-lozenge").tooltip({gravity:"ne"})};c.prototype._initCommands=function(){var a=this.$contentView,b=this.$toolbar;"self"===this._options.scrollPaneSelector&&a.addClass("scroll-x");this.untilRevisionPicker&&this.untilRevisionPicker.destroy();this.untilRevisionPicker=this._options.untilRevisionPicker?new (v("bitbucket/internal/feature/file-content/commit-selector"))({buttonEl:b.find(".until-commit-button"),id:"until-commit"}):
null;this.$viewRaw=this._options.rawLink?b.find(".raw-view-link"):null;this.$modeToggle=this._options.modeToggle?b.find(".mode-toggle").tooltip({gravity:"ne"}):null};c.prototype.initForContent=function(a,b){b=b||{};var d=a.getCommitRange().getUntilRevision();this.$viewSource&&(a.getType()===t.DELETE||a.getNodeType()===z.SUBMODULE?this.$viewSource.addClass("hidden"):this.$viewSource.attr("href",n.currentRepo().browse().path(a.getPath()).at(d&&d.getId()).build()));this.$viewRaw&&this.$viewRaw.attr("href",
D(a.getPath(),d&&d.getRevisionReference()));this.untilRevisionPicker&&this.untilRevisionPicker.init({followRenames:b.followRenames,headRevisionReference:b.headRef,itemTemplate:bitbucket.internal.feature.fileContent.commitSelectorItemAuthor,itemTitle:function(a){return h.I18n.getText("bitbucket.web.file.history.revision.clicktoview",a)},itemUrl:function(a,b){var d=n.currentRepo();if(b._mode===l.DIFF)d=d.diff(new A({commitRange:new y({untilRevision:a}),path:a.properties&&a.properties.change.path||b._path,
srcPath:a.properties&&a.properties.change.srcPath||void 0}),b._headRevisionRef,b._path,!1);else{var c={until:a.id};a.properties.change.path!==b._path.toString()&&(c.untilPath=a.properties.change.path);a.properties.change.srcPath?c.sincePath=a.properties.change.srcPath:c.autoSincePath=!1;d=d.browse().path(b._path).withParams(c)}return d.build()},mode:b.contentMode,path:b.headPath,selectedCommit:d&&d.toJSON()});this.$breadcrumbs&&this.$breadcrumbs.html(this.renderBreadCrumbs(a.getPath()));this.$changeTypeLozenge&&
this._initChangeTypeLozenge(a);this.$changeModeLozenge&&(d=this.getFileChangedModeLozenge(a))&&this.$changeModeLozenge.append(e(d).tooltip());if(this.$modeToggle)this.$modeToggle.on("click","a:not(.active,.disabled)",function(a){C.openInSameTab(a)&&(a.preventDefault(),p.trigger("bitbucket.internal.feature.filecontent.requestedModeChange",this,e(this).hasClass("mode-diff")?l.DIFF:l.SOURCE))});var c={$toolbar:this.$toolbar,$container:this.$contentView,asyncDiffModifications:this._options.asyncDiffModifications,
attachScroll:this._options.attachScroll,autoResizing:this._options.autoResizing,contentMode:this._options.contentMode,commentMode:this._options.commentMode,diffUrlBuilder:this._options.diffUrlBuilder,fileChange:a.toJSON(),isExcerpt:!!this._options.isExcerpt,lineComments:this._options.lineComments,relevantContextLines:this._options.relevantContextLines,scrollStyle:this._options.scrollStyle,anchor:b.anchor,autoSrcPath:b.autoSrcPath,commentUrlBuilder:b.commentUrlBuilder},d=e("\x3cdiv /\x3e").addClass("file-content-spinner").appendTo(this.$self);
return r.spinner(d,w._handle(c).done(k.bind(function(a,b){this.renderErrors(b);this.handler=a;this.$self.addClass(a.extraClasses);var d={handlerID:a.handlerID,displayType:this._options.contentMode,fileChange:c.fileChange,commentMode:this._options.commentMode};this._options.toolbarWebFragmentLocationPrimary&&this.$toolbar.children(".primary").append(bitbucket.internal.widget.webFragmentButtons({location:this._options.toolbarWebFragmentLocationPrimary,context:d}));this._options.toolbarWebFragmentLocationSecondary&&
this.$toolbar.children(".secondary").prepend(bitbucket.internal.widget.webFragmentButtons({location:this._options.toolbarWebFragmentLocationSecondary,context:d,isReverse:!0}))},this)),"large",{zIndex:10}).done(k.defer.bind(k,function(){p.trigger("bitbucket.internal.feature.fileContent.requestHandled",null,c)}))};c.prototype.renderErrors=function(a){this.$self.parent().find(".file-content-errors").remove();0<a.length&&this.$self.before(bitbucket.internal.feature.fileContent.errors({errors:k.map(a,
function(a){return a.message||a})}))};c.prototype.toggleToolbarDisable=function(a){this.$self.find(".file-toolbar .aui-button").toggleClass("disabled",a).prop("disabled",a).attr("aria-disabled",a)};c.prototype.renderBreadCrumbs=function(a){a=k.map(a.getComponents(),function(a){return{text:a}});return bitbucket.internal.widget.breadcrumbs.crumbs({pathComponents:a,primaryLink:"COMMIT"!==this._options.diffType||this._options.pullRequestDiffCurrent?this._options.pullRequestDiffLinkUrl:null})};c.prototype.getFileChangedModeLozenge=
function(a){var b=a.getSrcExecutable();a=a.getExecutable();var d=null;null==b&&!0===a||!1===b&&!0===a?d=!0:!0===b&&!1===a&&(d=!1);return null!==d?e(bitbucket.internal.feature.fileContent.fileChangeModeLozenge({added:d})):null};c.prototype.init=function(a,b){var d=this._initInternal.bind(this,a,b);return this._lastInitPromise=this.reset().thenAbortable(d,d)};c.prototype._initInternal=function(a,b){b=this._options=e.extend({},c.defaults,b);var d=a.getCommitRange(),g=b.headRef||d.getUntilRevision()&&
d.getUntilRevision().getRevisionReference();if(b.changeTypeLozenge&&!a.getType())throw Error("Change type is required to show the change type lozenge.");if(!d.getUntilRevision()&&(b.sourceLink||b.rawLink||b.untilRevisionPicker))throw Error("Revision info is required to show a link to the source or raw file, or a revision picker.");this.initToolbarItems(g,a,b.autoSrcPath);return this.initForContent(a,{headPath:b.headPath||a.getPath(),headRef:g,anchor:b.anchor,contentMode:b.contentMode,followRenames:b.followRenames,
autoSrcPath:b.autoSrcPath,commentUrlBuilder:b.commentUrlBuilder})};c.prototype.reset=function(){this._lastInitPromise&&this._lastInitPromise.abort();var a=this._resetInternal.bind(this);return r.thenAbortable(this._lastInitPromise.then(a,a))};c.prototype._resetInternal=function(){this.handler&&(this.handler.extraClasses&&this.$self.removeClass(this.handler.extraClasses),k.isFunction(this.handler.destroy)&&this.handler.destroy(),delete this.handler);return e.Deferred().resolve()};c.prototype.destroy=
function(){this.reset()};c.prototype._initChangeTypeLozenge=function(a){var b,d,c=a.getPath(),f=a.getSrcPath()||c;a.getType()===t.RENAME?(b=h.escapeHtml(f.getName()),d=h.escapeHtml(c.toString())):f&&(b=f.toString(),c=c.toString(),d=q.diff(q.tokenizeString(b),q.tokenizeString(c)),b=u(b,d.originalRegions,"deleted"),d=u(c,d.revisedRegions,"added"));this.$changeTypeLozenge.append(bitbucket.internal.feature.fileContent.fileChangeTypeLozenge({changeType:a.getType(),previousPathContent:b,pathContent:d}));
this.$changeTypeLozenge.find(".change-type-lozenge").tooltip({html:!0,className:"change-type-lozenge-tooltip",gravity:function(){var a=e(document).width()-e(this).offset().left-e(this).width()/2,b=e(".tipsy").outerWidth();return a>b/2+10?"n":"ne"}})};return c});