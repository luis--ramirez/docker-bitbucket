define("bitbucket/internal/feature/file-content/side-by-side-diff-view","jquery lodash bitbucket/internal/feature/file-content/diff-hunk-map bitbucket/internal/feature/file-content/diff-line-info bitbucket/internal/feature/file-content/diff-view bitbucket/internal/feature/file-content/diff-view-file-types bitbucket/internal/feature/file-content/diff-view-segment-types bitbucket/internal/feature/file-content/line-handle bitbucket/internal/feature/file-content/side-by-side-diff-view/synchronized-scroll bitbucket/internal/model/direction bitbucket/internal/util/events bitbucket/internal/util/function bitbucket/internal/util/math bitbucket/internal/util/object bitbucket/internal/util/performance bitbucket/internal/util/svg bitbucket/internal/feature/file-content/stash-codemirror/search".split(" "),
function(w,g,x,D,m,k,n,E,F,y,t,l,G,H,z,p){function h(a,b){b.combineLinkedSegments=!0;m.apply(this,arguments)}function I(a){var b=a&&a._seg;return b&&b.type!==n.CONTEXT&&0<a._numLines}function u(a){return a.conflicted||Boolean(a._seg.lines[0].conflictMarker)}function J(a){function b(a){if(!(this instanceof b))return new b(a);this._regions=[a];this.conflicted=!0;this.classesInfo={lineType:a._seg.type,conflictMarker:a._seg.lines[0].conflictMarker};this.getOffsetTop=function(){return this._regions[0].getOffsetTop()};
this.getHeight=function(){return g.chain(this._regions).invoke("getHeight").reduce(G.add).value()};this.push=function(a){this._regions.push(a)}}return a.reduce(function(a,c){var e=a.previous,f=e&&g.some(e,u),q=g.some(c,u);if(q&&f)return g.forEach(e,function(a,b){a.push(c[b])}),a;q&&(c=g.map(c,b));a.previous=c;a.regions.push(c);return a},{previous:null,regions:[]}).regions.filter(function(a){return a.some(l.or(I,u))})}function K(a,b,d){function c(a,b){if(a.region.classesInfo)return a.region.classesInfo;
var c=a.region._lineInfos[0],d=b.region._lineInfos[0];return c?{conflictMarker:c.line.conflictMarker,lineType:c.lineType}:{conflictMarker:null,lineType:d.lineType}}var e,f=b.offsetHeight||parseFloat((e=window.getComputedStyle(b)).height);e=b.offsetWidth||parseFloat(e.width);var q=e+1,r=.4*e,A=.6*e;for(a=a.map(function(a){return a.map(function(a){var b=a.getOffsetTop(),c=b+a.getHeight();return{region:a,top:b+.5,bottom:c+.5,above:0>b,inside:0<c&&b<f,below:c>f}})}).filter(function(a){return a.some(l.dot("inside"))||
a.some(l.dot("above"))&&a.some(l.dot("below"))}).map(l.spread(function(a,b){var e=(new p.PathBuilder).moveTo(-1,a.top).curve(r,a.top,A,b.top,q,b.top).lineTo(q,b.bottom).curve(A,b.bottom,r,a.bottom,-1,a.bottom).close().build(),f;f=c(a,b);var h=c(b,a);f=d(f.lineType,f.conflictMarker,!1)+" "+d(h.lineType,h.conflictMarker,!1);f=g.unique(f.split(/\s+/)).join(" ");return{path:e,extraClasses:f}}));b.hasChildNodes();)b.removeChild(b.firstChild);e=g.once(function(a){var b=[{"class":"removed",offset:"0%"},
{"class":"removed",offset:"30%"},{"class":"added",offset:"70%"},{"class":"added",offset:"100%"}],b=g.map(b,p.createElement.bind(p,"stop"));return g.reduce(b,function(a,b){a.appendChild(b);return a},p.createElement("linearGradient",{id:a}))});a=a.map(function(a){var b={"class":"segment-connector "+a.extraClasses,d:a.path};a=a.extraClasses;-1!==a.indexOf("added")&&-1!==a.indexOf("removed")&&(b.fill="url(#added-and-removed-svg-gradient)");return p.createElement("path",b)}).concat(e("added-and-removed-svg-gradient")).reduce(function(a,
b){a.appendChild(b);return a},document.createDocumentFragment());b.appendChild(a)}var B=n.ADDED,L=n.CONTEXT,C=n.REMOVED;H.inherits(h,m);h.defaults=m.defaults;h.prototype.init=function(){var a=this;if(this._$container){this._$container.addClass("side-by-side-diff");this._$container.append(bitbucket.internal.feature.fileContent.sideBySideDiffView.layout());this.fromEditorEl=this._$container.find(".side-by-side-diff-editor-from");this.toEditorEl=this._$container.find(".side-by-side-diff-editor-to");
var b=this._options.commentContext&&this._options.commentContext.getGutterId();b&&this.registerGutter(b,{weight:100});this.registerGutter("line-number-from",{weight:200,fileType:k.FROM});this.registerGutter("line-number-to",{weight:200,fileType:k.TO});this._fromEditor=this._createEditor({gutterFilter:function(a){return!a.fileType||a.fileType===k.FROM}},this.fromEditorEl);this._toEditor=this._createEditor({gutterFilter:function(a){return!a.fileType||a.fileType===k.TO}},this.toEditorEl);var b=l.dot("hunks.0.segments.0")(this._data.diff),
d=l.dot("hunks.0.segments.0.lines.0.line")(this._data.diff),c=l.dot("hunks.0.segments.1.lines.0.line")(this._data.diff),e=b.type===B?c:d,f=l.dot("srcPath.name")(this._options.fileChange)?this._options.fileChange.srcPath.name:this._options.fileChange.path.name;this._syntaxHighlighting(f,e,this._fromEditor);this._syntaxHighlighting(this._options.fileChange.path.name,b.type===C&&c?c:d,this._toEditor);this._lineInfos=D.convertToLineInfos(this._data.diff,this._options);this._scrollingReady.always(function(){a._modifyDiff("INITIAL",
a._data.diff,a._lineInfos);a._setupFindScrollIntoViewFunction(a._fromEditor,k.FROM);a._setupFindScrollIntoViewFunction(a._toEditor,k.TO)});this.on("internal-load",function(){this._syncScrollingInfo&&(this.setupHunkmaps(this._syncScrollingInfo.linkedFromAndToRegions),this._initSegmentLinking(this._syncScrollingInfo.linkedFromAndToRegions),this.on("internal-change",function r(){this._whenOpDone(this._scrollEditorToFirstChange.bind(this));this.off("internal-change",r)}))});b=a.refresh.bind(a);t.on("bitbucket.internal.feature.sidebar.expandEnd",
b);t.on("bitbucket.internal.feature.sidebar.collapseEnd",b);t.on("bitbucket.internal.feature.commit.difftree.collapseAnimationFinished",b);m.prototype.init.call(this)}};h.prototype.destroy=function(){m.prototype.destroy.call(this);this._toEditor=this._fromEditor=null};h.prototype._acceptModification=function(a,b,d){function c(a,b,c){var d;g.forEach(a,function(a,e){var g=b.getLineHandle(e);a._setHandle(c,new E(c,a.lineType,a.lineNumber,g));d&&d.segment!==a.segment&&d.lineType===n.CONTEXT&&a.lineType===
n.CONTEXT&&b.addLineClass(g,"wrap","paired-with-change");d=a})}if("INITIAL"!==a)throw Error("Unrecognized change type: "+a);a=g.filter(d,function(a){return a.lineType!==B});d=g.filter(d,function(a){return a.lineType!==C});this._fromEditor.setValue(m._combineTexts(a));this._toEditor.setValue(m._combineTexts(d));c(a,this._fromEditor,k.FROM);c(d,this._toEditor,k.TO)};var v={};v[k.FROM]="_fromEditor";v[k.TO]="_toEditor";h.prototype._editorForHandle=function(a){return this[v[a.fileType]]};h.prototype._getFocusSegment=
function(a){var b=this._fromEditor.getScrollInfo().clientHeight*this._options.focusPoint;if(a>b)return null;var d=b+this._syncScrollingInfo.combinedScrollable._getScrollTop()-a+1,d=Math.ceil(d);return(g.find(this._syncScrollingInfo.combinedRegions,function(a){return a._getOffset()<=d&&a._getOffset()+a.getHeight()>d})||g.last(this._syncScrollingInfo.combinedRegions))._seg};h.prototype._setFocusSegment=function(a){function b(a,b){return g.compact(a.map(function(a){return a.handles[b]}))}var d=g.filter(this._syncScrollingInfo.combinedRegions,
function(b){return g.contains(a,b._seg)}),c=this._fromEditor.getScrollInfo().clientHeight*this._options.focusPoint;this._scrollToSourcePosition(null,d[0]._getOffset()-c);var e=g.chain(d).pluck("_linkedRegions").flatten().pluck("_lineInfos").flatten().uniq().value(),f=this;this.operation(function(){f._markLinesFocused([{editor:f._fromEditor,handles:b(e,k.FROM)},{editor:f._toEditor,handles:b(e,k.TO)}])})};h.prototype._findNextAnchor=function(a,b,d){var c=g.groupBy(b,l.dot("_fileType"));b=c.FROM&&this._findNextAnchorInEditor(this._fromEditor,
c.FROM,a,d);d=c.TO&&this._findNextAnchorInEditor(this._toEditor,c.TO,a,d);return b&&d?a===y.UP&&d.offset<b.offset||a===y.DOWN&&d.offset>=b.offset?b:d:b||d||null};h.prototype.setupHunkmaps=function(a){function b(a,b,c){var f=a.getScrollInfo(),h=Math.max(0,f.height*c-f.clientHeight*e);a=g.findIndex(b,function(a){var b=f.top+a.getOffsetTop();return b<=h&&b+a.getHeight()>h});b=b[a];a=d._syncScrollingInfo.combinedRegions[a];c=d._syncScrollingInfo.combinedScrollable.getScrollInfo();b=(h-(f.top+b.getOffsetTop()))/
b.getHeight();b=c.top+a.getOffsetTop()+b*a.getHeight();d._scrollToSourcePosition(0,b)}var d=this,c=a.map(g.first);a=a.map(g.last);var e=this._options.focusPoint,f=new x(this.fromEditorEl,c,{scrollToFn:g.partial(b,this._fromEditor,c)}),h=new x(this.toEditorEl,a,{scrollToFn:g.partial(b,this._toEditor,a)}),c=g.debounce(g.invoke.bind(g,[f,h],"redraw"),100);this._addDestroyable(f);this._addDestroyable(h);this.on("widgetAdded",c);this.on("widgetChanged",c);this.on("widgetCleared",c);this.on("resize",c);
this._fromEditor.on("scroll",function(a){f.diffScrolled(a.getScrollInfo())});this._toEditor.on("scroll",function(a){h.diffScrolled(a.getScrollInfo())});this._addDestroyable(function(){d._fromEditor=null;d._toEditor=null})};h.prototype._attachScrollBehavior=function(){var a=this,b=this._fromEditor,d=this._toEditor,c=this._lineInfos;if(!b)return w.Deferred().reject();var e=F.setupScrolling(this,c,b,d,{includeCombinedScrollable:!0,focusHeightFraction:a._options.focusPoint});this._syncScrollingInfo=e;
var f=a._$container.children(".diff-editor, .segment-connector-column"),g,b=this._requestWindowScrolls({scrollSizing:function(){return e.combinedScrollable.getScrollInfo()},scroll:function(a,b){null!=b&&e.combinedScrollable.scrollToNative(null,b)},resize:function(b,c){g!==c&&(g=c,e.combinedScrollable.setClientHeight(c),f.height(c),a.refresh())},onSizeChange:function(b){a.on("resize",b)}});this._addDestroyable(e);return b};h.prototype._initSegmentLinking=function(a){var b=w(".segment-connector-column"),
d=p.createElement("svg",{});b.append(d);var c=K.bind(null,J(a),d,this._getLineClasses);a=z.enqueueCapped(requestAnimationFrame,function(){d.setAttribute("height",b.height());d.setAttribute("width",b.width());c()});var e=z.enqueueCapped(requestAnimationFrame,c);this.on("sync-scroll",c);this.on("widgetAdded",e);this.on("widgetChanged",e);this.on("widgetCleared",e);this.on("resize",a);a()};h.prototype.scrollHandleIntoFocus=function(a){var b=this._editorForHandle(a),d=b.getScrollInfo(),c=a.fileType===
k.FROM?0:1;a.lineType===L&&a.fileType===k.TO&&(b=this._fromEditor,c=0);var e=g.findIndex(this._syncScrollingInfo.linkedFromAndToRegions,function(b){return b[c]._startIndex<=a.lineNumber&&b[c]._endIndex>a.lineNumber}),f=this._syncScrollingInfo.linkedFromAndToRegions[e][c],e=this._syncScrollingInfo.combinedRegions[e],f=b.heightAtLine(a.lineNumber)-b.heightAtLine(f._startIndex),f=this._syncScrollingInfo.combinedScrollable.getScrollInfo().top+e.getOffsetTop()+f;this._scrollToFocusedOffset(f,d,b)};h.prototype._setupFindScrollIntoViewFunction=
function(a,b){var d=this;a.setOption("scrollLineIntoViewFunc",function(a){d.scrollHandleIntoFocus(d.getLineHandleFromNumber(a.from.line,b))})};h.prototype._scrollEditorToFirstChange=function(){var a=this._findNextChange(null,this._allSegments);a&&this._setFocusSegment(a)};return h});