define("bitbucket/internal/feature/tasks/model/task","aui backbone backbone-brace lodash bitbucket/util/events bitbucket/util/navbuilder bitbucket/internal/feature/tasks/model/task-state bitbucket/internal/model/stash-user".split(" "),function(f,h,l,k,m,n,b,p){function d(a){return a&&"bitbucket.internal.feature.pull-request-tasks."+a}var q=n.rest().addPathComponents("tasks"),g=l.Model.extend({namedAttributes:{id:"number",anchor:null,state:"string",author:p,createdDate:"number",text:"string",html:"string",
properties:null,permittedOperations:null,lastState:"string",pendingSync:"boolean",pullRequestId:"number",repositoryId:"number"},defaults:{state:b.OPEN,text:"",pendingSync:!1,permittedOperations:{}},url:function(){var a=q;this.isNew()||(a=a.addPathComponents(this.getId()));return a.build()},initialize:function(){this.getState()===b.OPEN&&this.isNew()&&this._triggerTaskEvent(this.eventNameForState(this.getState()));this.on("destroy",this._onDestroy);this.on("sync",this._triggerTaskEvent.bind(this,d("saved")))},
_onDestroy:function(){this.isNew()&&this.changeState(b.DELETED)},nextState:function(){return b.Transitions[this.getState()]},eventNameForState:function(a){switch(a){case b.OPEN:return this.isNew()?d("created"):d("reopened");case b.RESOLVED:return d("resolved");case b.DELETED:return d("deleted");default:return d("default")}},transitionToNextState:function(){return this._updateState(this.nextState())},changeState:function(a){this.set({state:a,lastState:this.getState()},{local:!0});this._triggerTaskEvent(this.eventNameForState(a))},
_updateState:function(a){var e=this.getState(),b=this.eventNameForState(a),c=this;this.changeState(a);return this.save().done(function(){c.getState()!==a&&(b=c.eventNameForState(c.getState()),c._triggerTaskEvent(b))}).fail(function(){c.set({state:e,lastState:a});c._triggerTaskEvent(d("failed-transition"))})},updateText:function(a){var e=this,b=this.getText(),c=g.sanitiseText(a);this.setText(c);return(this.save()||h.$.Deferred().reject(this.validationError)).fail(function(){""!==c&&e.setText(b)})},
validate:function(a,e){if(g.sanitiseText(a.text)!==a.text)return f.I18n.getText("bitbucket.web.tasks.error.invalidText");if(""===a.text)return f.I18n.getText("bitbucket.web.tasks.error.missingText")},sync:function(a,e,b){this.setPendingSync(!0);e=h.sync(a,e,k.extend(b,{statusCode:{404:function(c,b,e,d){c=(c=d&&d.errors&&d.errors.length&&d.errors[0])&&c.message;"create"!==a&&(c=f.I18n.getText("bitbucket.web.tasks.noSuchTask",bitbucket.internal.util.productName()));return{title:f.I18n.getText("bitbucket.web.tasks.noSuchTask.title"),
message:c,shouldReload:!0,fallbackUrl:void 0}}}}));e.always(this.setPendingSync.bind(this,!1));return e},_triggerTaskEvent:function(a,b){b===this&&(b={});m.trigger(a,null,k.extend({task:this.toJSON()},b))}},{Anchor:{COMMENT:"COMMENT"}});g.sanitiseText=function(a){return a.trim().replace(/\s+/gm," ")};return g});