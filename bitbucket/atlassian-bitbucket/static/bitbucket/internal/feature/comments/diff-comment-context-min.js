define("bitbucket/internal/feature/comments/diff-comment-context","jquery lodash bitbucket/internal/feature/comments/anchors bitbucket/internal/feature/comments/comment-collection bitbucket/internal/feature/comments/comment-context bitbucket/internal/feature/comments/diff-comment-container bitbucket/internal/feature/file-content/diff-view-file-types bitbucket/internal/feature/file-content/diff-view-options bitbucket/internal/feature/file-content/diff-view-segment-types bitbucket/internal/model/direction bitbucket/internal/util/events bitbucket/internal/util/function bitbucket/internal/util/shortcuts bitbucket/internal/util/time-i18n-mappings".split(" "),
function(g,b,u,v,l,q,r,w,m,t,n,k,p,x){var y=u.LineAnchor;return l.extend({events:{"click .add-comment-trigger":"addCommentClicked","mouseenter .dummy-comment-trigger, .add-comment-trigger":"initTooltip"},initialize:function(){this._destroyables=[];b.bindAll(this,"onDiffChange","onFileCommentsResized","onCommentContainerDestroyed","onDiffViewOptionsChange");this._initFileCommentButton=this._initFileCommentButton.bind(this,this.options.$toolbar);this._destroyables.push(n.chain().once("bitbucket.internal.feature.fileContent.requestHandled",
this._initFileCommentButton));this.setDiffView(this.options.diffView);this._dvOptions=this.options.diffViewOptions||w;this._commentsById=this.options.lineComments&&b.indexBy(this.options.lineComments,k.dot("id"));this.$el.toggleClass("commentable",this.options.allowCommenting);this.toggleComments(!this._dvOptions.get("hideComments"));this._dvOptions.on("change",this.onDiffViewOptionsChange);n.on("bitbucket.internal.comment.commentContainerDestroyed",this.onCommentContainerDestroyed);this.renderFileComments();
l.prototype.initialize.apply(this,arguments);var a=this._getFileCommentContainer();a&&this._initializeFileCommentContainer(a)},_initFileCommentButton:function(a){a.find(".add-file-comment-trigger").on("click",this.addFileCommentClicked.bind(this)).tooltip({gravity:"ne"})},_initializeFileCommentContainer:function(a){a.on("resize",this.onFileCommentsResized)},_getFileCommentContainer:function(){var a=this.options.anchor.getId();if(this.includesContainer(a))return this._containers[a]},_registerContainer:function(a,
c,b){this._containers[a]=new q({anchor:b,context:this,el:c,name:a,urlBuilder:this.options.urlBuilder});return this._containers[a]},addFileCommentClicked:function(){this.forceShowingComments();this.addCommentContainerForFile().openNewCommentForm()},initTooltip:function(a){a=g(a.currentTarget);a.data("tooltip-inited")||(a.data("tooltip-inited",!0),a.tooltip({gravity:"w",delayOut:200}).trigger("mouseenter"))},addCommentClicked:function(a){a.preventDefault();this.forceShowingComments();a=g(a.target).closest(".line");
this.addCommentContainerForLine(a).openNewCommentForm()},forceShowingComments:function(){this._dvOptions.get("hideComments")&&this._dvOptions.set("hideComments",!1)},addCommentContainerForFile:function(){var a=this._getFileCommentContainer();if(a)return a;a=g(bitbucket.internal.feature.comments(this.options.anchor.toJSON()));a.appendTo(this.$(".file-comments"));this.registerContainer(a[0],this.options.anchor);a=this._getFileCommentContainer();this._initializeFileCommentContainer(a);return a},addCommentContainerForLine:function(a,
c){var b=this.getLineAnchor(a),d=a.lineType?a:this.diffView.getLineHandle(a),f=b.getId(),h=this.options.urlBuilder;this.includesContainer(f)||(this._containers[f]=new q({anchor:b,collection:c?new v(c,{anchor:b,urlBuilder:h}):void 0,context:this,lineHandle:d,name:f,showComments:!this._dvOptions.get("hideComments"),urlBuilder:h}));return this._containers[f]},destroy:function(a){a||(this.diffView&&this.diffView.off("change",this.onDiffChange),this.$el.removeClass("commentable"),this._dvOptions.off("change",
this.onDiffViewOptionsChange),this._dvOptions=null,n.off("bitbucket.internal.comment.commentContainerDestroyed",this.onCommentContainerDestroyed),b.invoke(this._destroyables,"destroy"),this._destroyables=null);l.prototype.destroy.apply(this,arguments)},findContainerElements:function(){return this.$(".line .comment-box, .file-comments \x3e .comment-container")},getAnchor:function(a){return g(a).closest(".file-comments").length?this.options.anchor:this.getLineAnchor(g(a).closest(".line"))},getGutterId:function(){return this.options.allowCommenting?
"add-comment-trigger":null},getLineAnchor:function(a){a=a.lineType?a:this.diffView.getLineHandle(a);return new y(this.options.anchor,a.lineType,a.lineNumber,a.fileType)},renderFileComments:function(){var a=this.options.anchor.toJSON().commitRange;this.$el.prepend(bitbucket.internal.feature.fileComments({comments:this.options.fileComments,commitRange:a,customMapping:x.commentEditedAge}))},addAnchoredComments:function(){function a(a){return b.chain(a).filter(function(a){return!(!a.anchor||!a.anchor.line)}).groupBy(function(a){return(a.anchor.fileType||
"")+a.anchor.line}).value()}var c=this,e=this.diffView,d=this.options.lineComments;d&&d[0]&&!d[0].anchor||b.forEach(a(d),function(a){var b=a[0].anchor;(b=e.getLineHandle({fileType:b.fileType,lineType:b.lineType,lineNumber:b.line}))&&c.addCommentContainerForLine(b,a)})},onFileCommentsResized:function(){this.trigger("fileCommentsResized")},onDiffChange:function(a){if("INITIAL"===a.type||"INSERT"===a.type){"INITIAL"===a.type&&this.addAnchoredComments();var c=this.diffView,e=this;a.eachLine(function(d){var f=
d.line,h;h=!d.attributes.expanded&&"MARKER"!==d.line.conflictMarker&&e.options.allowCommenting&&"INITIAL"===a.type?bitbucket.internal.feature.addCommentTrigger():bitbucket.internal.feature.dummyCommentTrigger({relevantContextLines:e.options.relevantContextLines});d.handles.FROM&&c.setGutterMarker(d.handles.FROM,e.getGutterId(),g(h)[0]);d.handles.TO&&d.handles.FROM!==d.handles.TO&&c.setGutterMarker(d.handles.TO,e.getGutterId(),g(h)[0]);f.commentIds&&(f=b.chain(f.commentIds).map(k.lookup(e._commentsById)).filter(b.identity).value(),
f.length&&e.addCommentContainerForLine(d.handles.FROM||d.handles.TO,f));e.unrestoredDrafts.length&&"INITIAL"===a.type&&b.chain(d.handles).values().compact().uniq().forEach(e.restoreDraftsForLine.bind(e)).value()})}},onCommentContainerDestroyed:function(a){var c=this._getFileCommentContainer();c&&a===c.$el&&b.defer(this.onFileCommentsResized.bind(this))},onDiffViewOptionsChange:function(a){"hideComments"===a.key&&this.toggleComments(!a.value)},restoreDraftsForLine:function(a){var b=g.extend({line:a.lineNumber,
lineType:a.lineType},{fileType:a.fileType}),b=this.getUnrestoredDraftsForLine(b);b.length&&(a=this.addCommentContainerForLine(a),this._restoreDraftsToContainer(a,b),a.destroyIfEmpty())},_restoreDraftsToContainer:function(a,c){b.forEach(c,a.restoreDraftComment.bind(a));this.unrestoredDrafts=b.difference(this.unrestoredDrafts,c)},restoreDrafts:function(){var a=this;this.options.allowCommenting||(this.unrestoredDrafts=b.filter(this.unrestoredDrafts,function(b){return(b.id||b.parent)&&(a.$el.is(".file-comment-activity")||
b.anchor.line)}));this.restoreDraftFileComments()},restoreDraftFileComments:function(){var a=b.reject(this.unrestoredDrafts,k.dot("anchor.line"));a.length&&this._restoreDraftsToContainer(this.addCommentContainerForFile(),a)},getUnrestoredDraftsForLine:function(a){var c=b.compose(k.partialRight(b.omit,"path","srcPath","pullRequest"),this.unifyAnchorFileTypes);a=b.isEqual.bind(b,c(a));c=b.compose(a,c,k.dot("anchor"));return b.filter(this.unrestoredDrafts,c)},unifyAnchorFileTypes:function(a){var c=a.lineType===
m.ADDED&&a.fileType===r.TO;return(a.lineType===m.CONTEXT||a.lineType===m.REMOVED)&&a.fileType===r.FROM||c?b.omit(a,"fileType"):a},clarifyAmbiguousDraftProps:function(a){a=l.prototype.clarifyAmbiguousDraftProps.call(this,a);a.anchor=this.unifyAnchorFileTypes(a.anchor);return a},setDiffView:function(a){this.diffView&&this.diffView.off("internal-change",this.onDiffChange);if(this.diffView=a)this.diffView.on("internal-change",this.onDiffChange),this._destroyables.push({destroy:p.bind("addFileComment",
this.addFileCommentClicked.bind(this))}),this._destroyables.push({destroy:p.bind("requestTertiaryNext",a._scrollToComment.bind(a,t.DOWN))}),this._destroyables.push({destroy:p.bind("requestTertiaryPrevious",a._scrollToComment.bind(a,t.UP))})},toggleComments:function(a){this.$el.toggleClass("hide-comments",!a);b.invoke(this._containers,"toggleComment",a)}})});