define("bitbucket/internal/feature/permission/permission-table","aui aui/flag jquery lodash bitbucket/internal/feature/permission/multi-selector bitbucket/internal/model/page-state bitbucket/internal/util/ajax bitbucket/internal/util/function bitbucket/internal/util/warn-before-unload exports".split(" "),function(f,q,h,g,u,l,m,r,t,v){function w(a,b){return{getMembers:function(c){return m.rest({url:a[b+"s"]().build(),type:"GET",data:c})},getNonMembers:function(c){return m.rest({url:a[b+"s"]().none().build(),
type:"GET",data:c})},setPermission:function(c,e){return m.rest({url:a[b+"s"]().withParams({permission:c,name:e}).build(),type:"PUT",statusCode:{400:!1,403:!1,404:!1,409:!1}})},removePermissions:function(c){return m.rest({url:a[b+"s"]().withParams({name:c}).build(),type:"DELETE",statusCode:{400:!1,403:!1,404:!1,409:!1}})}}}function n(a){this._delegate=a;this._pageReceived=g.bind(this._pageReceived,this);this.clear()}function d(a,b,c,e,k,x){this._entityType=e;"user"===this._entityType?(this._text=d.userText,
this._rowTemplate=bitbucket.internal.feature.permission.userPermissionRow,this._isEntityCurrentUser=function(a){return l.getCurrentUser()&&a.name===l.getCurrentUser().getName()}):(this._text=d.groupText,this._rowTemplate=bitbucket.internal.feature.permission.groupPermissionRow,this._isEntityCurrentUser=r.constant(!1));this._dataSource=w(b,this._entityType);this._permissions=g.pluck(c,"name");this._initialPermission=this._permissions[this._permissions.length-1];this._permissionNames=g.pluck(c,"i18nName");
this._currentUserHighestPerm=k;this._pageSize=50;this._addedEntities=[];this.opts=x||{};this._wireComponents(a);this._initHelpDialogs();this._initAddMultiSelector();this._initRows();this._initLoadMoreButton();this.refresh()}n.prototype.clear=function(){this._nextPageStart=0};n.prototype.nextPage=function(a){return this._delegate.getNonMembers({start:this._nextPageStart,filter:a,avatarSize:bitbucket.internal.widget.avatarSizeInPx({size:"xsmall"})}).done(this._pageReceived)};n.prototype._pageReceived=
function(a){this._nextPageStart=a.nextPageStart||a.start+a.size};d.text={entityList:{buttonLoadMoreText:f.I18n.getText("bitbucket.web.permission.table.load.more"),deletedUser:f.I18n.getText("bitbucket.web.permission.table.deleted.user.tooltip")},pendingModification:f.I18n.getText("bitbucket.web.pending.request",bitbucket.internal.util.productName()),cantGrantHigherPerms:function(a){return f.I18n.getText("bitbucket.web.permission.table.cantgranthigher.tooltip",a)},inheritedPerm:f.I18n.getText("bitbucket.web.permission.table.inheritedperm.tooltip")};
d.userText=h.extend(!0,{inactiveEntity:function(a){return f.I18n.getText("bitbucket.web.permission.table.inactive.user",a)},cantRevokeHigherPerms:function(a){return f.I18n.getText("bitbucket.web.permission.table.cantrevokehigheruser.tooltip",a)},cantGrantSelfHigherPerms:function(a){return f.I18n.getText("bitbucket.web.permission.table.cantgrantselfhigher.tooltip",a)},implicitPerm:f.I18n.getText("bitbucket.web.permission.table.basePerm.user.tooltip"),noMoreItemsText:f.I18n.getText("bitbucket.web.permission.table.users.none.added")},
d.text);d.groupText=h.extend(!0,{inactiveEntity:function(a){return f.I18n.getText("bitbucket.web.permission.table.invisible.group",a)},cantRevokeHigherPerms:function(a){return f.I18n.getText("bitbucket.web.permission.table.cantrevokehighergroup.tooltip",a)},implicitPerm:f.I18n.getText("bitbucket.web.permission.table.basePerm.group.tooltip"),noMoreItemsText:f.I18n.getText("bitbucket.web.permission.table.groups.none.added")},d.text);d.prototype._wireComponents=function(a){this._$container=h(a);this._$tbody=
this._$container.find("tbody");this._$noResults=this._$container.find(".no-results-row");this._$loadMore=this._$container.find(".load-more");this._$spinner=h(this._$loadMore).parent().append('\x3cdiv class\x3d"permissions-spinner" /\x3e').find(".permissions-spinner")};d.prototype._getModalItem=function(a){return{content:h(bitbucket.internal.feature.permission.permissionModalItem({entity:a,isUser:"user"===this._entityType,inactiveText:this._text.inactiveEntity(a.name)})),id:a.name}};d.prototype._initAddMultiSelector=
function(){var a=this;this._multiSelector=new u({el:this._$container.find(".permission-multi-selector-container")[0],entityType:this._entityType,add:function(b){return a._dataSource.setPermission(b.permission,g.pluck(b.entities,"name")).done(function(){a._addedEntities.push.apply(a._addedEntities,g.map(b.entities,function(c){var e={permission:b.permission};e[a._entityType]=c;return e}));q({type:"success",close:"auto",body:bitbucket.internal.feature.permission.flag.added({name:b.entities[0].name,entityType:a._entityType,
count:b.entities.length})});a.refresh()})},dataSource:new n(this._dataSource)})};d.prototype._updateErrors=function(a,b){var c=a.closest("tr"),e=c.attr("data-entity-id");c.closest("tbody").find(".permission-error").remove();return b.fail(function(a,b,d,g){if(g&&g.errors){var f=c.children("td").length;h.each(g.errors,function(a){c.after(bitbucket.internal.feature.permission.errorPermissionRow({entityId:e,numRows:f,message:g.errors[a].message}))})}})};d.prototype._spinWhilePending=function(a,b){if(b&&
"pending"===b.state()){a.closest("tr").find(":checkbox").prop("disabled",!0);var c=h('\x3cdiv class\x3d"spinner" /\x3e');c.insertAfter(a);a.addClass("hidden");c.spin("small");b.always(function(){a.removeClass("hidden");c.spinStop().remove()})}};d.prototype._getAllCheckboxes=function(a){return a.parent().parent().find(":checkbox")};d.prototype._getCheckboxStates=function(a){return h.map(a,function(a){return{checked:h(a).prop("checked"),disabled:h(a).prop("disabled")}})};d.prototype._restoreCheckboxStates=
function(a,b){h.each(b,function(b,e){h(a.get(b)).prop("checked",e.checked).prop("disabled",e.disabled).toggleClass("disabled",e.disabled)})};d.prototype._setChecked=function(a,b,c){this._restoreCheckboxStates(this._getAllCheckboxes(a),c);b.prop("checked",!1).prop("title","");b=a.parent().nextAll().children(":checkbox").prop("checked",!0).prop("disabled",!0).addClass("disabled").prop("title",this._text.inheritedPerm);a.prop("title",b.length?"":this._text.implicitPerm);a.prop("checked",!0).prop("disabled",
!b.length).toggleClass("disabled",!b.length);var e=a.closest("[data-entity-id]").attr("data-entity-id"),k=this._entityType;g.each(this._addedEntities,function(b){b[k].name===e&&(b.permission=a.val())})};d.prototype._initHelpDialogs=function(){var a=this._$container.find("th.permission-column \x3e .aui-icon.aui-iconfont-help"),b=new f.InlineDialog(a,f.id("help-dialog"),function(a,e,k){a.empty().append(h(e).parent().find(".permission-column-desc").clone());k();b.refresh()},{offsetX:-100,onHover:!0,
gravity:"s"})};d.prototype._initRows=function(){var a=this;this._$tbody.on("change",":checkbox",function(){var b=h(this),c=b.parent(),e=c.next(),c=c.parent().attr("data-entity-id"),k,d;if(this.checked){for(;e.length&&!e.children(":checked").length;)e=e.next();k=e.children(":checkbox");d=b;k.prop("value");e=this.value}else k=b,d=e.children(":checkbox"),e=d.prop("value");var g=[];e&&g.push(a._dataSource.setPermission(e,c));var f=a._getCheckboxStates(a._getAllCheckboxes(d)),c=h.when.apply(h,g);a._spinWhilePending(b,
c);a._updateErrors(b,c);c.done(function(){a._setChecked(d,k,f)}).fail(function(b,c,e,g){a._setChecked(k,d,f)});t(c,a._text.pendingModification)}).on("click",".delete-button",function(b){var c=h(this),e=c.parents("tr").first(),k=e.attr("data-entity-id"),d=e.find(":checkbox"),f=a._getCheckboxStates(d),p=a._dataSource.removePermissions(k);a._spinWhilePending(c,p);a._updateErrors(c,p);p.done(function(){a._numLoaded--;a._addedEntities=g.filter(a._addedEntities,function(b){var c=b[a._entityType].name===
k;c&&!b.loaded&&a._numLoaded++;return!c});if(!e.siblings().length&&!a._$loadMore.is(":visible")){var b=a._$noResults.find("div");b.css("opacity",0);a._$noResults.show();b.animate({opacity:1},500)}q({type:"success",close:"auto",body:bitbucket.internal.feature.permission.flag.deleted({name:k,entityType:a._entityType})});e.remove()}).fail(function(){a._restoreCheckboxStates(d,f)});t(p,a._text.pendingModification);b.preventDefault();return!1})};d.prototype._initLoadMoreButton=function(a){var b=this;this._$loadMore.click(function(a){b._loadItems();
a.preventDefault()})};d.prototype._renderRow=function(a,b,c,e){var d=this,f=g.isUndefined(b)?d._permissions.length-1:g.indexOf(this._permissions,b),h=g.indexOf(this._permissions,c),p=f<h;c=d._permissionNames[f];return this._rowTemplate({entity:a,entityPermissions:g.map(this._permissions,function(c,e,f){var l=d._permissionNames[e],m=c===b,n=e<h;f=g.any(f.slice(0,e),r.eq(b));return{name:c,granted:m,inherited:f,privileged:n,tooltip:p?"":n&&!m?d._isEntityCurrentUser(a)?d._text.cantGrantSelfHigherPerms(l):
d._text.cantGrantHigherPerms(l):f?d._text.inheritedPerm:e===d._permissions.length-1?d._text.implicitPerm:""}}),tooltip:p?d._text.cantRevokeHigherPerms(c):"",showRemovePermsButton:e||f>=h,linkToEntities:l.getCurrentUser()&&l.getCurrentUser().getIsAdmin()})};d.prototype._loadItems=function(){var a=this;this._$spinner.spin("small");this._numLoaded||(a._$tbody.empty(),a._$noResults.hide());!this._numLoaded&&this._addedEntities.length&&a._$tbody.append(g.chain(this._addedEntities).sortBy(function(b){return b[a._entityType].name}).reduce(function(b,
c){return b+a._renderRow(c[a._entityType],c.permission,a._currentUserHighestPerm,!0)},"").value());a._dataSource.getMembers({start:a._numLoaded,limit:a._pageSize,avatarSize:bitbucket.internal.widget.avatarSizeInPx({size:"xsmall"})}).done(function(b){a.opts.preProcessMembers&&(b=a.opts.preProcessMembers(b,a._entityType));a._$spinner.spinStop();a._$loadMore.toggleClass("hidden disabled",b.isLastPage);b.values.length?a._$noResults.hide():b.start||a._addedEntities.length||a._$noResults.show();a._numLoaded+=
b.values.length;var c=g.chain(a._addedEntities).pluck(a._entityType).pluck("name").invoke("toLowerCase").value();b=g.chain(b.values).filter(function(b){b=h.inArray(b[a._entityType].name.toLowerCase(),c);-1!==b&&(a._addedEntities[b].loaded=!0);return-1===b}).value();b.length&&a._$tbody.append(g.reduce(b,function(b,c){return b+a._renderRow(c[a._entityType],c.permission,a._currentUserHighestPerm)},""));a._$tbody.find(".deleted-user .display-name").tooltip({title:function(){return a._text.entityList.deletedUser},
gravity:"w"});a._$noResults.find("div").show()})};d.prototype.refresh=function(a){a&&(this._addedEntities=[]);this._numLoaded=0;g.each(this._addedEntities,function(a){a.loaded=!1});this._loadItems()};v.initialise=function(a,b,c,e){return g.map(["user","group"],function(f){return new d("#"+f+"-permissions-table",a,b,f,c,e)})}});