define("bitbucket/internal/feature/compare","aui bacon jquery lodash bitbucket/util/navbuilder bitbucket/internal/feature/pull-request/pull-request-create bitbucket/internal/feature/repository/source-target-selector bitbucket/internal/model/repository bitbucket/internal/model/revision-reference bitbucket/internal/util/bacon bitbucket/internal/util/dom-event bitbucket/internal/util/events bitbucket/internal/util/function bitbucket/internal/util/history bitbucket/internal/util/shortcuts bitbucket/internal/widget/keyboard-shortcuts exports".split(" "),
function(n,p,k,h,u,A,B,r,v,l,w,C,t,x,D,E,F){function G(a,c,e,b){var f=b.sourceRepo,d=u.project(b.sourceRepo.getProject()).repo(b.sourceRepo),d=c||a?d.createPullRequest():d.compare()[e]();b.target&&!b.target.isDefault()&&(d=d.targetBranch(b.target.getId()));b.source&&!b.source.isDefault()&&(d=d.sourceBranch(b.source.getId()));var d=d.targetRepo(b.targetRepo.getId()),d=d.build(),g;g=b.targetRepo?u.project(b.targetRepo.getProject()).repo(b.targetRepo).createPullRequest().build():"";return{url:d,formURL:g,
title:c||a?n.I18n.getText("bitbucket.web.pullrequest.create.windowtitle",f.getProject().getName(),f.getName()):n.I18n.getText("bitbucket.web.repository.compare.page.title",f.getProject().getName(),f.getName()),selector:b,prShowing:c,tab:e}}function y(a){return a.branchesSelected()}function H(a){var c=function(){return{source:a.getSourceBranch(),sourceRepo:a.getSourceRepository(),target:a.getTargetBranch(),targetRepo:a.getTargetRepository()}},e="source.repositoryChanged source.revisionRefChanged source.revisionRefUnselected target.repositoryChanged target.revisionRefChanged target.revisionRefUnselected".split(" ").map(function(b){return l.events("bitbucket.internal.feature.repository.sourceTargetSelector."+
b)});return p.mergeAll.apply(p,e).map(c).toProperty(c())}function I(a){function c(a){a.addClass("active-tab").siblings().removeClass("active-tab");b();a=e[a.attr("data-module-key")];b=a.init();E.resetContexts();return a.pathSegment}var e=h.reduce(a,function(a,b){a["compare-"+b.pathSegment+"-tab"]=b;return a},{}),b=k.noop;a=c(q.find(".active-tab"));return q.asEventStream("click","a").filter(w.openInSameTab).doAction(w.preventDefault()).flatMap(function(a){a=k(a.currentTarget).parent();return a.is(".active-tab")?
p.never():p.constant(c(a))}).toProperty(a)}function J(a,c){function e(){f();b.empty();f=c(b)}var b=k("#compare-content"),f=k.noop,d=l.events("bitbucket.internal.feature.repository.sourceTargetSelector.source.revisionRefChanged").merge(l.events("bitbucket.internal.feature.repository.sourceTargetSelector.target.revisionRefChanged")).map(t.constant(a)).filter(y).onValue(e);y(a)&&e();return function(){f();d()}}function K(){D.bind("requestBranchCompareSectionHandler",function(a){a=parseInt(String.fromCharCode(a.which),
10);q.children().eq(a-1).children("a").click()});l.events("bitbucket.internal.widget.keyboard-shortcuts.register-contexts").onValue(function(a){a.enableContext("branch-compare")})}function L(a,c,e,b,f,d){var g=k(".aui-page-header-main h2"),m=d.find(".expanded-branches"),M=d.find("#sourceRepo"),h=d.find("#pull-request-description");a.doAction(b,"toggleClass","hidden").doAction(m,"toggleClass","hidden").not().doAction(f.toggleClass.bind(f,"hidden")).doAction(function(a){a=a?["pullRequest","compare"]:
["compare","pullRequest"];C.trigger("bitbucket.internal.feature.compare.form.state",null,{oldForm:a[0],newForm:a[1]})}).doAction(function(a){(a?M:h).focus()}).map(function(a){return a&&!e?n.I18n.getText("bitbucket.web.repository.compare.header.title"):n.I18n.getText("bitbucket.web.pullrequest.create.title")}).onValue(g.text.bind(g));a.combine(c,function(a,b){return{prShowing:a,selector:b}}).onValue(function(a){a.prShowing?(a=bitbucket.internal.feature.compare.collapsedBranches({sourceBranch:a.selector.source.toJSON(),
targetBranch:a.selector.target.toJSON()}),k(a).insertBefore(m)):d.find(".collapsed-branches").remove()})}function N(a){return k(document).asEventStream("click",".show-hide-button").map(function(c){return k(c.target).is(a)}).toProperty(a.hasClass("hidden"))}function O(a,c){var e=a.debounce(0).map(function(a){var b={canCreate:!1};a.source&&a.target?a.source.isTag()||a.target.isTag()?b.reason="TAG_SELECTED":a.source.isEqual(a.target)?b.reason="REFS_EQUAL":b.canCreate=!0:b.reason="REF_UNSELECTED";return b}).skipDuplicates().toProperty(),
b=c.find("#show-create-pr-button"),f=c.find(".refs-equal-warning"),d=c.find(".tags-warning"),g=c.find(".aui-tabs"),e=e.doAction(function(a){f.toggleClass("hidden","REFS_EQUAL"!==a.reason);d.toggleClass("hidden","TAG_SELECTED"!==a.reason);g.toggleClass("hidden","REF_UNSELECTED"===a.reason)}).map(t.dot("canCreate"));e.doAction(b,"enable").not().onValue(b,"attr","aria-disabled");return e}function P(a,c,e,b){var f=e.find("#cancel-button"),d=l.events("bitbucket.internal.history.popstate").filter(t.not(t.dotEq("state",
null)));return p.combineAsArray(a,d).sampledBy(d).filter(function(a){return 0!==h.keys(a[1].state).length}).map(function(a){var b=a[0];return{prShowing:b[0],tab:b[1],selector:b[2],oldState:a[1].state}}).onValue(function(a){a.prShowing!==a.oldState.prShowing&&(a.prShowing?f.click():c.click());a.tab!==a.oldState.tab&&e.find("li.menu-item[data-module-key\x3dcompare-"+a.oldState.tab+"-tab] \x3e a").click();a=a.oldState.selector;b.refSelectors.source.setSelection({repository:a.sourceRepo?new r(a.sourceRepo):
null,branch:a.source?new v(a.source):null});b.refSelectors.target.setSelection({repository:a.targetRepo?new r(a.targetRepo):null,branch:a.target?new v(a.target):null})})}function z(a){var c=h.clone(a);c.selector={};h.each(a.selector,function(a,b){c.selector[b]=a?a.toJSON():null});return c}var q=k(".tabs-menu");F.onReady=function(a,c){var e=k(a);c.prCreateMode=!!c.prCreateMode;var b=h.map(c.additionalPreloadRepositories,t.create(r)),f=new B(e.find(".compare-selector"),new r(c.sourceRepositoryJson),
new r(c.targetRepositoryJson),b,{showTags:!0}),d=I(h.map(c.tabs,function(a,b){return{pathSegment:b,init:h.partial(J,f,h.partial(a,f))}})),g=H(f),m=O(g,e),l=e.find(".pull-request-create-form"),b=e.find("#show-create-pr-button"),n=e.find("form.aui");A.init(l,c.submittedReviewers||[],g,d,m);m=N(b);L(m,g,c.prCreateMode,b,l,e);var q=!0,d=p.combineAsArray(m,d,g);P(d,b,e,f);d.map(Function.apply.bind(h.partial(G,c.prCreateMode)),null).onValue(function(a){n.attr("action",a.formURL);q?(x.initialState(z(a)),
q=!1):-1===window.location.href.indexOf(a.url)&&x.pushState(z(a),a.title,a.url)});K()}});