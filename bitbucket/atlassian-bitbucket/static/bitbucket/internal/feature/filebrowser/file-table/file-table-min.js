define("bitbucket/internal/feature/filebrowser/file-table","aui jquery lodash bitbucket/util/navbuilder bitbucket/internal/feature/filebrowser/file-table-history bitbucket/internal/model/page-state bitbucket/internal/model/path bitbucket/internal/model/revision-reference bitbucket/internal/util/ajax bitbucket/internal/util/client-storage bitbucket/internal/util/dom-event bitbucket/internal/util/events bitbucket/internal/util/history exports".split(" "),function(w,g,B,p,C,e,l,x,y,m,D,h,q,t){function E(a,
b,c,d){return(c=c&&c.getParent())?u(a,b,c,d):""}function z(){var a=window.location.href,b=q.state();return A(b&&b.prevUrl?b.prevUrl:document.referrer,a)}function v(a){return"string"!==typeof a?"/":a+("/"!==a.charAt(a.length-1)?"/":"")}function A(a,b){var c,d;if(!a||!b||"string"!==typeof a||"string"!==typeof b)return null;a=a.split("?")[0];b=b.split("?")[0];if(a.length<b.length)return null;b=v(b);c=p.currentRepo().build();d=new RegExp(c.substring(0,c.lastIndexOf("/"))+"/.*?/");b=v(c)+b.split(d)[1];
a=v(c)+a.split(d)[1];(c=a.split(b)[1])&&0<=c.indexOf("/")&&(c=c.substring(0,c.indexOf("/")));return c?decodeURIComponent(c):null}function u(a,b,c,d){a=p.project(a).repo(b).browse().path(c.toJSON());return!d||("function"===typeof d.isDefault?d.isDefault():d.isDefault)?a.build():a.at(d.id||d.getId()).build()}function k(a,b,c){C.init();var d=this;this.currentPath=a;this.currentRevisionRef=b;this.maxDirectoryChildren=c;h.on("bitbucket.internal.history.changestate",function(a){var b=a.state;!b||b.path===
d.currentPath.toString()&&b.revisionRef.revisionName===d.currentRevisionRef.getId()||(b.children||b.errors?d.dataReceived(b):(a=x.fromCommit({id:b.revisionRef.latestCommit}),d.requestData(e.getProject().getKey(),e.getRepository().getSlug(),new l(b.path),a,{popState:!0}).done(function(a){d.dataReceived(g.extend(b,a))}).fail(function(a,c,f,e){d.dataReceived(g.extend(b,e))})))});q.initialState({path:a.toString(),revisionRef:b.toJSON()});h.on("bitbucket.internal.page.*.revisionRefChanged",function(a){d.currentRevisionRef.getId()!==
a.getId()&&d.requestData(e.getProject().getKey(),e.getRepository().getSlug(),d.currentPath,a)});h.on("bitbucket.internal.page.*.urlChanged",function(a){d.requestDataAtUrl(a)})}function F(a){a.revisionRef=new x(a.revisionRef);a.path=new l(a.path);a&&a.children&&(a.parent=new l(a.parent),B.each(a.children.values,function(b){b.name=b.path.name;b.path=l.fromParentAndName(a.path,b.name);b.url=b.url||u(e.getProject().getKey(),e.getRepository().getSlug(),b.path,a.revisionRef)}))}function n(a){var b=this;
this.fileTableSelector=a;this.$spinner=g("\x3cdiv class\x3d'spinner'/\x3e").hide().insertAfter(this.fileTableSelector);g(document).on("click",a+" .folder a",function(a){D.openInSameTab(a)&&(h.trigger("bitbucket.internal.feature.filetable.urlChanged",b,g(this).attr("href")),a.preventDefault())});h.on("bitbucket.internal.feature.filetable.showSpinner",function(){g(".filebrowser-banner").empty();g(b.fileTableSelector).empty();b.$spinner.show().spin("large")});h.on("bitbucket.internal.feature.filetable.dataReceived",
function(a){var d=z();b.update(a);h.trigger("bitbucket.internal.feature.filetable.hideSpinner",this);if(a&&a.children){var f;if(f=1===a.children.size){f=window.location.href;var e=m.getSessionItem("stash-history-back-url"),l=m.getSessionItem("stash-history-forward-url");f=!(e===f||l===f)}f&&a.children.values[0].type===r&&(a=g(b.fileTableSelector+" .folder:not(.browse-up) a")[0],a.textContent!==d&&a.click());d=q.state();m.setSessionItem("stash-history-back-url",d&&d.prevUrl||document.referrer);m.setSessionItem("stash-history-forward-url",
m.getSessionItem("stash-history-current-url"));m.setSessionItem("stash-history-current-url",window.location.href)}});h.on("bitbucket.internal.feature.filetable.hideSpinner",function(){b.$spinner.spinStop().hide()});this.focusInitialRow()}k.prototype.reload=function(){this.requestData(e.getProject().getKey(),e.getRepository().getSlug(),this.currentPath,this.currentRevisionRef)};k.prototype.dataReceived=function(a){F(a);a.path&&(this.currentPath=a.path);a.revisionRef&&this.currentRevisionRef.getId()!==
a.revisionRef.getId()&&(this.currentRevisionRef=a.revisionRef,h.trigger("bitbucket.internal.feature.filetable.revisionRefChanged",this,a.revisionRef));h.trigger("bitbucket.internal.feature.filetable.dataReceived",this,a)};k.prototype.requestData=function(a,b,c,d,f){return this.requestDataAtUrl(u(a,b,c,d),d,f)};var G=/(?:\/?([^?#]*))([?][^#]*)?/;k.prototype.parsePathUrl=function(a){if(a&&0<a.length){var b=e.getProject().getKey(),c=e.getRepository().getSlug(),d=p.project(b).repo(c).browse().build();
a=a.substring(a.indexOf(d)+d.length);if((a=a.match(G))&&2<=a.length)return b={projectKey:b,repoSlug:c,path:decodeURIComponent(a[1])},3===a.length&&(b.query=a[2]),b}return{}};k.prototype.requestDataAtUrl=function(a,b,c){var d=this,f=d.parsePathUrl(a),e=new l(f.path),m=p.parseQuery(f.query?f.query:"").replaceParam("limit",this.maxDirectoryChildren).toString(),e=p.rest().project(f.projectKey).repo(f.repoSlug).browse().path(e).build()+m;c=c||{};var k=function(e){c.popState||(e=d.data=g.extend({},e,{revisionRef:(b||
d.currentRevisionRef).toJSON(),projectKey:f.projectKey,repoSlug:f.repoSlug,path:f.path,prevUrl:window.location.href}),window.location.href.substring(window.location.href.indexOf(window.location.pathname))!==a?q.pushState(e,"",a):d.dataReceived(e))};h.trigger("bitbucket.internal.feature.filetable.showSpinner",this,!0);return y.rest({url:e,statusCode:y.ignore404WithinRepository()}).done(function(a){k(a)}).fail(function(a,b,c,d){k(d)})};var r="DIRECTORY";n.prototype.getSortedFiles=function(a){return a&&
0!==a.length?a.sort(function(a,c){return a.type===r^c.type===r?a.type===r?-1:1:a.path.getName().toLowerCase().localeCompare(c.path.getName().toLowerCase())||(a.path.getName()===c.path.getName()?0:a.path.getName()<c.path.getName()?-1:1)}):a};n.prototype.update=function(a){if(a&&a.children){var b=a.children.values,c=!a.children.isLastPage;c||(b=this.getSortedFiles(b));var d=b.length;g(".filebrowser-banner").replaceWith(bitbucket.internal.feature.filebrowser.warnings({isTruncated:c,message:w.I18n.getText("bitbucket.web.file.browser.toomanyfiles",
""+d)}));b=g(bitbucket.internal.feature.filebrowser.fileTable({files:b,parentDirectoryUrl:E(e.getProject().getKey(),e.getRepository().getSlug(),new l(a.path),a.revisionRef)}));g(this.fileTableSelector).replaceWith(b);this.focusInitialRow()}else this.handleError(a);h.trigger("bitbucket.internal.feature.filetable.pathChanged",this,a.path.toJSON())};n.prototype.handleError=function(a){a=a&&a.errors&&a.errors.length?a.errors[0].message:w.I18n.getText("bitbucket.web.ajax.unexpected.error");a=bitbucket.internal.feature.filebrowser.fileTable({files:[],
isError:!0,errorMessage:a});g(this.fileTableSelector).replaceWith(g(a))};n.prototype.getParentDirSelector=function(){return this.fileTableSelector+" tr.browse-up a"};n.prototype.focusInitialRow=function(){var a=g(this.fileTableSelector).find("tr.file-row").not(".browse-up"),b,c=z();c&&(b=a.filter(function(){return g(this).find("a").text()===c}));b&&b.length?b.addClass("focused-file"):a.first().length&&a.first().addClass("focused-file")};t.FileTableView=n;t.FileTable=k;t.getChildPathDifferenceBetweenUrls=
A});