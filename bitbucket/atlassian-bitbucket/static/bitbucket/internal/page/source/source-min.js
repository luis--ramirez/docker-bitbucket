define("bitbucket/internal/page/source","aui jquery lodash bitbucket/util/navbuilder bitbucket/internal/feature/commit/commit-badge bitbucket/internal/feature/file-content bitbucket/internal/layout/page-scrolling-manager bitbucket/internal/model/commit-range bitbucket/internal/model/file-change bitbucket/internal/model/file-change-types bitbucket/internal/model/file-content-modes bitbucket/internal/model/page-state bitbucket/internal/model/path bitbucket/internal/model/revision bitbucket/internal/model/revision-reference bitbucket/internal/util/ajax bitbucket/internal/util/events bitbucket/internal/util/function bitbucket/internal/util/history exports".split(" "),
function(J,g,l,x,K,y,L,r,t,u,f,m,h,k,M,v,e,N,z,A){function E(a){return{mode:a.mode?a.mode:f.SOURCE,path:new h(a.path),headRef:new M(a.headRef),untilRevision:a.untilRevision?new k(a.untilRevision):null,untilPath:a.untilPath?new h(a.untilPath):null,sincePath:a.sincePath?new h(a.sincePath):null,autoSincePath:a.autoSincePath||!1,explicitUntil:a.explicitUntil}}function B(a){return{mode:a.mode,path:a.path.toString(),headRef:a.headRef.toJSON(),untilRevision:a.untilRevision?a.untilRevision.toJSON():null,
untilPath:a.untilPath?a.untilPath.toJSON():null,sincePath:a.sincePath?a.sincePath.toJSON():null,autoSincePath:a.autoSincePath,explicitUntil:a.explicitUntil}}function F(a){var b=a.lastIndexOf("#");return-1===b?a:a.substring(0,b)}function n(){c&&(c.abort(),c=null);!b.untilRevision||b.autoSincePath&&b.mode===f.DIFF?(p.reset(),b.untilRevision?c=w(b.untilPath,b.untilRevision.getRevisionReference()):(c=w(b.path,b.headRef),c.done(function(a){b.untilRevision=a})),c.always(function(){c=null}).done(function(a){b.autoSincePath=
!1;a=a&&a.getProperties()&&a.getProperties().change.srcPath;b.sincePath=a?new h(a):null;n()})):(O(),P(b.untilRevision))}function O(){var a=b.path.toString(),G=b.untilPath.toString(),d=b.sincePath&&b.sincePath.toString(),d=Boolean(b.mode===f.DIFF&&d&&G!==d),e={toolbarWebFragmentLocationPrimary:"bitbucket.file-content."+b.mode+".toolbar.primary",toolbarWebFragmentLocationSecondary:"bitbucket.file-content."+b.mode+".toolbar.secondary",followRenames:H,autoSrcPath:b.autoSincePath},a={anchor:window.location.hash.substr(1)||
void 0,headPath:b.path,headRef:b.headRef,relevantContextLines:I,breadcrumbs:a!==G||void 0,changeTypeLozenge:d||void 0},a=g.extend(e,y[b.mode+"Preset"],a),c;d&&(c=b.untilPath.isSameDirectory(b.sincePath)?u.RENAME:u.MOVE);d=b.mode===f.DIFF||b.explicitUntil?b.untilRevision:new k({id:b.headRef.getId(),displayId:b.headRef.getDisplayId(),author:{name:"Unknown"},authorTimestamp:NaN,parents:[],properties:{change:{srcPath:null}}});d=new r({untilRevision:d,sinceRevision:d.hasParents()?d.getParents()[0]:void 0});
c=new t({commitRange:d,path:b.untilPath,repository:m.getRepository(),srcPath:b.sincePath,type:c});return p.init(c,a)}function P(a){g(".branch-selector-toolbar .commit-badge-container").empty().append(K.create(a.toJSON(),m.getRepository().toJSON())).fadeIn("fast")}function C(a){var b=x.currentRepo();if(a.mode===f.DIFF)var d=new t({commitRange:new r({untilRevision:a.untilRevision}),path:a.untilPath,srcPath:a.sincePath,repository:m.getRepository()}),b=b.diff(d,a.headRef,a.path);else b=b.browse().path(a.path),
a.untilRevision&&(b=b.until(a.untilRevision.getId(),a.untilPath)),a.headRef.isDefault()||(b=b.at(a.headRef.getId()));z.pushState(B(a),null,b.build())}function w(b,c){var d=x.rest().currentRepo().commits().withParams({avatarSize:bitbucket.internal.widget.avatarSizeInPx({size:"xsmall"}),followRenames:!0,limit:1,path:b.toString(),until:c.getLatestCommit()}),f=v.rest({url:d.build()}),g=f.then(function(b){return b.values[0]?new k(b.values[0]):v.rest({url:d.withParams({followRenames:!1}).build()}).then(function(b){return new k(b.values[0]||
{id:c.getLatestCommit(),displayId:c.getDisplayId(),author:{name:"Unknown"},authorTimestamp:NaN,parents:[],properties:{change:{srcPath:null}}})})});e.trigger("bitbucket.internal.page.source.requestedRevisionData");return g.promise(f)}var H,I,D,q,b,p,c=null;A.onReady=function(a,c,d,h,k,m,r,t,u,v,w){L.acceptScrollForwardingRequests();H=u;I=t;q=window.location.href;b=E({mode:f.DIFF===k?f.DIFF:f.SOURCE,path:a,headRef:c,untilRevision:d,untilPath:h,sincePath:w,autoSincePath:v,explicitUntil:!!x.parse(window.location).getQueryParamValue("until")});
p=new y(m,r,y.sourcePreset);e.on("bitbucket.internal.history.changestate",function(a){if(a.state){a=E(a.state);var c=b.untilRevision?b.untilRevision.getId():null,d=a.untilRevision?a.untilRevision.getId():null,f=b.headRef.getId()!==a.headRef.getId(),c=a.path.toString()!==b.path.toString()||f||d!==c||a.mode!==b.mode||a.autoSincePath!==b.autoSincePath||a.explicitUntil!==b.explicitUntil;b=a;f&&e.trigger("bitbucket.internal.page.source.revisionRefChanged",null,b.headRef);c&&n();q=window.location.href}else l.endsWith(F(window.location.href),
F(q))||window.location.reload()});e.on("bitbucket.internal.feature.fileContent.optionsChanged",function(a){l.contains(["hideComments","hideEdiff"],a.key)||n()});e.on("bitbucket.internal.layout.branch.revisionRefChanged",function(a){b.headRef!==a&&C(l.extend({},b,{headRef:a,untilRevision:null,mode:f.SOURCE,explicitUntil:!1}))});e.on("bitbucket.internal.feature.*.untilRevisionChanged",function(a,c,d){b.explicitUntil&&b.untilRevision.getId()===a.getId()||C(l.extend({},b,{untilRevision:a,untilPath:c,
sincePath:d,autoSincePath:!1,explicitUntil:!0}))});e.on("bitbucket.internal.feature.*.requestedModeChange",function(a){b.mode!==a&&C(l.extend({},b,{mode:a}))});e.on("bitbucket.internal.feature.sourceview.onError",function(a){g(".branch-selector-toolbar .commit-badge-container").fadeOut("fast")});e.on("bitbucket.internal.layout.*.urlChanged",function(a){window.location=a});e.on("bitbucket.internal.feature.*.urlChanged",function(a){window.location=a});e.on("bitbucket.internal.widget.branchselector.dialogShown",
function(){D=!0});e.on("bitbucket.internal.widget.branchselector.dialogHidden",function(){D=!1});g(window).on("hashchange",function(){q=window.location.href;z.replaceState(B(b),null,q);var a=window.location.hash.substr(1)||void 0;N.dotX("handler.updateAnchor",a)(p);e.trigger("bitbucket.internal.page.source.anchorChanged",null,a)});e.on("bitbucket.internal.widget.keyboard-shortcuts.register-contexts",function(a){a.enableContext("sourceview");a.enableContext("diff-view")});e.on("bitbucket.internal.keyboard.shortcuts.requestOpenParentHandler",
function(a){(this.execute?this:J.whenIType(a)).execute(function(){if(!D){var a=g(".breadcrumbs").find("a:last");a.length&&a.click()}})});A.pause=function(){p.reset()};A.resume=function(){n()};z.initialState(B(b));n()}});