define("bitbucket/internal/widget/markup-preview","aui jquery lodash bitbucket/util/navbuilder bitbucket/internal/util/ajax bitbucket/internal/util/dom-event bitbucket/internal/util/events bitbucket/internal/util/navigator bitbucket/internal/util/syntax-highlight".split(" "),function(d,f,b,l,m,g,c,n,p){function a(a){this.init.apply(this,arguments)}var e="ctrl+shift+p";c.on("bitbucket.internal.keyboard.shortcuts.requestPreviewComment",function(a){e=a;this.unbind()});c.addLocalEventMixin(a.prototype);
a.prototype.init=function(a){b.bindAll(this,"togglePreview","updatePreview","refreshPreview","hidePreview","cancelPreview");var q=n.isMac?e.replace(/ctrl/i,"meta"):e;this.$editor=f(a);this.$textarea=this.$editor.find("textarea");this.$previewButton=this.$editor.find(".markup-preview-button");this.$previewPanel=this.$editor.find(".markup-preview");this._destroyables=[];var h=this.$textarea.add(this.$previewButton);h.on("keydown",[q],this.togglePreview);this._destroyables.push({destroy:function(){h.off("keydown",
this.togglePreview)}.bind(this)});this._destroyables.push(c.chainWith(this.$previewButton).on("click",this.togglePreview));this._destroyables.push(c.chainWith(this.$previewPanel).on("click",g.filterByTarget(":not(a, a \x3e img)",this.togglePreview)));this._destroyables.push(c.chainWith(this.$textarea).on("input",b.debounce(this.refreshPreview,100)));this._destroyables.push({destroy:this.cancelPreview});var k=this;this.$previewButton.tooltip({gravity:function(){return f.fn.tipsy.autoNS.apply(this,
arguments)+"e"},title:function(){return k.isPreviewing()?d.I18n.getText("bitbucket.web.diffview.comments.button.exit.preview"):k.$previewButton.attr("data-preview-tooltip")}})};a.prototype.isPreviewing=function(){return this.$editor.hasClass("previewing")};a.prototype.togglePreview=g.preventDefault(function(){this.isPreviewing()?this.cancelPreview():this.showPreview()});a.prototype.showPreview=function(){this.$editor.addClass("previewing");this.$textarea.parent().spin("medium");this.$previewButton.text(d.I18n.getText("bitbucket.web.markup.edit"));
this._request&&this._request.abort();this._request=m.rest({type:"POST",url:r(),data:this.$textarea.val(),dataType:"json"}).done(this.updatePreview).fail(function(a,b){"abort"!==b&&this.hidePreview()}.bind(this)).always(function(){this.$textarea.parent().spinStop();this._request=null}.bind(this))};a.prototype.refreshPreview=function(){this.isPreviewing()&&this.showPreview()};a.prototype.updatePreview=function(a){this.$previewPanel.html(a.html);this.$previewPanel.find("a").attr("target","_blank");this.$editor.addClass("loaded");
this.$previewButton.focus();p.container(this.$previewPanel);a=this.trigger.bind(this,"resize");b.defer(a);this.$previewPanel.imagesLoaded(a)};a.prototype.cancelPreview=function(){this._request&&this._request.abort();this.hidePreview()};a.prototype.hidePreview=function(){this.$editor.removeClass("previewing loaded");this.$previewButton.text(d.I18n.getText("bitbucket.web.markup.preview"));this.$textarea.focus();this.trigger("resize")};a.prototype.destroy=function(){b.invoke(this._destroyables,"destroy")};
var r=b.once(function(){return l.rest().markup().preview().build()});return a});