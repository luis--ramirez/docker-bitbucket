define("bitbucket/internal/widget/markup-attachments","aui jquery lodash bitbucket/util/navbuilder bitbucket/internal/model/page-state bitbucket/internal/util/events bitbucket/internal/util/feature-enabled bitbucket/internal/util/function bitbucket/internal/util/promise bitbucket/internal/util/property bitbucket/internal/util/text bitbucket/internal/widget/drag-drop-file-uploader bitbucket/internal/widget/inline-error-dialog".split(" "),function(g,h,e,n,p,k,q,c,r,t,u,f,v){function b(a){if(!b.isSupported())throw Error("MarkupAttachments requires DragDropFileUploader support");
this.init.apply(this,arguments)}function w(a,d,b){var c=a.links.attachment;a=c&&c.href||a.links.self.href;d=(d||"").replace(/[^\w\.\-]/g,"");d=0===d.length||"."===e.first(d)?"upload"+d:d;a=a.replace(/([\(\)])/g,"\\$1");return"["+(f.typeFilters.image.test(b)?"!["+d+"]("+a+")":d)+"]("+a+")"}function x(a){return a+(a.length&&"\n"!==e.last(a)?"\n":"")}var l;q.getFromProvider("attachments").done(function(a){l=a});var m;t.getFromProvider("attachment.upload.max.size").done(function(a){m=a});b.isEnabled=
function(){return l};b.isSupported=f.isSupported;b._editorClass="markup-attachments";b.prototype.init=function(a){this.$editor=h(a);this.$textarea=this.$editor.find("textarea");this.$uploadButton=this.$editor.find(".markup-attachments-button");this._destroyables=[];e.bindAll(this,"handleUpload","handleAttachment","handleFailures","hideErrors");this.$editor.addClass(b._editorClass);this.dragDropFileUploader=new f(this.$editor,{url:y,fieldName:"files",uploadButton:this.$uploadButton,fileSizeLimit:m});
this._destroyables.push(this.dragDropFileUploader);this._destroyables.push(k.chainWith(this.dragDropFileUploader).on({filesSelected:this.hideErrors,invalidFiles:c.partialRight(e.forEach,c.binary(this.handleFailures)),uploadStarted:this.handleUpload}));a=u.formatSizeInBytes(this.dragDropFileUploader.options.fileSizeLimit);this.errorDialog=new v(this.$uploadButton,{title:function(a){return g.I18n.getText("bitbucket.web.markup.attachments.error.title",a.length)},subtitle:g.I18n.getText("bitbucket.web.markup.attachments.error.subtitle",
a)});this._destroyables.push(this.errorDialog);this._destroyables.push(k.chainWith(this.$editor).on("resize",this.errorDialog.refresh));a=h(aui.icons.icon({icon:"success",useIconFont:!0})).appendTo(this.$uploadButton);this._destroyables.push({destroy:a.remove.bind(a)});this.rollingSpinner=r.rollingSpinner(this.$uploadButton)};b.prototype.handleUpload=function(a,d){this.rollingSpinner.add(a);var b=e.compose(c.partialRight(e.forEach,e.partial(this.handleAttachment,d)),c.dot("attachments"));a.done(b).fail(function(a,
b){this.handleFailures([d],b,{statusCode:a.status})}.bind(this))};b.prototype.handleAttachment=function(a,b){if(b.errors){var c=e.first(b.errors);this.handleFailures([a],c.exceptionName,{message:c.message})}else this.$textarea.val(x(this.$textarea.val())+w(b,a.name,a.type)).trigger("input").focus()};b.prototype.handleFailures=function(a,b,c){"abort"===b||"error"===b&&500!==c.statusCode?this.hideErrors():(e.pluck(a,"name").forEach(this.errorDialog.add),this.errorDialog.show())};b.prototype.hideErrors=
function(){this.errorDialog.hide()};b.prototype.destroy=function(){this.$editor.removeClass(b._editorClass);e.invoke(this._destroyables,"destroy")};var y=function(){return p.getRepository()&&n.currentRepo().attachments().build()};return b});