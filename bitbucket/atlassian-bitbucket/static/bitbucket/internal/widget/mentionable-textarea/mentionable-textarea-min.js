define("bitbucket/internal/widget/mentionable-textarea","aui aui/progressive-dataset backbone jquery lodash textarea-caret-position xregexp bitbucket/util/navbuilder bitbucket/internal/model/page-state bitbucket/internal/model/stash-user bitbucket/internal/util/events bitbucket/internal/util/function bitbucket/internal/util/markup bitbucket/internal/widget/autocomplete-dialog".split(" "),function(f,n,p,g,e,q,l,r,h,t,m,u,v,w){function d(){this.init.apply(this,arguments)}d.defaults={$container:g(document.body),
selector:"textarea",dialogId:"mention-autocomplete-dialog"};d.prototype.init=function(a){this.options&&this.reset();this.options=g.extend({},d.defaults,a);e.bindAll(this,"onKeyDown","onKeyPress","onPaste","onDocumentClick","updateDialogAnchorPosition","updateResults","onActivity","selectItem","highlightMatches");a=[];h.getPullRequest()?a=e.map([h.getPullRequest().getAuthor()].concat(h.getPullRequest().getReviewers().models,h.getPullRequest().getParticipants().models),function(a){return a.getUser()}):
h.getCommitParticipants&&h.getCommitParticipants()&&(a=h.getCommitParticipants().pluck("user"));this.dataSource=x(a,this.matcher);this.dataSource.on("respond",this.updateResults);this.dataSource.on("activity",this.onActivity);this.isMentioningSelector=e.map(this.options.selector.split(","),function(a){return g.trim(a)+".isMentioning"}).join(", ");this.options.$container.on("keypress",this.options.selector,this.onKeyPress);this.options.$container.on("keydown",this.isMentioningSelector,this.onKeyDown);
this.options.$container.on("paste",this.isMentioningSelector,this.onPaste)};d.prototype.onKeyDown=function(a){if(this.dialog)switch(a.which){case f.keyCode.ENTER:case f.keyCode.TAB:this.selectHighlightedItem();a.preventDefault();break;case f.keyCode.UP:this.dialog.moveSelectionUp();a.preventDefault();break;case f.keyCode.DOWN:this.dialog.moveSelectionDown();a.preventDefault();break;case f.keyCode.ESCAPE:this.endAutocomplete();a.preventDefault();a.stopPropagation();break;case f.keyCode.BACKSPACE:case f.keyCode.DELETE:this.onKeyPress(a)}};
d.prototype.onKeyPress=function(a){a.which&&e.defer(e.bind(function(a){var b=g(a.target);if(b.hasClass("isMentioning"))this.updateAutocomplete();else{var k=b.getSelection().start;"@"!==String.fromCharCode(a.which)||v.isPositionInsideCodeBlock(k,b.val())||this.beginAutocomplete(b)}},this),a)};d.prototype.onPaste=function(){e.defer(e.bind(this.updateAutocomplete,this))};d.prototype.onDocumentClick=function(a){var c=a.target;a=[];this.$textarea&&a.push(this.$textarea);this.dialog&&a.push(this.dialog.$el);
e.any(a,function(a){return a.is(c)||g.contains(a[0],c)})||this.endAutocomplete()};d.prototype.beginAutocomplete=function(a){var c=a.getSelection().start-1;0<c&&/^\w$/.test(a.val().substr(c-1,1))||(this.$textarea=a,this.$textarea.addClass("isMentioning"),this.mentionTriggerPos=c,this.resultsCollection=new p.Collection,this.dialog=new w({id:this.options.dialogId,collection:this.resultsCollection,minZIndex:this.options.$container.zIndex(),anchor:this.getCaretDocumentCoordinates(this.$textarea),template:bitbucket.internal.widget.mentionableTextarea.dialog,
highlighter:this.highlightMatches}),this.dialog.on("itemSelected",this.selectItem),m.on("window.resize.debounced",this.updateDialogAnchorPosition),g(document).on("click focusin mousedown",this.onDocumentClick),this.updateAutocomplete())};d.prototype.updateAutocomplete=function(){if(this.$textarea){this.currentCaretPos=this.$textarea.getSelection().start;var a=this.$textarea.val().substring(this.mentionTriggerPos,this.currentCaretPos);a&&0===a.indexOf("@")&&-1===a.indexOf("\n")?(a=a.substr(1),this.dataSource.query(a)):
this.endAutocomplete()}};d.prototype.updateDialogAnchorPosition=function(){e.defer(e.bind(function(){this.dialog&&this.$textarea&&this.dialog.updateAnchorPosition(this.getCaretDocumentCoordinates(this.$textarea))},this))};d.prototype.updateResults=function(a){this.resultsCollection&&(this.resultsCollection.query=a.query,this.resultsCollection.reset(a.results))};d.prototype.onActivity=function(a){this.dialog&&this.dialog.toggleSpinner(a.activity)};d.prototype.endAutocomplete=function(){this.$textarea&&
(this.$textarea.removeClass("isMentioning"),this.$textarea=null);this.currentCaretPos=this.mentionTriggerPos=void 0;this.dialog&&(this.dialog.off("itemSelected",this.selectItem),this.dialog.remove(),this.dialog=null);this.resultsCollection=null;m.off("window.resize.debounced",this.updateDialogAnchorPosition);g(document).off("click focusin mousedown",this.onDocumentClick)};d.prototype.selectHighlightedItem=function(){this.selectItem(this.dialog.getSelectedItemIndex())};d.prototype.selectItem=function(a){if(a=
this.resultsCollection.at(a)){a=this.escapeUsername(a.getName());var c=this.$textarea.val(),b=c.substring(0,this.mentionTriggerPos+1),c=c.substring(this.currentCaretPos,c.length),k=b.length+a.length+1;" "!==c.charAt(0)&&(c=" "+c);this.$textarea.val(b+a+c);this.$textarea.setSelection(k,k)}this.endAutocomplete()};d.prototype.matcher=function(a,c){if(h.getCurrentUser()&&a.getName()===h.getCurrentUser().getName())return!1;var b=l.cache("(\\b|^|[^\\p{L}\\p{N}])"+l.escape(c),"i"),k=[a.getName(),a.getEmailAddress(),
a.getDisplayName()];return e.any(k,function(a){return!(!a||!b.test(a))})};d.prototype.getMatchParts=function(a,c){var b=l.cache("(^|.*?(\\b|\\())("+l.escape(c)+")(.*)","i"),k={text:a};-1<a.toLowerCase().indexOf(c.toLowerCase())&&a.replace(b,function(a,b,c,d,e){k={prefix:b,match:d,suffix:e}});return k};d.prototype.highlightMatches=function(a,c){var b=this;a.find(".avatar-with-name, .email-address").each(function(){var a=g(this).contents().filter(function(){return this.nodeType===Node.TEXT_NODE}),d=
e.reduce(b.getMatchParts(a.text(),c),function(a,b,c){return a+("match"===c?"\x3cb\x3e"+f.escapeHtml(b)+"\x3c/b\x3e":f.escapeHtml(b))},"");a.replaceWith(d)});return a};d.prototype.getCaretDocumentCoordinates=function(a){var c=a.offset(),b=q(a[0],a[0].selectionStart);a=parseInt(a.css("font-size"),10);b.top+=c.top+a;b.left+=c.left;return b};d.prototype.escapeUsername=function(a){return/^\w*$/.test(a)?a:'"'+a.replace(/"/g,'\\"')+'"'};d.prototype.reset=function(){this.destroy();delete this.options;delete this.dataSource;
delete this.$textarea;delete this.dialog;delete this.resultsCollection;delete this.mentionTriggerPos;delete this.currentCaretPos};d.prototype.destroy=function(){this.dialog&&(this.dialog.off("itemSelected",this.selectItem),this.dialog.remove());this.dataSource.off("respond",this.updateResults);this.dataSource.off("activity",this.onActivity);this.options.$container.off("keypress",this.options.selector,this.onKeyPress);this.options.$container.off("keydown",this.isMentioningSelector,this.onKeyDown);
this.options.$container.off("paste",this.isMentioningSelector,this.onPaste);m.off("window.resize.debounced",this.updateDialogAnchorPosition);g(document).off("click focusin mousedown",this.onDocumentClick)};var x=e.once(function(a,c){var b=new n(a,{queryEndpoint:r.rest().users().build(),queryParamKey:"filter",queryData:{avatarSize:bitbucket.internal.widget.avatarSizeInPx({size:"small"}),permission:"LICENSED_USER"},maxResults:5,model:t,matcher:c});b.query=function(a){var b;this.value=a;b=this.getFilteredResults(a);
this.respond(a,b);!a||!this._queryEndpoint||this.hasQueryCache(a)||!this.shouldGetMoreResults(b)||2>a.length||this.remoteQuery(a)}.bind(b);b.remoteQuery=function(a){var b=this.fetch(a);this.activeQueryCount++;this.trigger("activity",{activity:!0});b.always(e.bind(function(){this.activeQueryCount--;this.trigger("activity",{activity:!!this.activeQueryCount})},this));b.done(e.bind(function(b,c,d){this.addQueryCache(a,b,d)},this));b.done(e.bind(function(){a=this.value;this.respond(a,this.getFilteredResults(a))},
this))}.bind(b);b.remoteQuery=e.debounce(b.remoteQuery,300);b.parse=u.dot("values");b.getFilteredResults=function(a){var b=this.filter(function(b){return!!this.matcher(b,a)},this);this._maxResults&&(b=e.take(b,this._maxResults));return b};return b});return d});