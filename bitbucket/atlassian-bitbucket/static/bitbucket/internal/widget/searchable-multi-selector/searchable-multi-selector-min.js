define("bitbucket/internal/widget/searchable-multi-selector","aui jquery lodash bitbucket/internal/util/ajax bitbucket/internal/util/events bitbucket/internal/util/function bitbucket/internal/util/promise".split(" "),function(f,h,c,m,n,p,q){function l(a,b){this._$field=a;var d=b=this._options=h.extend(!0,{},this.defaults,b);if(!d.dataSource)if(d.url)d.dataSource=new g(d.url,d.urlParams);else throw Error("either a dataSource or url must be supplied");d.dataSource=new r(d.dataSource,d.debounceInterval);
if(!c.isFunction(b.selectionTemplate))throw Error("a selectionTemplate must be a function");if(!c.isFunction(b.resultTemplate))throw Error("a resultTemplate must be a function");this._selectedItems=[];this._initialItems=[];this._excludedIds=c.map(b.excludedItems,b.generateId);t(this);this.setSelectedItems(b.initialItems.slice(0))}function g(a,b){this._url=a;this._urlParams=b;this.clear();this._pageReceived=c.bind(this._pageReceived,this)}function r(a,b){this.clear=c.bind(a.clear,a);this.nextPage=
q.delay(c.bind(a.nextPage,a),b)}function u(a){var b=h(".select2-drop-active \x3e .select2-results");b.length&&0===b.children(".select2-result-selectable").length&&b.children(".select2-disabled").length&&h('\x3cli class\x3d"select2-no-results"\x3e\x3c/li\x3e').html(a._options.noMatchesTemplate()).appendTo(b)}function v(a,b){return{id:a.generateId(b),text:a.generateText(b),item:b}}function w(a,b){return c.reject(a,function(a){return a.id===b.id})}function x(a){a&&a.abort&&a.abort()}function t(a){var b=
a._options,d=a._$field,f=a._excludedIds,g=c.bind(v,null,b),k=[];d.auiSelect2({hasAvatar:b.hasAvatar,query:function(a){1>=a.page&&(b.dataSource.clear(),c.forEach(k,x),k=[]);var d=b.prepareSearchTerm(h.trim(a.term)),e=b.dataSource.nextPage(d),e=e.then(function(a){return{results:c.chain(a.values).map(g).filter(function(a){return-1===c.indexOf(f,a.id)}).value(),more:!a.isLastPage}}).promise(e);k.push(e);e.always(function(){k=c.reject(k,p.eq(e))}).done(a.callback)},formatSelection:function(a){return b.selectionTemplate(a.item)},
formatResult:function(a){return b.resultTemplate(a.item)},initSelection:function(b,d){var e=c.map(a._initialItems,g);a._selectedItems=e;d(e)},separator:"|!|",multiple:!0,minimumInputLength:b.minimumInputLength,formatInputTooShort:b.inputTooShortTemplate,formatNoMatches:b.noMatchesTemplate,formatSearching:b.searchingTemplate,containerCssClass:["searchable-multi-selector",b.extraClasses].join(" "),dropdownCssClass:["searchable-multi-selector-dropdown",b.dropdownClasses].join(" "),openOnEnter:!1}).on("change",
function(b){b.removed&&(a._selectedItems=w(a._selectedItems,b.removed));b.added&&a._selectedItems.push(b.added);a.trigger("change")}).on("open",c.bind(u,null,this))}h.extend(!0,l.prototype,n.createEventMixin("bitbucket.internal.widget.searchable.multi.selector"),{defaults:{minimumInputLength:2,extraClasses:null,dropdownClasses:null,debounceInterval:300,initialItems:[],excludedItems:[],urlParams:{},hasAvatar:!1,inputTooShortTemplate:function(){return f.escapeHtml(f.I18n.getText("bitbucket.web.multi.selector.help"))},
noMatchesTemplate:function(){return f.escapeHtml(f.I18n.getText("bitbucket.web.multi.selector.no.match"))},searchingTemplate:function(){return f.escapeHtml(f.I18n.getText("bitbucket.web.multi.selector.searching"))},generateId:function(a){return a.id||a.name},generateText:function(a){return a.displayName||a.name},prepareSearchTerm:c.identity},getSelectedItems:function(){return c.pluck(this._selectedItems,"item")},setSelectedItems:function(a){this._initialItems=a.slice(0);this._$field.auiSelect2("val",
c.map(a,this._options.generateId))},clearSelectedItems:function(){this.setSelectedItems([])}});g.prototype.clear=function(){this._nextPageStart=0};g.prototype.nextPage=function(a){return m.rest({url:this._url,data:h.extend({},this._urlParams,{start:this._nextPageStart,filter:a})}).done(this._pageReceived)};g.prototype._pageReceived=function(a){this._nextPageStart=a.nextPageStart||a.start+a.size};l.PagedDataSource=g;return l});