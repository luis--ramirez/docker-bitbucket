define("bitbucket/internal/widget/user-avatar-form","aui jquery lodash bitbucket/util/navbuilder bitbucket/internal/util/ajax bitbucket/internal/util/events bitbucket/internal/widget/avatar-picker-dialog bitbucket/internal/widget/confirm-dialog".split(" "),function(e,d,h,g,p,k,l,q){function c(a,b,f){h.bindAll(this,"restorePreview","save","_onSuccess");this.user=b;this.$container=d(a);this.$delete=this.$container.find(".avatar-delete-trigger");this.$image=this.$container.find(".user-avatar img");this.$picker=
this.$container.find(".avatar-picker-trigger");this.xsrfToken=f;this._initDialogs();this._toggleAvatarSource()}function m(a,b,f){return a.href||201===f.status&&f.getResponseHeader("Location")}function r(a,b){a=g.parse(a);h.forEach(b,function(b,c){b&&a.replaceQueryParam(c,b)});return a}var n={statusCode:{400:!1,401:function(a,b,c,e,d){return d.shouldLogin},404:!1,500:!1}};k.addLocalEventMixin(c.prototype);c.prototype.refreshAll=function(a){var b=this;d(".aui-avatar").filter(function(){return d(this).attr("data-username")===
b.user.name}).find(".aui-avatar-inner \x3e img").each(function(){var b;b=d(this).attr("src");b=g.parse(b).getQueryParamValue("s");d(this).attr("src",r(a,{s:b,t:(new Date).getTime()}))})};c.prototype.restorePreview=function(){this.updatePreview(this.oldImage)};c.prototype.save=function(a){this.updatePreview(a);this.upload(a)};c.prototype.updatePreview=function(a){this.oldImage=this.$image.attr("src");this.$image.attr("src",a)};c.prototype.upload=function(a){var b=this.$image.parent();b.spin("large",
{color:"#fff"});this.$picker.prop("disabled",!0);p.ajax(d.extend({url:this._getUploadUrl(),data:{avatar:a},type:"POST"},n)).then(m).done(this._onSuccess).fail(this.trigger.bind(this,"avatarUploadError",e.I18n.getText("bitbucket.web.user.avatar.upload.error"))).fail(this.restorePreview).always(b.spinStop.bind(b)).always(this.$picker.prop.bind(this.$picker,"disabled",!1))};c.prototype._initDialogs=function(){this.pickerDialog=new l({dialogTitle:e.I18n.getText("bitbucket.web.user.avatar.upload.title"),
dialogDoneButtonText:e.I18n.getText("bitbucket.web.button.save"),maskShape:l.maskShapes.ROUNDED_SQUARE,trigger:this.$picker,onCrop:this.save,xsrfToken:this.xsrfToken,enableWebcam:!0});this.deleteDialog=new q({id:"delete-avatar-dialog",titleClass:"warning-header",titleText:e.I18n.getText("bitbucket.web.user.avatar.delete.title"),panelContent:bitbucket.internal.widget.paragraph({text:e.I18n.getText("bitbucket.web.user.avatar.delete.confirm")}),submitText:e.I18n.getText("bitbucket.web.button.remove")},
d.extend({type:"DELETE"},n));var a=this;this.deleteDialog.addConfirmListener(function(b){b.then(m).done(a._onSuccess).fail(a.trigger.bind(a,"avatarDeleteError",e.I18n.getText("bitbucket.web.user.avatar.delete.error")))});this.deleteDialog.attachTo(null,null,this.$delete)};c.prototype._getUploadUrl=function(){var a=g.user(this.user.slug).avatar();if(this.xsrfToken){var b={};b[this.xsrfToken.name]=this.xsrfToken.value;return a.withParams(b).build()}return a.build()};c.prototype._onSuccess=function(a){this.refreshAll(a);
this._toggleAvatarSource();this.trigger("avatarChanged",this.user);k.trigger("bitbucket.internal.widget.userAvatarForm.avatarChanged",null,this.user)};c.prototype._toggleAvatarSource=function(){var a=/^https?:\/\/(www|secure)\.gravatar.com\/.+/g.test(this.$image.attr("src"));this.$container.toggleClass("gravatar-source",a)};return c});