define("bitbucket/internal/widget/client-file-handlers/client-file-handler",["jquery","lodash","bitbucket/internal/util/events"],function(e,d,f){function b(a){return this.init(a)}f.addLocalEventMixin(b.prototype);b.typeFilters={all:/.*/,application:/^application\/.*/i,audio:/^audio\/.*/i,image:/^image\/.*/i,imageWeb:/^image\/(jpeg|png|gif)$/i,text:/^text\/.*/i,video:/^video\/.*/i};b.prototype.defaults={fileTypeFilter:b.typeFilters.all,fileCountLimit:Infinity,fileSizeLimit:10485760,onSuccess:e.noop,
onError:e.noop};b.prototype.init=function(a){this.options=e.extend({},this.defaults,a);a&&!a.fileSizeLimit&&(this.options.fileSizeLimit=this.defaults.fileSizeLimit);a&&!a.fileCountLimit&&(this.options.fileCountLimit=this.defaults.fileCountLimit);d.bindAll(this,"handleFiles","filterFiles");return this};b.prototype.handleFiles=function(a){this.trigger("filesSelected",a);a=this.filterFiles(a);0<a.valid.length?(d.isFunction(this.options.onSuccess)&&this.options.onSuccess(a.valid),this.trigger("validFiles",
a.valid)):d.isFunction(this.options.onError)&&this.options.onError(a.invalid);d.keys(a.invalid).length&&this.trigger("invalidFiles",a.invalid)};b.prototype.filterFiles=function(a){var b=d.isRegExp(this.options.fileTypeFilter)?this.options.fileTypeFilter:this.defaults.fileTypeFilter,e=this.options.fileSizeLimit;a=d.reduce(a,function(a,c){b.test(c.type)?c.size>e?a.invalid.bySize=a.invalid.bySize?a.invalid.bySize.concat(c):[c]:a.valid.push(c):a.invalid.byType=a.invalid.byType?a.invalid.byType.concat(c):
[c];return a},{valid:[],invalid:{}});a.valid.length>this.options.fileCountLimit&&(a.invalid.byCount=a.valid.slice(this.options.fileCountLimit),a.valid=a.valid.slice(0,this.options.fileCountLimit));return a};return b});