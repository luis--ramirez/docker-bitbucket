define("bitbucket/internal/widget/client-file-handlers/client-file-uploader",["jquery","lodash","bitbucket/internal/util/ajax","bitbucket/internal/util/feature-detect","bitbucket/internal/widget/client-file-handlers/client-file-handler"],function(f,d,h,k,c){function a(d){if(!a.isSupported())throw Error("ClientFileUploader requires FormData support");this.init.apply(this,arguments)}a.isSupported=k.formData;a.typeFilters=c.typeFilters;f.extend(a.prototype,c.prototype);a.prototype.defaults=f.extend({},
c.prototype.defaults,{url:void 0,fieldName:"file",fileSizeLimit:void 0});a.prototype.init=function(a){d.bindAll(this,"uploadFiles");c.prototype.init.call(this,a);this.uploads=[];this.on("validFiles",this.uploadFiles)};a.prototype.uploadFiles=function(a){var b=this;d.forEach(a,function(a){var c=new FormData,e=f.Deferred();c.append(b.options.fieldName,a,a.name);var g=h.ajax({url:d.isFunction(b.options.url)?b.options.url():b.options.url,type:"POST",data:c,xhr:function(){var a=f.ajaxSettings.xhr();(a.upload?
a.upload:a).addEventListener("progress",function(a){a.lengthComputable&&e.notify(Math.max(0,Math.min(100,100*a.loaded/a.total)))});return a},statusCode:{500:!1},processData:!1,contentType:!1}).done(function(){e.notify(100);e.resolveWith(this,arguments)}).fail(function(){e.rejectWith(this,arguments)}).always(function(){b.uploads=d.without(b.uploads,g)});e.promise(g);b.uploads.push(g);b.trigger("uploadStarted",g,a)})};a.prototype.destroy=function(){d.invoke(this.uploads,"abort");this.uploads=[]};return a});