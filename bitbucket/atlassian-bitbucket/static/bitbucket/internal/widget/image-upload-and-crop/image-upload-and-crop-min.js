define("bitbucket/internal/widget/image-upload-and-crop","aui jquery lodash bitbucket/internal/util/text bitbucket/internal/widget/canvas-cropper bitbucket/internal/widget/client-file-handlers/client-file-reader bitbucket/internal/widget/drag-drop-file-target bitbucket/internal/widget/faux-upload-field bitbucket/internal/widget/image-explorer bitbucket/internal/widget/paste-image-target bitbucket/internal/widget/webcam-capture".split(" "),function(d,e,f,h,l,g,n,p,k,q,m){function b(a,r){if(!b.isSupported())throw Error("This browser doesn't support ImageUploadAndCrop.");
this.init.apply(this,arguments)}b.isSupported=function(){return l.isSupported()};b.maskShapes=k.maskShapes;b.prototype.defaults={HiDPIMultiplier:2,dragDropUploadPrompt:d.I18n.getText("bitbucket.web.drag.drop.image.prompt"),onImageUpload:e.noop,onImageUploadError:e.noop,onImageClear:e.noop,onCrop:e.noop,outputFormat:"image/png",fallbackUploadOptions:{},initialScaleMode:k.scaleModes.containAndFill,scaleMax:1,fileSizeLimit:5242880,maxImageDimension:2E3,pasteUpload:!0};b.prototype.init=function(a,b){this.options=
e.extend({},this.defaults,b);this.$container=a;f.bindAll(this,"crop","resetState","_onFileProcessed","setImageSrc","validateImageResolution","_onFilesError","_onFileError","_resetFileUploadField","_onErrorReset");this.imageExplorer=new k(this.$container.find(".image-explorer-container"),{initialScaleMode:this.options.initialScaleMode,scaleMax:this.options.scaleMax,onErrorReset:this._onErrorReset});g.isSupported()&&(this.clientFileReader=new g({onRead:this._onFileProcessed,onError:this._onFilesError,
fileTypeFilter:g.typeFilters.imageWeb,fileCountLimit:1,fileSizeLimit:this.options.fileSizeLimit}),this.dragDropFileTarget=new n(this.imageExplorer.get$ImageView(),{uploadPrompt:this.options.dragDropUploadPrompt,clientFileHandler:this.clientFileReader}),this.options.pasteUpload&&(this.pasteImageTarget=new q(this.imageExplorer.get$ImageView(),this.clientFileReader)));this.fauxUploadField=new p(this.$container.find(".image-select-button"),{clientFileHandler:this.clientFileReader,accept:g.typeFilters.imageWeb});
var c=this.imageExplorer.get$Mask();this.canvasCroppper=new l(c.width()*this.options.HiDPIMultiplier,c.height()*this.options.HiDPIMultiplier,{outputFormat:this.options.outputFormat});this.options.cropButton&&e(this.options.cropButton).click(this.crop);this.$container.find(".webcam-capture").length&&(m.isSupported()?this.webcamCapture=this.initWebcamUpload():this.$container.find(".use-webcam").prop("disabled",!0).attr("title",d.I18n.getText("bitbucket.web.webcam.browser.unsupported")))};b.prototype.initWebcamUpload=
function(){var a=this,b=this.$container.find(".use-webcam"),c=new m(this.$container.find(".webcam-capture"),{countdown:!0,mirror:!0,width:640,onCapture:function(b){c.pause();a.setImageSrc(b);a.$container.removeClass("webcam-mode");a.$container.find(".retake-photo").removeClass("hidden").focus()}});b.on("click",function(){a.$container.addClass("webcam-mode");a.setImageSrc("");c.start()});return c};b.prototype._resetWebcamUpload=function(){this.webcamCapture&&(this.webcamCapture.stop(),this.$container.removeClass("webcam-mode"),
this.$container.find(".retake-photo").addClass("hidden"))};b.prototype.crop=function(){var a=this.imageExplorer.getMaskedImageProperties(),a=this.canvasCroppper.cropToDataURI(this.imageExplorer.get$SourceImage()[0],a.maskedAreaImageX,a.maskedAreaImageY,a.maskedAreaWidth,a.maskedAreaHeight);f.isFunction(this.options.onCrop)&&this.options.onCrop(a)};b.prototype.resetState=function(){this.imageExplorer.clearError();this._resetFileUploadField();this._resetWebcamUpload();this.setImageSrc("")};b.prototype._onFileProcessed=
function(a){a?isNaN(this.options.maxImageDimension)?this.setImageSrc(a):this.validateImageResolution(a).done(f.bind(function(b,c){this.setImageSrc(a)},this)).fail(f.bind(function(a,b){this._onFileError(d.I18n.getText("bitbucket.web.avatar.error.file.resolution",a,b,this.options.maxImageDimension))},this)):this._onFileError()};b.prototype.setImageSrc=function(a){this.$container.find(".input-buttons").toggleClass("hidden",!!a);this.imageExplorer.setImageSrc(a);if(a)this.options.onImageUpload(a);else this.options.onImageClear();
this._resetFileUploadField()};b.prototype.validateImageResolution=function(a){var b=e.Deferred(),c=new Image,d=this;c.onload=function(){this.naturalWidth>d.options.maxImageDimension||this.naturalHeight>d.options.maxImageDimension?b.reject(this.naturalWidth,this.naturalHeight):b.resolve(this.naturalWidth,this.naturalHeight)};c.src=a;return b};b.prototype._onFilesError=function(a){a&&a.bySize&&a.bySize.length?(a=f.first(a.bySize),this._onFileError(d.escapeHtml(d.I18n.getText("bitbucket.web.avatar.error.filetoobig",
h.abbreviateText(a.name,50),h.formatSizeInBytes(a.size),h.formatSizeInBytes(this.options.fileSizeLimit))))):this._onFileError()};b.prototype._onFileError=function(a){var b=d.I18n.getText("bitbucket.web.avatar.error.adding.file.title"),c=a||d.I18n.getText("bitbucket.web.avatar.error.adding.file.contents");this.imageExplorer.showError(b,c);this._resetFileUploadField();f.isFunction(this.options.onImageUploadError)&&this.options.onImageUploadError(a)};b.prototype._resetFileUploadField=function(){var a=
this.$container.find("#image-upload-and-crop-upload-field").prop("form");a&&a.reset()};b.prototype._onErrorReset=function(a){a&&f.isFunction(this.options.onImageUpload)&&this.options.onImageUpload(a)};return b});