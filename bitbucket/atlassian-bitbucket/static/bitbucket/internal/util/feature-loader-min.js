define("bitbucket/internal/util/feature-loader",["aui","jquery","lodash","require","bitbucket/internal/util/events"],function(B,c,b,C,f){function u(b,c){if("function"!==typeof b.load||"function"!==typeof b.unload)throw Error("Modules require both a load and unload callback. Please use:\n"+v(c));}function v(b){return"FeatureLoader.registerHandler('"+b+"', /urlMatcher/, {\n    load : loadFn,\n    unload : unloadFn,\n    keyboardShortcutContexts : [ 'commit', ... ]});"}function k(h){function D(a){function g(){f.trigger(h.unloadedEvent,
null,a)}if(!b.contains(e,a))return c.Deferred().resolve();var d=a.module.unload(l);e=b.without(e,a);if(d&&d.then)return d.then(g);g();return c.Deferred().resolve()}function w(a){function g(){f.trigger(h.loadedEvent,null,a)}if(b.contains(e,a))return c.Deferred().resolve();a.module||(a.module=C(a.moduleName),u(a.module,a.name));var d=a.module.load(l);e.push(a);if(d&&d.then)return d.then(g);g();return c.Deferred().resolve()}function x(){if(!m||q!==window.location.href){q=window.location.href;var a=r(q);
a.length?(b.each(a,function(a){f.trigger(h.requestedEvent,null,a.name)}),n||(n=!0,y.then(E))):m?window.location.reload():f.trigger(h.errorEvent,null,{message:B.I18n.getText("bitbucket.web.featureloader.nohandler"),code:k.NO_HANDLER})}}function E(){n=!1;var a=r(window.location.href),g=b.difference(a,e),a=b.difference(e,a);if(g.length||a.length)e.length?a=c.when.apply(c,b.map(a,D)):(c(l).empty(),a=c.Deferred().resolve()),y=a.then(function(){return c.when.apply(c,b.map(g,w))}).then(function(){t&&t.resetContexts()})}
function r(a){return b.filter(p,function(b){return b.urlRegex&&b.urlRegex.test(a)})}function z(){x()}function F(a){return a.module&&a.module.keyboardShortcutContexts||[]}function A(a){var c=b.chain(e).map(F).flatten().uniq().value();b.each(c,function(b){a.enableContext(b)})}if(!(this instanceof k))return new k(h);h=c.extend({},k.defaults,h);var q=window.location.href,e=[],p={},y=c.Deferred().resolve(),n,m=!1,l,t;this.registerHandler=function(a,c,d){if(b.has(p,a))throw Error("A handler with the name '"+
a+"' already exists.");if(!d)throw Error("No module or module name was provided. Please use:\n"+v(a));"string"===typeof d?a=p[a]={name:a,urlRegex:c,moduleName:d}:(u(d,a),a=p[a]={name:a,urlRegex:c,module:d});m&&!n&&b.contains(r(window.location.href),a)&&w(a);return this};this.setElement=function(a){l=a};this.setKeyboardShortcuts=function(a){t=a};this.current=function(){return e.slice()};this.init=function(a){l=a;x();f.on("bitbucket.internal.history.changestate",z);f.on("bitbucket.internal.widget.keyboard-shortcuts.register-contexts",
A);m=!0};this.destroy=function(){f.off("bitbucket.internal.history.changestate",z);f.off("bitbucket.internal.widget.keyboard-shortcuts.register-contexts",A)};return this}k.defaults={unloadedEvent:"stash.util.feature-loader.unloaded",loadedEvent:"stash.util.feature-loader.loaded",requestedEvent:"stash.util.feature-loader.loadRequested",errorEvent:"stash.util.feature-loader.errorOccurred"};k.NO_HANDLER="NO_HANDLER";return k});