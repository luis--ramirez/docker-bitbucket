define("bitbucket/internal/util/page-providers",["jquery","lodash","bitbucket/internal/util/ajax","exports"],function(h,l,t,k){function u(a,b){return l.map(b,function(c,b){return{value:c,index:a+b}})}function n(a,b){this.provider=a;this.filter=b}function p(a){this.values=a}function q(a){this.restBuilder=a}function r(a,b){this.provider=a;this.offset=b}function m(a){this.providers=a;this.nextPageStart=this.offset=0}n.prototype.fetch=function(a,b){var c=this;return this.provider.fetch(a,2*b).then(function(d){var e=
u(a,d.values),g=l.filter(e,function(a){return c.filter(a.value)}),e=g.slice(0,b),g=g.slice(b,b+1),e={values:l.pluck(e,"value"),size:e.length,start:a,limit:b,isLastPage:0===g.length&&d.isLastPage};e.isLastPage||(e.nextPageStart=g.length?g[0].index:d.nextPageStart);return e})};p.prototype.fetch=function(a,b){var c=this.values;if(a>=c.length)return h.Deferred().resolve({start:a,values:[],size:0,limit:b,isLastPage:!0});var d=a+b;if(d<=c.length){var e=c.slice(a,d),c=d===c.length;return h.Deferred().resolve({start:a,
values:e,size:b,limit:b,isLastPage:c,nextPageStart:c?void 0:d})}d=c.slice(a,d);return h.Deferred().resolve({start:a,values:d,size:d.length,limit:b,isLastPage:!0})};q.prototype.fetch=function(a,b){var c=this.restBuilder.withParams({start:a,limit:b}).build();return t.rest({url:c,type:"GET"})};r.prototype.fetch=function(a,b){var c=this.offset;return this.provider.fetch(a+c,b).then(function(b){b.start=a;b.isLastPage||(b.nextPageStart-=c);return b})};m.prototype.fetch=function(a,b){var c=this,d=c.providers;
if(c.nextPageStart!==a)throw Error("Page requests must be contiguous (expected start: "+c.nextPageStart+", actual start: "+a+")");if(!d.length)return h.Deferred().resolve(c._mark({start:a,limit:b,size:0,values:[],isLastPage:!0}));var e=c.offset,g=1<d.length;return d[0].fetch(a-e,b).then(function(f){f=h.extend(f,{start:a,limit:b});f.isLastPage?g&&(f=h.extend(f,{isLastPage:!1,nextPageStart:e+a+f.size}),d.shift(),c.offset=a+f.size):f.nextPageStart+=e;return c._mark(f)})};m.prototype._mark=function(a){this.nextPageStart=
a.isLastPage?a.start+a.size:a.nextPageStart;return a};k.AjaxPageProvider=q;k.CompositePageProvider=m;k.FilteredPageProvider=n;k.OffsetPageProvider=r;k.PreloadedPageProvider=p;k.filterPage=function(a,b){var c=l.filter(a.values,b);return h.extend(a,{values:c,size:c.length})}});