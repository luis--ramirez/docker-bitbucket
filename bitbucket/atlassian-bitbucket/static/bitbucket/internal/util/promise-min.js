define("bitbucket/internal/util/promise",["jquery","lodash","exports"],function(e,f,c){function l(a){a&&a.abort&&a.abort()}function u(){console.log("Promise does not have an abort function")}function k(a,b,d){function m(a,d){return function(){return g?(new e.Deferred)[a+"With"](this,arguments):h=d.apply(this,arguments)}}var g,h=a,f=e.Callbacks(),c={};a=a.then(b?m("resolve",b):null,d?m("reject",d):null);c.abort=function(){"pending"===c.state()&&(g||l(h),g=!0);f.fire()};c.thenAbortable=function(a,d){var b=
k(c,a,d);f.add(b.abort);return b};return a.promise(c)}function p(){return e.when.apply(e,f.map(arguments,v)).then(q,q)}function v(a){return a.then(r(!1),r(!0))}function r(a){return function(){return e.Deferred().resolve({rejectedSelf:a&&this,self:this,args:Array.prototype.slice.call(arguments)})}}function q(){var a=f.chain(arguments).pluck("rejectedSelf").find(f.identity).value(),b=(a?"reject":"resolve")+"With",a=a||arguments[0].self,d=f.pluck(arguments,"args");return e.Deferred()[b](a,d)}var t={PENDING:"pending",
REJECTED:"rejected",RESOLVED:"resolved"};c.state=t;c.delay=function(a,b){return function(){var d=e.Deferred(),c=this,g=Array.prototype.slice.call(arguments),h,n=function(){return setTimeout(function(){var b=a.apply(c,g);b.done(d.resolve).fail(d.reject);h=b.abort?f.bind(b.abort,b):u},b)},k=n();h=function(){clearTimeout(k);d.reject(d,"abort","abort")};return d.promise({abort:function(){h()},reset:function(){"pending"===d.state()&&(clearTimeout(k),g=Array.prototype.slice.call(arguments),k=n())}})}};
c.reduce=function(){var a=Array.prototype.slice.call(arguments),b=e.when.apply(e,a);b.abort=function(){f.forEach(a,l)};return b};c.settle=p;c.spinner=function(a,b,d,c,g){var f=e(a).spin(d||"small",c||{});return b.always(function(){g?f.spinStop():f.remove()})};c.rollingSpinner=function(a,b,d){function c(){var a=Array.prototype.slice.call(arguments);a.length&&(h.spin(d).addClass("spinning"),g=p.apply(null,f.compact(a.concat(g))),g.always(function(){g.state()!==t.PENDING&&h.spinStop().removeClass("spinning")}))}
d=d||"small";var g,h=e(a);b&&c(b);return{add:c}};c.thenAbortable=k;c.whenAbortable=function(){var a=e.when.apply(e,arguments);a.abort=f.invoke.bind(f,arguments,"abort");return k(a)};c.waitFor=function(a){var b=e.Deferred();a=e.extend({timeout:1E4,interval:100,name:"",predicate:e.noop},a);var d=(new Date).getTime()+a.timeout,c=setInterval(function(){var e=a.predicate();e?(clearInterval(c),b.resolve(e)):(new Date).getTime()>d&&(clearInterval(c),b.reject("Predicate '"+a.name+"' was false after "+a.timeout+
"ms"))},a.interval);return b.promise()}});