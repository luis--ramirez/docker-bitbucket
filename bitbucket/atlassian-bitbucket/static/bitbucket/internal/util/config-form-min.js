define("bitbucket/internal/util/config-form",["aui","jquery","lodash","bitbucket/internal/util/ajax"],function(l,e,g,p){function h(b,a){return g.isFunction(b)?b(g.extend({},a)):b}function q(b,a){var c={};a=g.extend({},a,b.params);b["context-provider"]&&(a=h(b["context-provider"],a));var d;try{g.each(b,function(d,k){if(!/params|context-provider|view/.test(k))c[k]=h(b[k],a);else if("view"===k){var f=d(a);if(f){var e={};"object"===("undefined"===typeof f?"undefined":babelHelpers.typeof(f))&&(e=g.extend(e,
f));f.loadTransformer&&(a.config=h(f.loadTransformer,a.config));f=g.isFunction(f.formContents)?f.formContents:f;e.formContents=h(f,a);c.view=e}}})}catch(e){d=e}c.view||(c.view={formContents:aui.message.error({content:l.escapeHtml(l.I18n.getText("bitbucket.web.config.form.load.error",c.pluginKey+":"+c.key,d?d:"Unknown error"))})});c.moduleKey=c.key;c.completeModuleKey=c.pluginKey+":"+c.key;return m[c.completeModuleKey]=c}function n(b){return(b=WebFragments.getWebFragmentDescriptors(b,"panel"))&&b.length?
b[0]:null}function d(b,a){this.$container=e(b);this.configContextName=a}var m={};d.prototype.loadAndRender=function(b){return e.when(b(),this._loadWebResources().fail(g.bind(function(a){this.$container.html(aui.message.error({content:a.message}))},this))).done(g.bind(function(a){this._render(a[0])},this))};d.prototype._loadWebResources=function(){return WRM.require("wrc!"+this.configContextName)};d.prototype._render=function(b,a,c){a={config:b||{},errors:a};var d=n(this.configContextName);a=q(d,a);
this.$container.empty();a&&a.view&&a.view.formContents&&(this.$container.append(bitbucket.internal.widget.form({content:a.view.formContents,action:"",errors:c})),this.$container.find(":input:visible:enabled:first").first().focus());a&&a.view&&a.view.initForm&&a.view.initForm(b)};d.prototype.save=function(b){var a=p.formToJSON(this.$container.find("form.aui")),c=n(this.configContextName);(c=m[c.pluginKey+":"+c.key])&&c.view&&c.view.saveTransformer&&(a=c.view.saveTransformer(a));return e.when(b(a)).fail(g.bind(this._validationErrors,
this,a))};d.prototype._validationErrors=function(b,a,c,d,e){a=g.reduce(e.errors,function(a,b){a[b.context]=(a[b.context]||[]).concat([b.message]);return a},{});this._render(b,a,a.null)};return d});var ConfigForm=require("bitbucket/internal/util/config-form");