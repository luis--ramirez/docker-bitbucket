define("bitbucket/internal/util/region-scroll-forwarder",["bacon","jquery","lodash","bitbucket/internal/util/bacon","bitbucket/internal/util/function"],function(n,u,d,p,q){return function(r,c){function t(a,b){d.chain(a).filter(function(b,a,c){return!d.some(c.slice(0,a),function(a){return b.groupId&&b.groupId===a.groupId})}).forEach(function(a){a.setScrollTop("bottom"===b(a)?a.getCachedHeight():0)}).value()}var g=new n.Bus;c=c.map(function(a){var b=null;return u.extend({},a,{getCachedHeight:function(){null==
b&&(b=a.getHeight());return b},invalidateCache:function(){b=null}})});var e;r.subscribe(function(a){if(a.isInitial()){var b=a.value().top,k=0,e;d.forEach(c,function(a){var c=a.getCachedHeight(),d=k+c>=b;!e&&d?(e=a,a.setScrollTop(b-k)):a.setScrollTop(d?0:c);k+=c})}})();var m=r.takeUntil(g).slidingWindow(2,2).map(q.spread(function(a,b){var e=0,l,g=b.top-a.top,f,h=0;d.some(c,function(c){var d=c.getCachedHeight();!f&&h+d>=b.top&&(f=c,e=h);!l&&h+d>=a.top&&(l=c);h+=d;return f&&l});if(!f)throw Error("No forwardee handles "+
b.top);return{scrollInfo:b,localTop:b.top-e,diff:g,forwardTo:f,previousRegion:l}})),v=m.onValue(function(a){e=a;var b=a.previousRegion;if(b!==a.forwardTo){var b=p.toArray(p.takeBetween(n.fromArray(c),{start:b,end:a.forwardTo,startInclusive:!0,endInclusive:!1})),d=0<a.diff;t(d?b.reverse():b,q.constant(d?"bottom":"top"))}a.forwardTo.setScrollTop(a.localTop)});return{regionChanges:m.map(".forwardTo").skipDuplicates(),forwardingInfo:m,heightsChanged:function(){d.invoke(c,"invalidateCache");if(e){var a=
d.indexOf(c,e.forwardTo);t(d.reject(c,function(a){return a===e.forwardTo||a.groupId&&a.groupId===e.forwardTo.groupId}),function(b){return d.indexOf(c,b)<a?"bottom":"top"});e.forwardTo.setScrollTop(Math.min(e.localTop,e.forwardTo.getCachedHeight()))}},destroy:function(){v();g.push(!0);g.end()}}}});