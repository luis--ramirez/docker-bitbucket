define("bitbucket/util/server","aui jquery lodash bitbucket/util/navbuilder bitbucket/internal/model/page-state bitbucket/internal/util/error bitbucket/internal/util/function bitbucket/internal/widget/error-dialog exports".split(" "),function(n,e,v,C,m,z,D,E,w){function F(a,d,b,h){if(new Date<b){var g=function(){var g=Math.ceil((+b-+new Date)/d);0>=g?(clearInterval(e),h()):a.text(g)},e=setInterval(g,d);g()}else h()}function G(a,d,e,h,g){new Date<g&&(a.addClass("hidden"),a.before(d),F(e,h,g,function(){d.remove();
a.removeClass("hidden")}))}function H(a,d,b,h){function g(){x.apply(p,arguments)}function r(c,a,A,d,f,h,l){if(c.shouldLogin)return window.onbeforeunload=null,window.location.href=C.login().next(window.location.href).build(),e.Deferred();a&&delete a.errors;var b;u||(b=new E);var t=c.shouldRetry&&!u?e.Deferred():e.Deferred().rejectWith(this,[d,A,f,a,b]);if(!u){l="";var q=!1,m=bitbucket.internal.widget.errorContent(c);b.addHideListener(function(){u=!1});var k={id:"ajax-error",titleText:c.title,titleClass:c.titleClass||
"error-header",showCloseButton:v.isUndefined(c.canClose)?!0:c.canClose,closeOnOutsideClick:!1};if(c.fallbackUrl)k.okButtonText=n.escapeHtml(c.fallbackTitle),b.addOkListener(function(a){window.location.href=c.fallbackUrl;a.preventDefault()});else if(c.shouldReload)k.okButtonText=n.escapeHtml(n.I18n.getText("bitbucket.web.ajax.reload")),b.addOkListener(function(c){window.location.reload();c.preventDefault()});else if(c.shouldRetry){t.notify("stalled");c.retryAfterDate&&(36E5<+c.retryAfterDate-+new Date?
l=n.I18n.getText("bitbucket.web.retry.later"):q=!0);k.okButtonText=n.escapeHtml(n.I18n.getText("bitbucket.web.ajax.try.again"));var r;b.addOkListener(function(c){t.notify("unstalled");r=y(h);b.remove();p=r;x=p.abort;p.abort=g;r.done(function(){return t.resolveWith(this,arguments)});r.fail(function(){return t.rejectWith(this,arguments)});c.preventDefault()});b.addHideListener(function(){"pending"!==t.state()||r||t.rejectWith(this,[d,A,f,a])})}else k.showCloseButton=!1;k.panelContent="\x3cp\x3e"+m+
l+"\x3c/p\x3e";b.reinit(k).show();u=!0;q&&(6E4<+c.retryAfterDate-+new Date?(q=n.I18n.getText("bitbucket.web.retry.in.x.minutes","\x3ctime\x3e\x3cspan\x3e\x3c/span\x3e","\x3c/time\x3e"),l=6E4):(q=n.I18n.getText("bitbucket.web.retry.in.x.seconds","\x3ctime\x3e\x3cspan\x3e\x3c/span\x3e","\x3c/time\x3e"),l=1E3),q=e("\x3cspan\x3e"+q+"\x3c/span\x3e"),m=q.children("time").children(),G(b.getOkButton(),q,m,l,c.retryAfterDate))}return t}function k(c,a,b,g,f,e){var l=h?z.getDominantRESTError(c,b):z.getDominantAJAXError(b),
k=!0;if(f){if((f=f(l))&&"function"===typeof f.promise)return f.promise(b);f&&v.isObject(f)&&(l=f);k=!1!==f}return k&&l?r(l,c,a,b,g,d,h):e()}function m(c){c=b[c];if(void 0===c||null===c)c=b["*"];return"function"===typeof c?c:D.constant(c)}var p,x;p=a;x=p.abort;p.abort=g;return a.then(function(c,a,b){var g=this,f=m(b.status),f=f?v.bind(f,g,c,a,b):null;return k(c,a,b,null,f,function(){return e.Deferred().resolveWith(g,[c,a,b])})},function(a,b,g){var d=this,f=a.responseText;try{f=JSON.parse(f)}catch(h){}var l=
m(a.status),l=l?v.bind(l,d,a,b,g,f):null;return k(f,b,a,g,l,function(){return e.Deferred().rejectWith(d,[a,b,g,f])})}).promise(a)}function y(a,d){var b;a.statusCode&&(b=a.statusCode,delete a.statusCode);b=b||{};var h=H(e.ajax(a),a,b,d);h.statusCode=function(a){if(a)if("pending"===h.state())e.extend(b,a);else{for(var d in a)if(a.hasOwnProperty(d)){n.log("xhr.statusCode() should not be called after the request has completed. Your handler will have no affect on the resolution of the request.");break}a=
a[h.status];h.then(a,a)}};return h}function B(a){var d={};m.getCurrentUser()&&(d["X-AUSERNAME"]=m.getCurrentUser().getName(),d["X-AUSERID"]=m.getCurrentUser().getId());a=e.extend(!0,{dataType:"json",contentType:"application/json",headers:d,jsonp:!1,type:"GET"},a);"GET"!==a.type.toUpperCase()&&(e.isPlainObject(a.data)||e.isArray(a.data))&&(a.data=JSON.stringify(a.data));return y(a,!0)}e.ajaxSetup({timeout:6E4});var u=!1;w.ajax=function(a){return y(a)};w.rest=B;w.poll=function(a){a=e.extend({pollTimeout:6E4,
interval:500,delay:0,tick:e.noop},a);var d=!1,b=!1,h=e.Deferred(),g=Date.now(),m=function p(){d||b||(b=!0,B(a).done(function(b,c,d){var e=a.tick(b,c,d);e?h.resolveWith(this,[b,c,d]):!1!==a.pollTimeout&&Date.now()-g>a.pollTimeout||"undefined"!==typeof e?h.rejectWith(this,[d,c,null,b]):setTimeout(p,a.interval)}).fail(function(a,b,d,e){h.rejectWith(this,[a,b,d,e])}).always(function(){b=!1}))};setTimeout(m,a.delay);var k=h.promise();k.resume=function(){d&&(d=!1,m())};k.pause=function(){d=!0};return k}});